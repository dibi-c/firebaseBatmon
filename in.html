<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitor BMS 3S</title>
    <script src="tailwind.js"></script>
    <style>
        /* Menggunakan font Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* Kartu dasar dengan shadow yang bagus */
        .dashboard-card {
            /* PERHATIAN: Di Dark Mode, warna ini akan ditimpa menjadi bg-gray-800 */
            background-color: #ffffff; 
            border-radius: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        /* Kelas untuk ikon dan nilai utama */
        .value-text {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
        }

        .status-box {
            border-radius: 0.75rem;
            padding: 1rem;
        }

        /* Grid untuk sel tegangan */
        .cell-grid {
            grid-template-columns: repeat(4, 1fr); 
        }

        /* Styling spesifik untuk kartu kelistrikan (Light Mode) */
        .card-voltage { background-color: #bfdbfe; color: #1e40af; } /* blue-200 / blue-800 */
        .card-current { background-color: #fecaca; color: #b91c1c; } /* red-200 / red-800 */
        .card-power { background-color: #fffbeb; color: #b45309; } /* yellow-100 / amber-700 */
        .card-cap-rem { background-color: #e9d5ff; color: #6b21a8; } /* purple-200 / purple-800 */
        .card-cap-used { background-color: #a7f3d0; color: #065f46; } /* teal-2- / teal-800 */
        .card-delta { background-color: #fce7f3; color: #be185d; } /* pink-100 / pink-700 */
        
        /* Styling minimalis untuk koneksi */
        .minimal-connect-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.5rem;
            font-weight: 500;
        }

        /* Style untuk tombol periode aktif */
        .period-active {
            @apply bg-primary text-white shadow-md;
        }
        .period-button {
            @apply p-2 rounded-lg text-sm font-medium transition duration-150 hover:bg-gray-200;
        }

        /* ======================================= */
        /* START: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */
        body {
            /* 1. Gambar sebagai background */
            background-image: url('bms_background.png'); 
            
            /* 2. Properti untuk full-screen, tidak berulang, dan fixed */
            background-size: cover; 
            background-repeat: no-repeat;
            background-attachment: fixed; 
            background-position: center center;
            
            /* Hapus background-color default yang akan menutupi gambar */
            background-color: transparent !important; 
        }

        /* Overlay semi-transparan yang berada di atas gambar tetapi di bawah konten */
        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Warna overlay di Light Mode (abu-abu gelap semi-transparan) */
            background-color: rgba(0, 0, 0, 0.4); 
            z-index: -10; /* Posisikan di bawah semua konten */
            transition: background-color 0.3s;
        }

        /* Warna overlay di Dark Mode (lebih gelap, untuk kontras maksimal) */
        .dark #background-overlay {
            background-color: rgba(0, 0, 0, 0.7); 
        }

        /* Pastikan elemen dashboard-card menggunakan latar putih/gelap agar tidak tembus pandang */
        .dashboard-card {
            /* Pastikan background-color di set ulang di sini */
            background-color: #ffffff; 
            z-index: 1; /* Pastikan konten di atas overlay */
        }
        
        /* Modifikasi untuk tampilan gelap */
        .dark .dashboard-card {
            background-color: #1f2937 !important; 
        }
        /* ======================================= */
        /* END: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */


        /* --- DARK MODE STYLES OVERRIDES: (Selebihnya kode lama) --- */
        
        /* FIX: Aturan CSS Eksplisit untuk body di Dark Mode (untuk mengatasi masalah spesifisitas) */
        body.dark {
            background-color: transparent !important; 
        }
        
        /* Background utama (body) dan background elemen yang lebih terang (bg-gray-50/100/200) */
        .dark .dashboard-card {
            background-color: #1f2937 !important; /* gray-800 */
            box-shadow: none; 
            border: 1px solid #374151; /* Tambahkan border tipis */
        }
        
        /* Header dan elemen yang menggunakan bg-white di Light Mode */
        .dark .bg-white { background-color: #1f2937 !important; } /* gray-800 */
        
        /* FIX: Background elemen yang lebih terang (di sekitar chart, detail sel default, dan kartu detail tambahan) */
        .dark .bg-gray-50, 
        .dark .bg-gray-100, 
        .dark .bg-gray-200 { 
            background-color: #374151 !important; /* gray-700, warna latar belakang yang lebih gelap dari card */
            color: #d1d5db !important; /* text-gray-300 */
        }
        
        /* FIX: Override untuk background hijau Light Mode (Relay ON) */
        .dark .bg-green-50 {
            background-color: #064e3b !important; /* Emerald-900 */
            color: #a7f3d0 !important; /* Emerald-300 */
        }
        
        /* Invert colors for dark mode cards (using darker background and lighter text) */
        .dark .card-voltage { background-color: #1e3a8a !important; color: #93c5fd !important; } 
        .dark .card-current { background-color: #7f1d1d !important; color: #fca5a5 !important; } 
        .dark .card-power { background-color: #78350f !important; color: #fde68a !important; } 
        .dark .card-cap-rem { background-color: #581c87 !important; color: #d8b4fe !important; } 
        .dark .card-cap-used { background-color: #047857 !important; color: #a7f3d0 !important; } 
        .dark .card-delta { background-color: #9d174d !important; color: #f9a8d4 !important; }

        /* Dark mode untuk tombol periode */
        .dark .period-button:not(.period-active) { 
            background-color: #1f2937 !important; /* Darker than the surrounding container */
            color: #d1d5db !important;
        }
        .dark .period-button:not(.period-active):hover { @apply bg-gray-600 !important; }
        
        /* Dark mode untuk border */
        .dark .border-b,
        .dark .border-gray-300 { 
            border-color: #4b5563 !important; /* gray-600 */
        }

        /* Dark mode untuk teks yang lebih lembut */
        .dark .text-gray-400 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #d1d5db !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        
        /* Status Box Warning/Error di Dark Mode */
        .dark .bg-red-100 { background-color: #450a0a !important; color: #fecaca !important; } /* Red-900/Red-300 */
        .dark .bg-yellow-200 { background-color: #422006 !important; color: #fde68a !important; } /* Amber-900/Amber-300 */
        .dark .bg-green-100 { background-color: #064e3b !important; color: #a7f3d0 !important; } /* Emerald-900/Emerald-300 */
        .dark .border-red-400 { border-color: #b91c1c !important; }
        .dark .border-yellow-400 { border-color: #b45309 !important; }
        .dark .border-green-400 { border-color: #065f46 !important; }



:root {
            --bg-dark: #000000;
            --accent: #facc15; 
            --secondary: #ffffff;
            --clock-size: min(90vw, 75vh);
        }

/* Jam Analog: Perbesar ukuran maksimalnya */
.clock-container {
     width: var(--clock-size);
            height: var(--clock-size);
            border: 6px solid rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            position: relative;
            background: #050505;
            flex-shrink: 0;
}

/* Jam Digital Fleksibel */
#time-digital {
    /* Menggunakan vmin agar mengikuti sisi terkecil layar (tinggi saat landscape) */
    font-size: clamp(6rem, 28vmin, 15rem); 
    line-height: 0.85;
    transition: all 0.3s ease;
}

#time-seconds {
    /* Ukuran detik otomatis menyesuaikan jam utama */
    font-size: clamp(2rem, 8vmin, 5rem);
    line-height: 1;
}

/* Kontainer Cuaca Fleksibel */
/* Kontainer Utama Weather */
.weather-box-updated {
    display: flex;
    align-items: center;
    justify-content: center;
    /* Jarak antar elemen menggunakan vmin agar fleksibel */
    gap: 3vmin; 
    padding: 1vmin 2vmin; 
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3vmin;
    border: 1px solid rgba(255, 255, 255, 0.1);
    width: fit-content;
    /* Mencegah box melebar melebihi layar di portrait */
    max-width: 95vw; 
}

/* Garis pembagi vertikal fleksibel */
.divider-v { 
    width: 1px;
    height: 5vmin; 
    background: rgba(255, 255, 255, 0.2); 
}

/* Ukuran Suhu Utama (--¬∞C) */
.temp-text-flex {
    /* min 1.5rem, ideal 5% dari layar, max 4rem */
    font-size: clamp(2rem, 5vmin, 4rem);
    font-weight: 900;
}

/* Ukuran Teks Detail (Hum, Wind, UV, City) */
.weather-text-sub-flex { 
    /* min 0.7rem, ideal 2% dari layar, max 1.2rem */
    font-size: clamp(1.2rem, 4vmin, 1.2rem);
    line-height: 1.2;
}

/* Label kecil (seperti tulisan 'Hum', 'Wind') */
.label-tiny {
    font-size: clamp(1rem, 1.5vmin, 0.8rem);
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

/* Modifikasi landscape agar tetap besar */
@media (orientation: landscape) {
    .clock-container {
        width: min(70vw, 90vh); /* Diubah dari 50vw agar lebih dominan di mode landscape */
        height: min(70vw, 90vh);
    }
}


.hand {
    position: absolute;
    bottom: 50%;
    left: 50%;
    transform-origin: bottom;
    border-radius: 20px;
    transition: transform 0.5s cubic-bezier(0.4, 2.08, 0.55, 0.44);
}


/* Gaya Angka Jam tetap seperti sebelumnya */
/* Angka Jam */
.number {
            position: absolute;
            width: 100%; height: 100%;
            text-align: center;
            font-weight: 800;
            font-size: calc(var(--clock-size) * 0.08);
            padding: 1%;
            color: var(--secondary);
        }

/* Jarum Merah */
        .dot {
            width: 6%; height: 6%;
            background: var(--accent);
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 30;
            box-shadow: 0 0 15px var(--accent);
        }
        .hour-hand { 
            width: 3.5%; height: 26%; 
            background: var(--accent); 
            //margin-left: -1.75%; 
            z-index: 15;
        }
        .min-hand { 
            width: 2.5%; height: 38%; 
            background: var(--secondary); 
            //margin-left: -1.25%; 
            z-index: 14; 
        }
        .sec-hand { 
            width: 1%; height: 44%; 
            background: #ef4444; 
           // margin-left: -0.5%; 
            z-index: 16; 
        }

        .glass-pill {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 0.6rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .fs-btn {
            position: fixed;
            top: 1.2rem;
            right: 1.2rem;
            z-index: 100;
            background: rgba(255, 255, 255, 0.15);
            padding: 0.8rem;
            border-radius: 12px;
            cursor: pointer;
        }



:fullscreen {
    background-color: black;
}

/* Untuk Chrome/Safari */
:-webkit-full-screen {
    background-color: black;
}

.cursor-pointer {
    cursor: pointer;
}

/* Menghilangkan padding body khusus saat di halaman jam */
body:has(#halaman-jam:not(.hidden)) {
    padding: 0 !important;
}


/* Warna Merah (Default/Putus) */
.dot-red {
    background-color: #ef4444;
    box-shadow: 0 0 8px #ef4444;
}

/* Warna Hijau (Terkoneksi) */
.dot-green {
    background-color: #22c55e;
    box-shadow: 0 0 8px #22c55e;
}

    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    </head>
<body class="min-h-screen p-4 md:p-8 bg-gray-50 text-gray-800 dark:text-gray-100 transition-colors duration-300">
    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
    <script>
        // Konfigurasi Tailwind untuk mengaktifkan Dark Mode berdasarkan class="dark" pada body
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // blue-500
                        'accent': '#10b981', // emerald-500
                    }
                }
            }
        }
    </script>


<div id="halaman-jam" class="hidden flex flex-col landscape:flex-row items-center justify-evenly min-h-screen bg-black overflow-hidden p-4">

    <button class="fs-btn fixed top-4 right-4 z-50" onclick="toggleFullscreen()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
    </button>

    <div class="flex-shrink-0 mb-6 landscape:mb-0">
        <div class="clock-container shadow-[0_0_80px_rgba(255,0,0,0.2)] border-8 border-gray-900 rounded-full relative bg-black" onclick="toggleFullscreen()">
            <div id="numbers-container" class="absolute inset-0"></div>
            <div class="dot"></div>
            <div id="hour-hand" class="hand hour-hand"></div>
            <div id="min-hand" class="hand min-hand"></div>
            <div id="sec-hand" class="hand sec-hand"></div>
            <div class="absolute top-1/2 left-1/2 w-5 h-5 bg-red-600 rounded-full -translate-x-1/2 -translate-y-1/2 z-10 shadow-lg"></div>
        </div>
    </div>

          

  <div class="flex flex-col items-center landscape:items-start text-center landscape:text-left">





        <div class="flex items-baseline mb-2">
            <h1 id="time-digital" class="font-black text-white tracking-tighter">00:00</h1>
            <span id="time-seconds" class="font-bold text-red-600 ml-2 italic">00</span>
        </div>
        
        <p id="full-date-text" class="text-gray-400 font-bold uppercase tracking-[0.3em] mb-6 text-xl md:text-2xl lg:text-3xl">
          SABTU, 25 MEI 2024
        </p>
        
       <div class="weather-box-updated">
    <div class="flex items-center gap-3">
       
        <div class="flex flex-col text-left">
             <span id="temp" class="temp-text-flex text-yellow-400">--¬∞C</span>
            <span id="weatherDesc" class="weather-text-sub-flex text-yellow-400 font-bold uppercase">Memuat...</span>
            <span id="city" class="label-tiny text-yellow-400 opacity-70">Jakarta</span>
        </div>
    </div>

    <div class="divider-v"></div>

    <div class="flex flex-col items-center">
        <span class="label-tiny">Hum</span>
        <span id="humidity" class="weather-text-sub-flex font-bold text-white">--%</span>
    </div>

    <div class="divider-v"></div>

    <div class="flex flex-col items-center">
        <span class="label-tiny">Wind</span>
        <span id="windspeed" class="weather-text-sub-flex font-bold text-white">-- <small class="text-[1vmin]">km/h</small></span>
    </div>

    <div class="divider-v"></div>

    <div class="flex flex-col items-center">
        <span class="label-tiny">UV</span>
        <span id="uvIndex" class="weather-text-sub-flex font-bold text-white">--</span>
    </div>
</div>
    </div>
</div>


    <div id="background-overlay"></div>
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md border-b">


            <div id="status-display" class="text-sm font-medium text-gray-600 dark:text-gray-400">
                <span id="status-message">Menunggu Koneksi Bluetooth...</span>
                <span id="device-info" class="text-xs text-gray-400 dark:text-gray-600 block italic"></span>
            </div>
            <div class="flex space-x-2">
                <button id="theme-toggle" onclick="toggleTheme()" class="w-10 h-10 p-2 rounded-full flex items-center justify-center bg-gray-200 text-yellow-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-yellow-300 dark:hover:bg-gray-600 transition-all duration-300 shadow-md">
                    <span id="theme-icon" class="text-xl transition-transform duration-300" role="img" aria-label="Dark/Light Mode Toggle"></span>
                </button>
                
                <button id="connect-button" onclick="connectBluetooth()" class="minimal-connect-btn bg-primary text-white hover:bg-blue-600 transition disabled:opacity-50">
                    <span class="mr-1 inline-block align-middle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle">
                            <polyline points="6.5 6.5 17.5 17.5 12 23 12 1 17.5 6.5 6.5 17.5"/>
                        </svg>
                    </span>
                    Sambung
                </button>
                <button id="disconnect-button" onclick="disconnectBluetooth()" class="minimal-connect-btn bg-gray-300 text-gray-700 hover:bg-gray-400 transition disabled:opacity-50 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500" disabled>
                    Putus
                </button>
            </div>
        </header>
        <div class="flex justify-between items-center mb-4">
             <p id="wakelock-status" class="text-xs text-gray-500 dark:text-gray-400">Wakelock Off</p>
             <p id="firestore-status" class="text-xs text-gray-500 dark:text-gray-400">Status DB: Penyimpanan Lokal (localStorage) Aktif.</p>
            
             <button id="upload-logs-button" onclick="uploadAllLogsToFirebase()" class="text-xs minimal-connect-btn bg-purple-500 text-white hover:bg-purple-600 transition disabled:opacity-50">
                Upload Log ke Firebase
            </button>
        </div>
        

        <section id="safety-status-section" class="status-box mb-6 hidden bg-green-100 text-green-600 border border-green-400">
            <h3 class="font-bold text-xl mb-1">Status Keselamatan: <span id="safety-status-text">Normal</span></h3>
            <p class="text-sm" id="safety-message">Semua parameter dalam batas aman.</p>
        </section>
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="dashboard-card p-5 border-b-4 border-green-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kapasitas (SOC)</p>
                <p id="soc-value" class="value-text text-green-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soc-progress" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <p id="time-remaining" class="text-xs font-semibold text-gray-500 dark:text-gray-400 mt-2">Waktu Sisa: Menghitung...</p>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-yellow-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kesehatan (SOH)</p>
                <p id="soh-value" class="value-text text-yellow-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soh-progress" class="h-full bg-yellow-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-red-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Suhu (Maks)</p>
                <p id="temp-value" class="value-text text-red-600">0.0¬∞C</p>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Parameter Kelistrikan Inti</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="p-4 rounded-lg card-voltage">
                    <p class="text-sm font-semibold mb-1">Tegangan Total</p>
                    <p id="total-voltage" class="value-text">0.00 V</p>
                    <p id="min-max-voltage" class="text-xs font-medium mt-1">Min: 0.00 V | Max: 0.00 V</p>
                </div>
                <div class="p-4 rounded-lg card-current">
                    <p class="text-sm font-semibold mb-1">Arus</p>
                    <p id="current-value" class="value-text">0.00 A</p>
                    <p id="min-max-current" class="text-xs font-medium mt-1">Min: 0.00 A | Max: 0.00 A</p>
                </div>
                <div class="p-4 rounded-lg card-power">
                    <p class="text-sm font-semibold mb-1">Daya</p>
                    <p id="power-value" class="value-text">0.00 W</p>
                    <p id="min-max-power" class="text-xs font-medium mt-1">Min: 0.00 W | Max: 0.00 W</p>
                </div>
                <div class="p-4 rounded-lg card-cap-rem">
                    <p class="text-sm font-semibold mb-1">Kapasitas Pabrik</p>
                    <p id="remaining-capacity" class="value-text">0 Ah</p>
                   <p id="remaining-wh" class="value-text">0 Wh</p>
                </div>
                <div class="p-4 rounded-lg card-cap-used">
                    <p class="text-sm font-semibold mb-1">Kapasitas Sisa</p>
                    <p id="capacity-used-value" class="value-text">0 Ah</p>
                    <p id="wh-now" class="value-text">0 Wh</p>
                </div>
                <div class="p-4 rounded-lg card-delta">
                    <p class="text-sm font-semibold mb-1">DeltaV Sel Aktif</p>
                    <p id="delta-v-value" class="value-text">0 mV</p>
                </div>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Profil Energi (Wh) untuk Periode Aktif</h2>
            
            <div class="flex flex-wrap justify-center space-x-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
                <button id="period-1h" onclick="selectPeriod('1h')" class="period-button period-active">1 Jam</button>
                <button id="period-6h" onclick="selectPeriod('6h')" class="period-button">6 Jam</button>
                <button id="period-12h" onclick="selectPeriod('12h')" class="period-button">12 Jam</button>
                <button id="period-24h" onclick="selectPeriod('24h')" class="period-button">24 Jam</button>
                <button id="period-7d" onclick="selectPeriod('7d')" class="period-button">7 Hari</button> <button id="period-30d" onclick="selectPeriod('30d')" class="period-button">30 Hari</button>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="text-center font-semibold text-gray-800 dark:text-gray-200 mb-2">Energi Masuk (Charge +) vs Keluar (Discharge -)</h4>
                <div class="w-full h-96">
                    <canvas id="whCombinedCanvas"></canvas>
                </div>
                
                <p id="chart-status" class="text-center text-sm text-gray-500 dark:text-gray-400 mt-2">Memuat data Wh dari penyimpanan lokal...</p>
                <div class="flex flex-wrap justify-center space-x-8 text-sm mt-4 font-semibold">
                    <p class="text-green-600"><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> Total Charge: <span id="total-charge-wh">0.000 Wh</span></p>
                    <p class="text-red-600"><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> Total Discharge: <span id="total-discharge-wh">0.000 Wh</span></p>
                </div>
            </div>
        </section>


        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Detail Tegangan Sel (S1-S4)</h2>
            <div id="cell-voltage-detail" class="grid cell-grid gap-4">
                <div id="cell-1" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 1</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-2" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 2</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-3" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 3</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-4" class="p-3 text-center rounded-lg bg-gray-200 border border-gray-300">
                    <p class="text-sm font-medium">Sel 4</p>
                    <p class="text-xl font-bold text-gray-500">0.00 V</p>
                </div>
            </div>
            <p id="summary-min-max" class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center">Min: 0.000 V | Max: 0.000 V | DeltaV: 0 mV</p>
            <p id="balancing-status" class="font-bold text-lg text-green-600 text-center mt-2">Status Balancing: Normal</p>
        </section>

        <section class="p-6 dashboard-card">
          <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Parameter Detail Tambahan</h2>
    
         <div id="error-history-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 ">
        </div>

         <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="extra-parameters">
        </div>
      </section>

        <div id="error-box" class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <p class="font-bold text-lg">‚ö†Ô∏è Kesalahan Protokol/Koneksi/Parsing:</p>
            <p id="error-details" class="text-sm mt-1"></p>
        </div>


 


<nav class="flex space-x-2 mr-4 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
    <button id="btn-monitor" onclick="pindahKe('monitor')" 
        class="text-xs font-bold px-4 py-1.5 rounded-md transition-all duration-300 bg-blue-500 text-white shadow-sm">
        Monitor
    </button>
    <button id="btn-jam" onclick="pindahKe('jam')" 
        class="text-xs font-bold px-4 py-1.5 rounded-md transition-all duration-300 text-gray-500 dark:text-gray-300">
        Jam
    </button>
</nav>

    </div>

    <script src="chart.js"></script>
    <script type="text/javascript">
        // --- UUID Konfigurasi Perangkat ---
        const UART_SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; 
        const TX_CHARACTERISTIC_UUID = '0000ffe2-0000-1000-8000-00805f9b34fb'; 
        const RX_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb'; 
        const EXPECTED_LENGTH = 82; 

        // --- Variabel Global & Konstanta Lainnya ---
        let device = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let requestInterval = null;
        let dataBuffer = new ArrayBuffer(0); 
        
        let whChart = null; // Instans Chart.js untuk Charge & Discharge Gabungan
        let lastLogTime = 0; // Untuk batasan logging
        
        // *** PERUBAHAN: Interval logging 1 menit (60 detik) ***
        const LOG_INTERVAL_MS = 60000; // Interval logging 1 menit (60 detik) 
        const MAX_LOG_ENTRIES = 10000; // Batas untuk mencegah localStorage penuh

        // Variabel untuk melacak Min/Max
        let minTotalVoltage = Infinity;
        let maxTotalVoltage = -Infinity;
        let minCurrent = Infinity;
        let maxCurrent = -Infinity;
        let minPower = Infinity;
        let maxPower = -Infinity;

        // Kunci untuk menyimpan data di localStorage
        const LOCAL_STORAGE_KEY = 'bms_power_logs';
        const THEME_KEY = 'bms_theme'; // Kunci untuk tema
        
        // Variabel Global untuk menyimpan data dashboard terakhir yang diuraikan
        let lastDashboardData = {};


        // --- DEFINISI SVG ICONS OFFLINE ---
        const SVG_ICONS = {
            // Thermometer (Suhu)
            THERMOMETER: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
            // Heart (Kesehatan SOH)
            HEART: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
            // Flash/Zap (Relay Pengisian) - Simbol petir untuk arus/listrik
            FLASH: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            // Flame (Relay Pengurasan) - Simbol api untuk panas/discharge
            FLAME: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM15 15.5A2.5 2.5 0 0 0 17.5 13c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM8.5 8.5A2.5 2.5 0 0 0 11 6c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM15 9.5A2.5 2.5 0 0 0 17.5 7c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5z"/></svg>',

            // Opsi Alternatif: Battery Half dengan isi blok solid (lebih mudah terlihat)
            BATTERY_HALF_SOLID: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="16" height="10" rx="2" ry="2"></rect><line x1="22" y1="11" x2="22" y2="13"></line><rect x="5" y="10" width="5" height="4" fill="currentColor" stroke="none"></rect></svg>',
           // Alternatif: Bolt dengan lingkaran (sering digunakan untuk total energi/konsumsi)
            ENERGY: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M13 6l-5 8h4v4l5-8h-4V6z"/></svg>'
        };

       // Pemetaan Index berdasarkan urutan float[] di Arduino
const INDEX_VA = {
    TOTAL_VOLTAGE: 0, CELL_1: 1, CELL_2: 2, CELL_3: 3, CELL_4: 4, 
    CURRENT: 5, POWER: 6, CAP_MAX: 7, SOC: 8, WH_NOW: 9, WH_DESIGN: 10
};


const INDEX_PT = {
    TEMP_1: 0, TEMP_2: 1, CAP_REMAINING: 2, 
    CAP_CHG: 3, CAP_DISCHG: 4, 
    RELAY_CHG: 5, RELAY_DISCHG: 6, 
    SOH: 7, WH_POS: 8, WH_NEG: 9, CYCLE: 10
};

const INDEX_ER = {
    ERROR_CODE: 0, HIS_1: 1, HIS_2: 2, HIS_3:3, HIS_4:4, HIS_5:5,
};

// Gabungan untuk looping UI (ALL_DATA_MAP)
// Kita tambahkan properti 'packet' agar tahu ini data dari VA atau PT
const ALL_DATA_MAP = [
    // --- PAKET VA ---
    { key: 'total_v', label: 'Tegangan Total', unit: 'V', index: INDEX_VA.TOTAL_VOLTAGE, packet: 'VA', showInExtra: false },
    { key: 'cell_1', label: 'Tegangan Sel 1', unit: 'V', index: INDEX_VA.CELL_1, packet: 'VA', showInExtra: false },
    { key: 'cell_2', label: 'Tegangan Sel 2', unit: 'V', index: INDEX_VA.CELL_2, packet: 'VA', showInExtra: false },
    { key: 'cell_3', label: 'Tegangan Sel 3', unit: 'V', index: INDEX_VA.CELL_3, packet: 'VA', showInExtra: false },
    { key: 'cell_4', label: 'Tegangan Sel 4', unit: 'V', index: INDEX_VA.CELL_4, packet: 'VA', showInExtra: false },
    { key: 'current', label: 'Arus', unit: 'A', index: INDEX_VA.CURRENT, packet: 'VA', showInExtra: false },
    { key: 'power', label: 'Daya', unit: 'W', index: INDEX_VA.POWER, packet: 'VA', showInExtra: false },
    { key: 'cap_max', label: 'Kapasitas Full', unit: 'Ah', index: INDEX_VA.CAP_MAX, packet: 'VA', showInExtra: false },
    { key: 'soc', label: 'SOC', unit: '%', index: INDEX_VA.SOC, packet: 'VA', showInExtra: false },
    { key: 'wh_now', unit: 'Wh', index: INDEX_VA.WH_NOW, packet: 'VA', showInExtra: false },
    { key: 'wh_design', unit: 'Wh', index: INDEX_VA.WH_DESIGN, packet: 'VA', showInExtra: false },

    // --- PAKET PT ---
    { key: 'temp_batt', label: 'Suhu Baterai', unit: '¬∞C', index: INDEX_PT.TEMP_1, packet: 'PT', showInExtra: true, iconKey: 'THERMOMETER' }, 
    { key: 'temp_mos', label: 'Suhu Mosfet', unit: '¬∞C', index: INDEX_PT.TEMP_2, packet: 'PT', showInExtra: true, iconKey: 'THERMOMETER' }, 
    { key: 'cap_remain', label: 'Kapasitas Tersisa', unit: 'Ah', index: INDEX_PT.CAP_REMAINING, packet: 'PT', showInExtra: false },
    { key: 'cap_chg', label: 'Kapasitas Pengisian', unit: 'Ah', index: INDEX_PT.CAP_CHG, packet: 'PT', showInExtra: true, iconKey: 'BATTERY_HALF_SOLID' },
    { key: 'cap_dis', label: 'Kapasitas Pengurasan', unit: 'Ah', index: INDEX_PT.CAP_DISCHG, packet: 'PT', showInExtra: true, iconKey: 'BATTERY_HALF_SOLID' },
    { key: 'relay_chg', label: 'Relay Pengisian', unit: '', index: INDEX_PT.RELAY_CHG, packet: 'PT', showInExtra: true, iconKey: 'FLASH' },
    { key: 'relay_dis', label: 'Relay Pengurasan', unit: '', index: INDEX_PT.RELAY_DISCHG, packet: 'PT', showInExtra: true, iconKey: 'FLAME' },
    { key: 'soh', label: 'SOH', unit: '%', index: INDEX_PT.SOH, packet: 'PT', showInExtra: false },
    { key: 'energy_in', label: 'Energy Masuk', unit: 'Wh', index: INDEX_PT.WH_POS, packet: 'PT', showInExtra: true, iconKey: 'ENERGY' },
    { key: 'energy_out', label: 'Energy Keluar', unit: 'Wh', index: INDEX_PT.WH_NEG, packet: 'PT', showInExtra: true, iconKey: 'ENERGY' },
    { key: 'cycle_count', label: 'Cycle Count', unit: 'CC', index: INDEX_PT.CYCLE, packet: 'PT', showInExtra: true, iconKey: 'HEART' },

    // --- PAKET ER ---
    { key: 'error_code', index: INDEX_ER.ERROR_CODE, packet: 'ER', showInExtra: false },
    { key: 'history_error_1', index: INDEX_ER.HIS_1, packet: 'ER', showInExtra: false },
    { key: 'history_error_2', index: INDEX_ER.HIS_2, packet: 'ER', showInExtra: false },
    { key: 'history_error_3', index: INDEX_ER.HIS_3, packet: 'ER', showInExtra: false },
    { key: 'history_error_4', index: INDEX_ER.HIS_4, packet: 'ER', showInExtra: false },
    { key: 'history_error_5', index: INDEX_ER.HIS_5, packet: 'ER', showInExtra: false },
];
        
        // --- KONFIGURASI GRAFIK WH BARU ---
        // Nilai dalam milidetik dan jumlah titik data
        const PERIOD_CONFIG = { 
            '1h': { durationMs: 3600 * 1000, points: 12, label: '1 Jam' }, // Ditingkatkan ke 12 titik (tiap 5 menit)
            '6h': { durationMs: 6 * 3600 * 1000, points: 24, label: '6 Jam' }, // 24 titik (tiap 15 menit)
            '12h': { durationMs: 12 * 3600 * 1000, points: 24, label: '12 Jam' }, // 24 titik (tiap 30 menit)
            '24h': { durationMs: 24 * 3600 * 1000, points: 24, label: '24 Jam' }, // 24 titik (tiap 1 jam)
            '7d': { durationMs: 7 * 24 * 3600 * 1000, points: 7, label: '7 Hari' },
            '30d': { durationMs: 30 * 24 * 3600 * 1000, points: 30, label: '30 Hari' } 
        };
        // --- END KONFIGURASI GRAFIK WH BARU ---
        
        
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
           apiKey: "AIzaSyC9eBW7aVC7Rb8Z8SQqWhWoFNJSQDxJPT8",
           authDomain: "batmon3s.firebaseapp.com",
           databaseURL: "https://batmon3s-default-rtdb.asia-southeast1.firebasedatabase.app",
           projectId: "batmon3s",
           storageBucket: "batmon3s.firebasestorage.app",
           messagingSenderId: "99805076488",
          appId: "1:99805076488:web:d65fc114b1ae6eeaa505bd",
          measurementId: "G-0NZKBGC3L3"
        };

        // Inisialisasi Firebase
        let firebaseApp;
        let firebaseDB;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseDB = firebaseApp.database();
            document.getElementById('firestore-status').textContent = 'Status DB: Firebase Realtime Database Aktif.';
        } catch(e) {
             document.getElementById('firestore-status').textContent = `Status DB: Firebase GAGAL Inisialisasi: ${e.message}. Hanya Penyimpanan Lokal Aktif.`;
             console.error('Firebase initialization error:', e);
        }
        // --- END KONFIGURASI FIREBASE ---

      let htmlCachePT = ""; 
      let htmlCacheER = "";

        // --- UI Elements ---
        const statusMessage = document.getElementById('status-message');
        const deviceInfo = document.getElementById('device-info');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const errorBox = document.getElementById('error-box');
        const errorDetails = document.getElementById('error-details');
        const uploadLogsButton = document.getElementById('upload-logs-button');
        
        // Variabel untuk elemen ikon tema
        const themeIcon = document.getElementById('theme-icon'); 
        
        const cellElements = [
            document.getElementById('cell-1'), 
            document.getElementById('cell-2'), 
            document.getElementById('cell-3'),
            document.getElementById('cell-4'),
        ];
        const summaryMinMaxElement = document.getElementById('summary-min-max');
        const totalVoltageElement = document.getElementById('total-voltage');
        const minMaxVoltageElement = document.getElementById('min-max-voltage'); 
        const currentElement = document.getElementById('current-value');
        const minMaxCurrentElement = document.getElementById('min-max-current'); 
        const powerElement = document.getElementById('power-value');
        const minMaxPowerElement = document.getElementById('min-max-power'); 
        const capacityUsedElement = document.getElementById('capacity-used-value');
        const whNowElement = document.getElementById('wh-now');
        const remainingCapacityElement = document.getElementById('remaining-capacity');
        const remainingWhElement = document.getElementById('remaining-wh');
        const deltaVElement = document.getElementById('delta-v-value');
        const socValueElement = document.getElementById('soc-value');
        const socProgressElement = document.getElementById('soc-progress');
        const sohValueElement = document.getElementById('soh-value');
        const sohProgressElement = document.getElementById('soh-progress');
        const tempValueElement = document.getElementById('temp-value');
        const timeRemainingElement = document.getElementById('time-remaining');
        const safetyStatusSection = document.getElementById('safety-status-section');
        const safetyStatusText = document.getElementById('safety-status-text');
        const safetyMessage = document.getElementById('safety-message');
        const extraParametersContainer = document.getElementById('extra-parameters');
        const chartStatusElement = document.getElementById('chart-status');
        const totalChargeWhElement = document.getElementById('total-charge-wh');
        const totalDischargeWhElement = document.getElementById('total-discharge-wh');

        
        
// --- FUNGSI BARU UNTUK WAKELOCK (Menjaga Layar Tetap Menyala) ---

// Variabel global untuk menyimpan objek wakelock
let wakeLock = null;

/**
 * Mengaktifkan Screen Wake Lock (menjaga layar tetap menyala).
 */
async function acquireWakeLock() {
    // Cek apakah browser mendukung API ini
    if ('wakeLock' in navigator) {
        try {
            // Hanya minta lock jika belum ada yang aktif
            if (!wakeLock) {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Wakelock berhasil diaktifkan.');
                document.getElementById('wakelock-status').textContent = '‚úÖ Wakelock Aktif';

                // Tambahkan event listener untuk mengaktifkan kembali wakelock 
                // jika dilepas otomatis oleh browser (misalnya, saat beralih tab)
                wakeLock.addEventListener('release', () => {
                    console.log('Wakelock dilepas secara otomatis oleh browser.');
                    wakeLock = null; // Setel ulang variabel
                   // document.getElementById('wakelock-status').textContent = '‚ö™ Wakelock Mati';
                });
            }
        } catch (err) {
            // Tangani kegagalan (misalnya, pengguna menolak izin)
            console.error(`Gagal mengaktifkan wakelock: ${err.name}, ${err.message}`);
            document.getElementById('wakelock-status').textContent = '‚ùå Wakelock Gagal';
        }
    } else {
        console.warn('Browser tidak mendukung Screen Wake Lock API.');
       document.getElementById('wakelock-status').textContent = 'üö´ Wakelock Tidak Didukung';
    }
}

/**
 * Melepaskan Screen Wake Lock (membiarkan layar mati normal).
 */
function releaseWakeLock() {
    if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
        console.log('Wakelock berhasil dilepas.');
        document.getElementById('wakelock-status').textContent = '‚ö™ Wakelock Mati';
    }
}
        // --- Utility Functions (formatTime, calculateChecksum, parseData, sendRequest, handleNotifications, onDisconnected) ---
        

/**
 * Memformat waktu dalam satuan jam menjadi string "Hj Mm Ss" atau "N/A".
 * @param {number} hours - Waktu dalam jam (misalnya 1.5 untuk 1 jam 30 menit).
 * @returns {string} String waktu yang diformat.
 */
function formatTime(hours) {
    // Menangani nilai tidak valid atau nol
    if (!isFinite(hours) || hours <= 0) {
        return "N/A";
    }

    // Mengubah jam ke total detik
    const totalSeconds = hours * 3600;

    // Memastikan totalSeconds adalah bilangan bulat terdekat (opsional, tapi disarankan)
    const roundedSeconds = Math.round(totalSeconds);

    const h = Math.floor(roundedSeconds / 3600);
    const m = Math.floor((roundedSeconds % 3600) / 60);
    const s = roundedSeconds % 60;

    let result = "";

    // Tambahkan Jam jika lebih dari 0
    if (h > 0) {
        result += `${h}j `;
    }

    // Tambahkan Menit jika lebih dari 0 ATAU jika Jam = 0
    if (m > 0 || h > 0) {
        result += `${m}m `;
    }

    // Tambahkan Detik (selalu ditambahkan jika waktu total > 0 dan kurang dari 1 jam)
    // Atau jika Jam dan Menit nol, Detik harus ditampilkan (misal: "30s").
    if (s > 0 || (h === 0 && m === 0)) {
        // Hanya tampilkan jika waktu > 0
        if (roundedSeconds > 0) {
            result += `${s}s`;
        }
    }
    
    // Jika hasilnya kosong (misalnya, totalSeconds sangat kecil dan dibulatkan menjadi 0), 
    // kembalikan kurang dari 1 detik.
    return result.trim() || "<1s";
}


        
   function calculateChecksum(dataArray) {
    let checksum = 0;
    for (let i = 0; i < dataArray.length; i++) {
        checksum ^= dataArray[i];
    }
    return checksum;
}
  
      
 function parseData(dataView, type) {
    const actualLength = dataView.byteLength;
    let expectedLength = 0;
    let isByteType = false; // Flag untuk membedakan ER dengan VA/PT

    // Tentukan aturan berdasarkan tipe yang dikirim
    if (type === 'VA') {
        expectedLength = 46;
    } else if (type === 'PT') {
        expectedLength = 46;
    } else if (type === 'ER') {
        expectedLength = 8; // 1 Header + 6 Data + 1 Checksum
        isByteType = true;
    }

    // Validasi panjang
    if (actualLength !== expectedLength) {
        console.error(`[${type}] Panjang salah: ${actualLength} (Harusnya ${expectedLength})`);
        return null;
    }

    // Validasi Checksum
    const bodyData = new Uint8Array(dataView.buffer, dataView.byteOffset + 1, actualLength - 2);
    const receivedChecksum = dataView.getUint8(actualLength - 1);
    if (receivedChecksum !== calculateChecksum(bodyData)) {
        console.error(`[${type}] Checksum Gagal`);
        return null;
    }

    const values = [];
    if (isByteType) {
        // Ambil data per 1 byte (Khusus ER)
        for (let i = 0; i < 6; i++) {
            values.push(dataView.getUint8(1 + i));
        }
    } else {
        // Ambil data per 4 byte (Untuk VA dan PT)
        let numFloats = (expectedLength - 2) / 4;
        for (let i = 0; i < numFloats; i++) {
            values.push(dataView.getFloat32(1 + (i * 4), true));
        }
    }

    return values;
}
   

let isBluetoothBusy = false; // Flag untuk mencegah tabrakan perintah

async function sendRequestCustom(char1, char2) {
    // 1. Validasi Koneksi
    if (!txCharacteristic || !device || !device.gatt.connected) {
        console.warn("‚ö†Ô∏è Bluetooth tidak terhubung.");
        return;
    }

    // 2. Cegah Tabrakan Operasi (GATT Lock)
    if (isBluetoothBusy) {
        // Jika sibuk, kita coba lagi dalam 100ms (Opsional: atau langsung return)
        setTimeout(() => sendRequestCustom(char1, char2), 100);
        return;
    }

    try {
        isBluetoothBusy = true; // Kunci akses Bluetooth

        const header = 0xBB;
        const c1 = char1.charCodeAt(0);
        const c2 = char2.charCodeAt(0);
        
        // Hitung Checksum: 0xBB ^ C1 ^ C2
        const checksum = (header ^ c1 ^ c2) & 0xFF; 
        const packet = new Uint8Array([header, c1, c2, checksum]);

        // Kirim data ke BMS
        await txCharacteristic.writeValue(packet);
        
        console.log(`üì° Sent Request: ${char1}${char2} (Packet: ${header.toString(16)} ${c1.toString(16)} ${c2.toString(16)} ${checksum.toString(16)})`);

    } catch (error) {
        console.warn(`‚ö†Ô∏è Gagal kirim ${char1}${char2}:`, error);
    } finally {
        // 3. Lepaskan Kunci setelah jeda singkat (agar BMS siap menerima perintah selanjutnya)
        setTimeout(() => {
            isBluetoothBusy = false;
        }, 150); // Jeda 150ms aman untuk modul ESP32/BMS
    }
}


 function handleNotifications(event) {
    const incomingData = event.target.value.buffer;
    const incomingUint8 = new Uint8Array(incomingData);
    
    // LOG 1: Pantau data yang baru saja masuk (biasanya per 20 byte)
    console.log("üì• Incoming (Hex):", Array.from(incomingUint8).map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' '));
    
    // 1. Gabungkan data baru ke buffer utama
    const combined = new Uint8Array(dataBuffer.byteLength + incomingData.byteLength);
    combined.set(new Uint8Array(dataBuffer), 0);
    combined.set(incomingUint8, dataBuffer.byteLength);
    dataBuffer = combined.buffer;

    let view = new Uint8Array(dataBuffer);
    console.log(`üì¶ Current Buffer Size: ${view.length} bytes`);

    // 2. Loop paket selama data masih ada
    while (view.length > 0) {
        const header = view[0];
        let targetLength = 0;

        // Identifikasi paket berdasarkan Header
if (header === 0xAA) {
    targetLength = 46; // Paket Volt/Amp (VA)
    currentPacketType = 'VA';
} else if (header === 0xCC) {
    targetLength = 46; // Paket Parameter (PT)
    currentPacketType = 'PT';
} else if (header === 0xEE) {
    targetLength = 8; 
    currentPacketType = 'ER'; // <--- UBAH INI JADI ER
} else {
    console.warn(`üóëÔ∏è Skipping byte: 0x${header.toString(16).toUpperCase()}`);
    view = view.slice(1);
    continue;
}

        // 3. Cek apakah panjang data mencukupi target
        if (view.length >= targetLength) {
            console.log(`‚úÖ Header Detected: 0x${header.toString(16).toUpperCase()} | Expecting: ${targetLength} bytes`);
            
            const packetToParse = view.slice(0, targetLength);
            
            // LOG 2: Isi paket lengkap sebelum masuk ke fungsi parseData
           // Menggunakan ternary bertingkat yang benar
           // 1. Debugging: Cetak paket mentah dalam bentuk Hex
// 1. Log Data Mentah untuk Debugging
const typeName = header === 0xAA ? 'VA' : header === 0xCC ? 'PT' : 'ER';
console.log(`üìú Full Packet (Type ${typeName}):`, 
    Array.from(packetToParse).map(b => b.toString(16).toUpperCase().padStart(2, '0')).join(' '));


          

// 2. Gunakan packetToParse (karena ini hasil slice yang sudah bersih)
const dataView = new DataView(packetToParse.buffer, packetToParse.byteOffset, packetToParse.byteLength);

// 3. Eksekusi Parsing
// Kita simpan hasil parseData ke dalam variabel sementara untuk divalidasi
const parsedValues = parseData(dataView, currentPacketType);

// 4. Update UI & Dashboard hanya jika parsing BERHASIL (tidak null)
if (parsedValues) {
    const result = {
        type: currentPacketType,
        data: parsedValues
    };

    // Panggil fungsi update dashboard utama
    updateDashboard(result.data, result.type);
    
    // Update Pesan Status di UI
    switch (result.type) {
        case 'VA':
            statusMessage.textContent = "Terkoneksi | Menerima data Volt/Amp";
            statusMessage.classList.replace('text-red-500', 'text-green-500'); // Opsional: ganti warna jadi hijau
            
            // Khusus VA, log data arus ke grafik (indeks 6 sesuai INDEX_VA.CURRENT)
            if (typeof logBMSData === 'function' && result.data[6] !== undefined) {
                logBMSData(result.data[6]); 
            }
            break;

        case 'PT':
            statusMessage.textContent = "Terkoneksi | Menerima data Parameter";
            statusMessage.classList.replace('text-red-500', 'text-green-500');
            break;

        case 'ER':
            statusMessage.textContent = "Terkoneksi | Menerima data ErrorCode";
            statusMessage.classList.replace('text-green-500', 'text-yellow-500'); // Kuning untuk warning/error
            break;
    }

    // Sembunyikan error box jika data masuk dengan benar
    if (typeof errorBox !== 'undefined') errorBox.classList.add('hidden');

} else {
    // Jika parseData mengembalikan null (misal karena checksum salah)
    console.warn(`[Bluetooth] Gagal memproses paket ${currentPacketType}`);
    statusMessage.textContent = `Data ${currentPacketType} Rusak (Checksum Error)`;
    statusMessage.classList.replace('text-green-500', 'text-red-500');
}

            // Potong view setelah diproses
            view = view.slice(targetLength);
        } else {
            // Data belum lengkap (misal baru 10 dari 38 byte)
            console.log(`‚è≥ Waiting for more data... (${view.length}/${targetLength})`);
            break;
        }
    }

    // 4. Update dataBuffer utama dengan sisa data yang belum lengkap
    // Kita buat buffer baru dari sisa view agar memori bersih
    dataBuffer = new Uint8Array(view).buffer;
}
        
        // *** FUNGSI BARU: Log notifikasi ke Firebase ***
        function logNotificationToFirebase(type, message) {
            if (!firebaseDB) return;
            try {
                const now = Date.now();
                // Menggunakan push() untuk menambahkan entri baru di bawah node 'notifications'
                firebaseDB.ref('notifications').push({
                    timestamp: now,
                    time_local: new Date(now).toLocaleString('id-ID'),
                    type: type, // 'BLUETOOTH_DISCONNECTED'
                    message: message,
                    device: device ? (device.name || 'Unknown Device') : 'N/A'
                })
                .then(() => console.log(`Log Notifikasi Firebase berhasil: ${type}`))
                .catch((error) => console.error("Error mengirim notifikasi Firebase:", error));
            } catch(e) {
                console.error("Error saat mencoba upload notifikasi:", e);
            }
        }
        
       function onDisconnected(event) {
    // Mendapatkan objek perangkat dari event jika tersedia
    const disconnectedDevice = event ? event.target : device;
    
    if (requestInterval) {
        clearInterval(requestInterval);
        requestInterval = null;
    }
    
    if (rxCharacteristic) {
        rxCharacteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
    }
    
    // 1. Tentukan Pesan Berdasarkan Kondisi
    let reason = "Koneksi terputus (di luar jangkauan atau perangkat mati).";
    
    // Jika fungsi dipanggil secara manual dari tombol 'Putus'
    if (!event) {
        reason = "Koneksi diputuskan oleh pengguna.";
    }

    // 2. Kirim notif ke Firebase dengan alasan yang spesifik
    logNotificationToFirebase('BLUETOOTH_DISCONNECTED', reason); 

    // 3. Update UI Pesan Status
    statusMessage.textContent = reason;
    
    // Tambahkan keterangan tambahan di elemen info perangkat
    if (deviceInfo) {
        deviceInfo.textContent = `Status Terakhir: ${reason}`;
        deviceInfo.classList.add('text-red-500'); // Beri warna merah agar terlihat
    }

    // Reset UI seperti semula
    connectButton.disabled = false;
    disconnectButton.disabled = true;
    dataBuffer = new ArrayBuffer(0); 

    // Update UI Dot dan Dashboard
    updateConnectionUI("Disconnected");
    
    const initialValues = Array(17).fill(0.0);
    // Inisialisasi array kosong
// Panggil secara spesifik agar struktur HTML terbentuk
    updateDashboard(initialValues);
         
    safetyStatusSection.classList.add('hidden'); 
    
    // Reset min/max trackers
    minTotalVoltage = Infinity;
    maxTotalVoltage = -Infinity;
    minMaxVoltageElement.textContent = "Min: 0.00 V | Max: 0.00 V";
    
    minCurrent = Infinity;
    maxCurrent = -Infinity;
    minMaxCurrentElement.textContent = "Min: 0.00 A | Max: 0.00 A";

    minPower = Infinity;
    maxPower = -Infinity;
    minMaxPowerElement.textContent = "Min: 0.00 W | Max: 0.00 W";
}

        // --- Logic Koneksi Bluetooth (connectBluetooth, disconnectBluetooth) ---
        async function connectBluetooth() {
            if (!navigator.bluetooth) {
                statusMessage.textContent = "Web Bluetooth tidak didukung. Gunakan Chrome via HTTPS/localhost.";
                return;
            }

            connectButton.disabled = true;
            errorBox.classList.add('hidden');
            statusMessage.textContent = "Memindai perangkat...";

            try {
                // Sisa logic koneksi Bluetooth sama seperti sebelumnya
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [UART_SERVICE_UUID] 
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                deviceInfo.textContent = `Perangkat: ${device.name || 'Tidak Dikenal'}`;
                statusMessage.textContent = `Menyambung ke ${device.name || 'perangkat tak dikenal'}...`;

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);
                txCharacteristic = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);
                
                // Cek karakteristik properties
                let errorMsg = '';
                if (!(rxCharacteristic.properties.notify || rxCharacteristic.properties.indicate)) {
                    errorMsg += 'RX (FFE1) tidak mendukung NOTIFY/INDICATE.\n';
                }
                if (!txCharacteristic.properties.write && !txCharacteristic.properties.writeWithoutResponse) {
                    errorMsg += 'TX (FFE2) tidak mendukung WRITE.\n';
                }
                if (errorMsg) {
                    throw new Error(`Karakteristik tidak mendukung operasi: ${errorMsg}`);
                }
                
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                statusMessage.textContent = "Terkoneksi! Permintaan data dimulai (1Hz).";
                connectButton.disabled = true;
                disconnectButton.disabled = false;

                const info = statusMessage.textContent;
    
                 // PANGGIL DI SINI agar UI berubah
                updateConnectionUI(info, "CONNECTED");

                // Reset min/max trackers saat koneksi baru
                minTotalVoltage = Infinity;
                maxTotalVoltage = -Infinity;
                minCurrent = Infinity;
                maxCurrent = -Infinity;
                minPower = Infinity;
                maxPower = -Infinity;
                minMaxVoltageElement.textContent = "Min: 0.00 V | Max: 0.00 V";
                minMaxCurrentElement.textContent = "Min: 0.00 A | Max: 0.00 A";
                minMaxPowerElement.textContent = "Min: 0.00 W | Max: 0.00 W";
                
                // Simpan interval dalam array agar mudah dibersihkan saat disconnect
          requestIntervals = []; 

          // 1. Request VA setiap 1 detik
          const vaInterval = setInterval(() => {
              sendRequestCustom('V', 'A');
          }, 1000);
          requestIntervals.push(vaInterval);

          // 2. Request PT setiap 3 detik (dengan offset 500ms agar tidak tabrakan dengan VA)
          setTimeout(() => {
              const ptInterval = setInterval(() => {
                  sendRequestCustom('P', 'T');
              }, 3000);
              requestIntervals.push(ptInterval);
          }, 500); // Jeda awal 0.5 detik agar selang-seling dengan VA

          setTimeout(() => {
              const erInterval = setInterval(() => {
                  sendRequestCustom('E', 'R');
              }, 4000);
              requestIntervals.push(erInterval);
          }, 500);


                
                // Setelah koneksi berhasil, segera muat grafik untuk periode default
                await fetchAndRenderGraphs(selectedPeriod);

            } catch (error) {
                console.error("Kesalahan koneksi/GATT:", error);
                errorDetails.textContent = `Error: ${error.message}`;
                errorBox.classList.remove('hidden');
                statusMessage.textContent = "Koneksi Gagal. Silakan coba lagi.";
                
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                deviceInfo.textContent = "";
                if (requestInterval) {
                    clearInterval(requestInterval);
                    requestInterval = null;
                }
            }
            acquireWakeLock();
        }


     function disconnectBluetooth() {
    releaseWakeLock();

    // Hentikan semua interval permintaan data (VA dan PT)
    if (typeof requestIntervals !== 'undefined' && requestIntervals.length > 0) {
        requestIntervals.forEach(interval => clearInterval(interval));
        requestIntervals = []; // Kosongkan array
        console.log("üõë Semua interval data dihentikan.");
    }

    if (device && device.gatt.connected) {
        device.gatt.disconnect();
        // onDisconnected() akan dipanggil otomatis via event listener
    } else {
        onDisconnected(); 
    }
}

        // --- Logic LocalStorage untuk Logging ---
        function getLocalLogs() {
            try {
                const logsString = localStorage.getItem(LOCAL_STORAGE_KEY);
                return logsString ? JSON.parse(logsString) : [];
            } catch (e) {
                console.error("Gagal mengambil log dari localStorage:", e);
                return [];
            }
        }

        function logBMSData(power) {
            // Batasi logging hanya jika ada aktivitas (Charging/Discharging) atau baterai terhubung
            if (Math.abs(power) < 0.1) {
                return; 
            }
            
            // Gunakan interval 1 menit untuk menghemat storage
            const now = Date.now();
            if (now - lastLogTime < LOG_INTERVAL_MS) {
                 return;
            }

            try {
                let logs = getLocalLogs();
                
                // Tambahkan log baru
                logs.push({
                    timestamp: now,
                    power_W: power, 
                });
                
                // Batasi jumlah entri log
                if (logs.length > MAX_LOG_ENTRIES) {
                    // Hanya simpan MAX_LOG_ENTRIES data terbaru
                    logs = logs.slice(logs.length - MAX_LOG_ENTRIES); 
                }

                // Simpan kembali ke localStorage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(logs));
                lastLogTime = now;
            } catch (error) {
                console.error("Gagal mencatat data ke localStorage:", error);
            }
        }

        // --- Logic Grafik Wh (Diperbarui untuk Agregasi) ---
        let selectedPeriod = '1h'; 

        function selectPeriod(period) {
            selectedPeriod = period;
            
            // Update tombol aktif
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('period-active');
                // Pastikan tombol non-aktif tetap terlihat baik di mode baru
                const isDark = document.body.classList.contains('dark');
                if (isDark) {
                    btn.classList.remove('bg-primary', 'text-white', 'shadow-md');
                    // Menggunakan gray-700/800 agar sesuai dengan dark mode
                    btn.classList.add('bg-gray-800', 'text-gray-300', 'hover:bg-gray-600'); 
                } else {
                     btn.classList.remove('bg-gray-800', 'text-gray-300', 'hover:bg-gray-600');
                     btn.classList.remove('bg-primary', 'text-white', 'shadow-md'); 
                     btn.classList.add('hover:bg-gray-200'); 
                }
            });
            const activeBtn = document.getElementById(`period-${period}`);
            activeBtn.classList.add('period-active'); // Ini akan menerapkan bg-primary text-white

            // Muat ulang grafik
            fetchAndRenderGraphs(period);
        }

        /**
         * Mengelompokkan log Power (W) ke dalam sejumlah titik (bins) untuk periode tertentu.
         * Menghitung akumulasi Wh (Watt-jam) untuk setiap bin.
         * @param {Array<Object>} logs - Array log { timestamp, power_W }.
         * @param {number} durationMs - Total durasi periode dalam milidetik.
         * @param {number} numPoints - Jumlah titik data (bins) yang diinginkan.
         */
        function aggregateEnergyData(logs, durationMs, numPoints) {
            if (logs.length === 0 || numPoints === 0) {
                return { 
                    labels: Array(numPoints).fill('N/A'), 
                    chargeData: Array(numPoints).fill(0), 
                    dischargeData: Array(numPoints).fill(0),
                    totalChargeWh: 0,
                    totalDischargeWh: 0
                };
            }

            // Tentukan ukuran setiap bin (interval waktu)
            const binDurationMs = durationMs / numPoints;
            const now = Date.now();
            const startTime = now - durationMs;
            
            // Inisialisasi array untuk setiap bin
            const chargeBins = Array(numPoints).fill(0);
            const dischargeBins = Array(numPoints).fill(0);
            const labels = [];
            
            let totalChargeWh = 0;
            let totalDischargeWh = 0;
            // Log interval (1 menit = 60 detik) = 60 / 3600 jam
            const timeIntervalHours = LOG_INTERVAL_MS / (1000 * 3600); 

            // 1. Agregasi data log ke dalam bin yang sesuai
            logs.forEach(log => {
                // Hanya proses log dalam periode yang diminta
                if (log.timestamp >= startTime) {
                    // Hitung indeks bin. Math.floor memastikan indeks antara 0 hingga numPoints-1
                    let binIndex = Math.floor((log.timestamp - startTime) / binDurationMs);

                    // Batasi indeks agar tidak melebihi batas (misalnya jika ada log yang sedikit terlambat)
                    if (binIndex >= numPoints) {
                        binIndex = numPoints - 1;
                    } else if (binIndex < 0) {
                        return; // Abaikan
                    }

                    const power = log.power_W;
                    // Wh dihitung dari Power (Watt) * Interval Waktu (Jam)
                    const wh = Math.abs(power) * timeIntervalHours;

                    if (power > 0.1) {
                        chargeBins[binIndex] += wh;
                        totalChargeWh += wh;
                    } else if (power < -0.1) {
                        // Discharge
                        dischargeBins[binIndex] += wh; 
                        totalDischargeWh += wh;
                    }
                }
            });
            
            // 2. Buat label yang bermakna
            for (let i = 0; i < numPoints; i++) {
                const binStartMs = startTime + (i * binDurationMs);
                const date = new Date(binStartMs);
                
                let label;
                if (durationMs <= PERIOD_CONFIG['24h'].durationMs) {
                    // Untuk jam dan sub-hari (1h, 6h, 12h, 24h)
                    // Durasi bin 1 jam atau lebih
                    if (binDurationMs >= 3600 * 1000) { 
                        // Tampilkan jam (misal 14:00)
                        label = `${date.getHours().toString().padStart(2, '0')}:00`;
                    } else {
                        // Tampilkan jam:menit
                        label = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }

                } else {
                    // Untuk hari (7d, 30d)
                    // Tampilkan tanggal atau nama hari
                    label = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                }
                labels.push(label);
            }
            
            return { 
                labels: labels, 
                chargeData: chargeBins, 
                // Discharge diplot sebagai nilai NEGATIF untuk bar chart dual-direction
                dischargeData: dischargeBins.map(d => -d), 
                totalChargeWh: totalChargeWh,
                totalDischargeWh: totalDischargeWh
            };
        }

        async function fetchAndRenderGraphs(period) {
            
            const config = PERIOD_CONFIG[period];
            if (!config) return;

            chartStatusElement.textContent = `Memuat data Power ${config.label} dari penyimpanan lokal...`;

            try {
                const durationMs = config.durationMs;
                const numPoints = config.points;
                const startTime = Date.now() - durationMs;
                
                const allLogs = getLocalLogs();
                
                // Filter log berdasarkan waktu
                const filteredLogs = allLogs.filter(log => log.timestamp >= startTime);
                
                // Panggil fungsi agregasi baru
                const aggregatedData = aggregateEnergyData(filteredLogs, durationMs, numPoints);
                
                if (filteredLogs.length === 0) {
                    chartStatusElement.textContent = `Tidak ada data Power yang dicatat dalam ${config.label}.`;
                } else {
                    chartStatusElement.textContent = `Data ${filteredLogs.length} log, diagregasi menjadi ${numPoints} titik (${config.label}).`;
                }

             renderEnergyCharts(aggregatedData, config.label);

            } catch (error) {
                console.error("Gagal mengambil/memproses data grafik Wh dari localStorage:", error);
                chartStatusElement.textContent = `GAGAL memuat grafik: ${error.message}`;
            }
        }
        
        // --- Logic Pindah Tema (Light/Dark Mode) ---
       function updateChartColors(isDark) {
    // Gunakan instance chart tunggal
    if (!whChart) return; 
    
    // Tentukan warna teks dan grid berdasarkan mode
    const textColor = isDark ? '#f3f4f6' : '#1f2937'; // gray-100 atau gray-800
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Update warna untuk chart tunggal
    // Note: Kita hanya perlu memanggil update() setelah mengganti opsi
    whChart.options.plugins.legend.labels.color = textColor; 
    whChart.options.scales.x.ticks.color = textColor;
    whChart.options.scales.y.ticks.color = textColor;
    whChart.options.scales.y.title.color = textColor;
    whChart.options.scales.y.grid.color = gridColor;
    whChart.update();

    // Catatan: Warna latar belakang kontainer diatur oleh kelas Tailwind (bg-gray-50/700)
    // di HTML dan CSS, jadi tidak perlu diubah di sini.
}


        // --- Definisikan SVG di Global Scope (atau di file terpisah) ---

const svgMoon = `
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
    </svg>
`;

const svgSun = `
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
`;

        
        function applyTheme(isDark) {
            const body = document.body;
            
            if (isDark) {
                body.classList.add('dark');
                // Mode Gelap AKTIF -> Tampilkan ikon Bulan (UNICODE)
               if (themeIcon) themeIcon.innerHTML = svgMoon;
            } else {
                body.classList.remove('dark');
                // Mode Terang AKTIF -> Tampilkan ikon Matahari (UNICODE)
                if (themeIcon) themeIcon.innerHTML = svgSun;
            }
            
            // Perbarui warna chart agar sesuai dengan tema baru
            updateChartColors(isDark);
            
            // Panggil selectPeriod untuk menerapkan styling tombol aktif yang benar di mode baru
            selectPeriod(selectedPeriod);
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark');
            const newTheme = isDark ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, newTheme);
            applyTheme(newTheme === 'dark');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Tentukan tema awal: Simpanan lokal > Preferensi sistem > Default (light)
            const initialDark = (savedTheme === 'dark') || (savedTheme === null && prefersDark);
            
            // Ikon akan diatur oleh applyTheme(initialDark)
            
            applyTheme(initialDark);
        }


/**
 * MERENDER SATU GRAFIK BATANG untuk CHARGE (Positif) dan DISCHARGE (Negatif).
 */
function renderEnergyCharts(data, periodLabel) { 
    
    // Update ringkasan angka global
    totalChargeWhElement.textContent = `${data.totalChargeWh.toFixed(3)} Wh`;
    totalDischargeWhElement.textContent = `${data.totalDischargeWh.toFixed(3)} Wh`;

    const ctx = document.getElementById('whCombinedCanvas').getContext('2d');
    
    // Hancurkan instans yang ada
    if (whChart) whChart.destroy();
    
    const isDark = document.body.classList.contains('dark');
    const textColor = isDark ? '#f3f4f6' : '#1f2937'; 
    const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    
    // Data Discharge sudah dibuat NEGATIF di aggregateEnergyData.

    whChart = new Chart(ctx, {
        type: 'bar', 
        data: {
            labels: data.labels, 
            datasets: [
                {
                    label: 'Charge (Energi Masuk)',
                    data: data.chargeData, // Nilai POSITIF
                    backgroundColor: 'rgba(16, 185, 129, 0.8)', // Hijau
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1,
                },
                {
                    label: 'Discharge (Energi Keluar)',
                    data: data.dischargeData, // Nilai NEGATIF dari aggregateEnergyData
                    backgroundColor: 'rgba(239, 68, 68, 0.8)', // Merah
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Penting untuk container h-96
            plugins: {
                legend: {
                    display: true, // Tampilkan legend untuk Charge dan Discharge
                    labels: {
                        color: textColor
                    }
                },
                tooltip: {
                    callbacks: {
                       label: function(context) {
                           const value = Math.abs(context.parsed.y).toFixed(3);
                           return `${context.dataset.label}: ${value} Wh`; 
                       },
                    }
                },
            },
            scales: {
                x: {
                    // Non-stacked di sumbu X (bar Charge dan Discharge berdampingan)
                    grid: { display: false },
                    ticks: { color: textColor }
                },
                y: {
                    // Non-stacked di sumbu Y (karena menggunakan nilai positif/negatif)
                    title: {
                        display: true,
                        text: 'Energi (Wh) - Charge (+), Discharge (-)',
                        color: textColor 
                    },
                    grid: {
                        borderDash: [5, 5],
                        color: gridColor 
                    },
                    ticks: {
                        color: textColor,
                        // Tampilkan label sumbu Y (dengan tanda + atau - untuk menunjukkan arah)
                        callback: function(value) {
                             if (value === 0) return '0.00';
                            return value.toFixed(2);
                        }
                    }
                }
            }
        }
    });
    
    // Pastikan warna chart diperbarui
    updateChartColors(document.body.classList.contains('dark'));
}


      let bmsCache = {
    maxTemp: 0,
    soh: 0,
    relayChg: 1,
    relayDis: 1,
    errorCode: 0
};

        // --- Update Dashboard (Termasuk logic Min/Max baru) ---
/**
 * FUNGSI UTAMA: Update Dashboard
 * Menangani dua jenis paket: 'VA' (Volt/Amp) dan 'PT' (Parameter/Suhu)
 */
function updateDashboard(values, type) {
    if (!values || values.length === 0) return;

    const isDark = document.body.classList.contains('dark');
    const extraParametersContainer = document.getElementById('extra-parameters');

      // --- Logika Perhitungan Waktu Sisa ---
            const remainingCap = values[INDEX_PT.CAP_REMAINING]; // Kapasitas Tersisa (Ah)
            const fullCap = values[INDEX_VA.CAP_MAX];       // Kapasitas Penuh (Ah)
            const current = values[INDEX_VA.CURRENT];       // Arus (A)
            const capToFull = fullCap - remainingCap;           // Kapasitas yang diperlukan untuk penuh (Ah)

            let timeRemainingText;
            let timeToEmptyHours = 0;
            let timeToFullHours = 0;

            let minCellV = Infinity;
            let maxCellV = -Infinity;
            let totalActiveCells = 0;
    
    
    // --- 1. LOGIKA PAKET VA (Update setiap 1 detik) ---
    if (type === 'VA') {
        // Gunakan fallback || 0 agar .toFixed() tidak error jika data undefined
        const currentTotalVoltage = values[INDEX_VA.TOTAL_VOLTAGE] || 0;
        const currentCurrent = values[INDEX_VA.CURRENT] || 0;
        const currentPower = values[INDEX_VA.POWER] || 0;
        const currentSoc = Math.min(100, Math.max(0, values[INDEX_VA.SOC] || 0));
        const capMax = values[INDEX_VA.CAP_MAX] || 0;
        const whNow = values[INDEX_VA.WH_NOW] || 0;
        const whMax = values[INDEX_VA.WH_DESIGN] || 0;

        // A. Update Ringkasan Utama (Atas)
        if (totalVoltageElement) totalVoltageElement.textContent = `${currentTotalVoltage.toFixed(2)} V`;
        if (currentElement) currentElement.textContent = `${currentCurrent.toFixed(2)} A`;
        if (powerElement) powerElement.textContent = `${currentPower.toFixed(2)} W`;
        if (whNowElement) whNowElement.textContent = `${whNow.toFixed(2)} Wh`;
        
        if (socValueElement) {
            socValueElement.textContent = `${currentSoc.toFixed(1)}%`;
            socProgressElement.style.width = `${currentSoc}%`;
        }
        if (remainingCapacityElement) remainingCapacityElement.textContent = `${capMax.toFixed(2)} Ah`;
         if (remainingWhElement) remainingWhElement.textContent = `${whMax.toFixed(2)} Wh`;

        // B. Update Min/Max Trackers
        if (currentTotalVoltage > 1.0) {
            minTotalVoltage = Math.min(minTotalVoltage, currentTotalVoltage);
            maxTotalVoltage = Math.max(maxTotalVoltage, currentTotalVoltage);
            minCurrent = Math.min(minCurrent, currentCurrent);
            maxCurrent = Math.max(maxCurrent, currentCurrent);
            minPower = Math.min(minPower, currentPower);
            maxPower = Math.max(maxPower, currentPower);
        }
        
        if (minMaxVoltageElement) minMaxVoltageElement.textContent = `Min: ${minTotalVoltage === Infinity ? '0.00' : minTotalVoltage.toFixed(2)} V | Max: ${maxTotalVoltage === -Infinity ? '0.00' : maxTotalVoltage.toFixed(2)} V`;
        if (minMaxCurrentElement) minMaxCurrentElement.textContent = `Min: ${minCurrent === Infinity ? '0.00' : minCurrent.toFixed(2)} A | Max: ${maxCurrent === -Infinity ? '0.00' : maxCurrent.toFixed(2)} A`;
        if (minMaxPowerElement) minMaxPowerElement.textContent = `Min: ${minPower === Infinity ? '0.00' : minPower.toFixed(2)} W | Max: ${maxPower === -Infinity ? '0.00' : maxPower.toFixed(2)} W`;

        // C. Update Detail Sel
        const cellVoltages = [
            values[INDEX_VA.CELL_1], values[INDEX_VA.CELL_2],
            values[INDEX_VA.CELL_3], values[INDEX_VA.CELL_4]
        ];

        

        cellVoltages.forEach((v, i) => {
            const cellElement = cellElements[i];
            if (!cellElement) return;
            
            const safeV = v || 0; // Hindari undefined

            if (safeV > 1.0) {
                minCellV = Math.min(minCellV, safeV);
                maxCellV = Math.max(maxCellV, safeV);
                totalActiveCells++;
            }

            let bgClass, textColor;
            if (safeV > 4.2) { bgClass = isDark ? 'bg-red-900' : 'bg-red-200'; textColor = isDark ? 'text-red-300' : 'text-red-800'; }
            else if (safeV > 3.8) { bgClass = isDark ? 'bg-emerald-900' : 'bg-green-100'; textColor = isDark ? 'text-green-300' : 'text-green-800'; }
            else if (safeV < 3.0 && safeV > 1.0) { bgClass = isDark ? 'bg-yellow-900' : 'bg-yellow-100'; textColor = isDark ? 'text-yellow-300' : 'text-yellow-800'; }
            else if (safeV <= 1.0) { bgClass = isDark ? 'bg-gray-800' : 'bg-gray-200'; textColor = 'text-gray-500'; }
            else { bgClass = isDark ? 'bg-gray-700' : 'bg-gray-100'; textColor = isDark ? 'text-gray-100' : 'text-gray-800'; }

            cellElement.className = `p-3 text-center rounded-lg border transition-colors duration-300 ${bgClass} ${isDark ? 'border-gray-600' : 'border-gray-300'}`;
            const textVal = cellElement.querySelector('.text-xl');
            if (textVal) {
                textVal.textContent = (safeV <= 1.0) ? '0.000 V' : `${safeV.toFixed(3)} V`;
                textVal.className = `text-xl font-bold transition-colors duration-300 ${textColor}`;
            }
        });

            const deltaV = (maxCellV !== -Infinity && minCellV !== Infinity) ? (maxCellV - minCellV) * 1000 : 0;
            const deltaVText = totalActiveCells >= 2 ? `${Math.round(deltaV)} mV` : 'N/A';
            const minVText = minCellV !== Infinity ? minCellV.toFixed(3) : '0.000';
            const maxVText = maxCellV !== -Infinity ? maxCellV.toFixed(3) : '0.000';
        
        if (deltaVElement) deltaVElement.textContent = totalActiveCells >= 2 ? `${Math.round(deltaV)} mV` : 'N/A';
        if (summaryMinMaxElement) summaryMinMaxElement.textContent = `Sel Aktif (Total: ${totalActiveCells}) | Min: ${minVText} V | Max: ${maxVText} V | DeltaV: ${deltaVText}`;

      

            // Kasus Arus Nol atau Sangat Kecil
            if (current === 0 || Math.abs(current) < 0.1) {
                timeRemainingText = "Diam";
            } 
            // Kasus Pengisian (Charging)
            else if (current > 0) {
                // Cek kondisi penuh untuk TTF
                if (remainingCap >= fullCap) {
                    timeRemainingText = "Penuh (TTF)";
                } else {
                    // CHARGE (TTF): (Kapasitas Penuh - Kapasitas Sisa) / Arus Charge (Jam)
                    timeToFullHours = capToFull / current;
                    timeRemainingText = formatTime(timeToFullHours) + " (TTF)";
                }
            } 
            // Kasus Pengosongan (Discharging)
            else {
                // Cek kondisi habis untuk TTE
                if (remainingCap <= 0) {
                    timeRemainingText = "Habis (TTE)";
                } else {
                    // DISCHARGE (TTE): Kapasitas Sisa / Nilai Absolut Arus Discharge (Jam)
                    timeToEmptyHours = remainingCap / Math.abs(current);
                    timeRemainingText = formatTime(timeToEmptyHours) + " (TTE)";
                }
            }

            timeRemainingElement.textContent = `Waktu Sisa: ${timeRemainingText}`;

        //updateGlobalCache('VA', values, {deltaV, totalActiveCells, minCellV, maxCellV});
    }

    // --- 2. LOGIKA PAKET PT (Update setiap 3 detik) ---
    else if (type === 'PT') {
        const tempBattery = values[INDEX_PT.TEMP_1] || 0;
        const tempMosfet = values[INDEX_PT.TEMP_2] || 0;
        const currentSoh = values[INDEX_PT.SOH] || 0;
        const capRem = values[INDEX_PT.CAP_REMAINING] || 0;
        const whPos = values[INDEX_PT.WH_POS] || 0;
        const whNeg = values[INDEX_PT.WH_NEG] || 0;
        

        const maxTemp = Math.max(tempBattery, tempMosfet);
        if (tempValueElement) tempValueElement.textContent = `${maxTemp.toFixed(1)}¬∞C`;
        if (sohValueElement) {
            sohValueElement.textContent = `${currentSoh.toFixed(1)}%`;
            sohProgressElement.style.width = `${currentSoh}%`;
        }
        if (capacityUsedElement) capacityUsedElement.textContent = `${capRem.toFixed(2)} Ah`;

        let extraHtml = '';
        ALL_DATA_MAP.filter(d => d.showInExtra && d.packet === 'PT').forEach(dataInfo => {
            const val = values[dataInfo.index] || 0;
            let displayVal, symbolColor, bgColor;
            
            if (dataInfo.label.includes('Relay')) {
                const isActive = val >= 1.0;
                displayVal = isActive ? "AKTIF" : "NONAKTIF";
                symbolColor = isActive ? "text-accent" : "text-gray-400";
                bgColor = isActive ? (isDark ? "bg-green-900/30" : "bg-green-50") : (isDark ? "bg-gray-700" : "bg-gray-50");
            } else {
                displayVal = `${val.toFixed(2)} ${dataInfo.unit}`;
                symbolColor = dataInfo.label.includes('Suhu') ? "text-orange-500" : "text-primary";
                bgColor = isDark ? "bg-gray-700" : "bg-gray-50";
            }

            extraHtml += `
                <div class="p-4 rounded-lg border ${isDark ? 'border-gray-600' : 'border-gray-300'} ${bgColor}">
                    <div class="flex items-center space-x-2 mb-1">
                        <span class="w-5 h-5 ${symbolColor}">${SVG_ICONS[dataInfo.iconKey] || ''}</span>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${dataInfo.label}</p>
                    </div>
                    <p class="text-xl font-bold text-gray-800 dark:text-gray-100">${displayVal}</p>
                </div>`;
        });
        if (extraParametersContainer) extraParametersContainer.innerHTML = extraHtml;

        updateSafetyStatus(maxTemp, currentSoh, values[INDEX_PT.RELAY_CHG], values[INDEX_PT.RELAY_DISCHG]);
        updateGlobalCache('PT', values);
    }

   // --- 3. LOGIKA PAKET ER (PERBAIKAN) ---
// --- 3. LOGIKA PAKET ER (PERBAIKAN ERROR CODE & HISTORY) ---
// --- 3. LOGIKA PAKET ER (DENGAN KETERANGAN ERROR 1-10) ---
else if (type === 'ER') {
    // 1. Ambil data dari array values
    const errorCode = values[INDEX_ER.ERROR_CODE] || 0;
    const history = [
        values[INDEX_ER.HIS_1] || 0,
        values[INDEX_ER.HIS_2] || 0,
        values[INDEX_ER.HIS_3] || 0,
        values[INDEX_ER.HIS_4] || 0,
        values[INDEX_ER.HIS_5] || 0
    ];

    // 2. Simpan ke Cache Global agar tidak tertimpa paket VA/PT
    bmsCache.errorCode = errorCode;

    // 3. Fungsi Mapping (Keterangan Error)
    const getErrorDescription = (code) => {
        const errorMap = {
    0: "Sistem Normal",
    1: "Tegangan Sel di Bawah Ambang Batas (2.5V)",
    3: "Kesalahan Penulisan/Pembacaan Memori EEPROM",
    4: "Proteksi Suhu: Terdeteksi Anomali Suhu Operasional",
    5: "Aktivasi Sistem Trip: Gagal Reaktivasi Deteksi Arus Terpasang",
    6: "Terdeteksi Hubungan Arus Pendek (Short Circuit)",
    7: "Proteksi Arus Berlebih (Overcurrent Detected)",
    8: "Tegangan Baterai Sangat Rendah: Diperlukan Pengisian Daya",
    9: "Proteksi Pengisian: Tegangan Melebihi Batas Aman",
    10: "Tegangan Baterai Rendah: Diperlukan Pengisian Daya"
        };
        return errorMap[code] || `Unknown Error (${code})`;
    };

    const errorText = getErrorDescription(errorCode);

    // 4. Update Status Keselamatan (Bagian Atas)
    // Gunakan bmsCache agar parameter suhu/relay tidak hilang
    if (typeof updateSafetyStatus === 'function') {
        updateSafetyStatus(
            bmsCache.maxTemp, 
            bmsCache.soh, 
            bmsCache.relayChg, 
            bmsCache.relayDis, 
            bmsCache.errorCode
        );
    }

// 5. Generate Tampilan Kartu Riwayat Modern (Minimalis & Terbuka)
let historyHtml = `
    <div class="col-span-full mt-4 p-5 rounded-xl border-2 transition-all ${errorCode > 0 ? 'bg-red-50 border-red-500' : 'bg-gray-50 border-gray-200'}">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center space-x-3">
                <div class="p-2 rounded-lg ${errorCode > 0 ? 'bg-red-600' : 'bg-green-600'} text-white">
                    ${SVG_ICONS['alert'] || '‚ö†Ô∏è'}
                </div>
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-gray-400 leading-none">Status Error</p>
                    <p class="text-sm font-bold ${errorCode > 0 ? 'text-red-600' : 'text-green-600'}">${errorCode > 0 ? errorText : 'Sistem Normal'}</p>
                </div>
            </div>

            <div class="text-right">
                <span class="text-5xl font-mono font-black ${errorCode > 0 ? 'text-red-600 animate-pulse' : 'text-gray-300'}">
                    ${errorCode}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-5 gap-2">
`;

history.forEach((h, i) => {
    const hasError = h > 0;
    const hDescShort = hasError ? getErrorDescription(h).split('(')[0] : 'OK'; // Ambil teks inti saja
    
    historyHtml += `
        <div class="flex flex-col p-2 rounded border transition-all ${hasError ? 'border-red-200 bg-white' : 'border-gray-100 bg-transparent'}">
            <span class="text-[8px] font-black text-gray-400 mb-1 uppercase">Log ${i + 1}</span>
            <span class="text-sm font-mono font-black ${hasError ? 'text-red-600' : 'text-gray-300'} mb-1">
                ${hasError ? 'E' + h : '‚Äî'}
            </span>
            <span class="text-[9px] font-medium leading-tight ${hasError ? 'text-red-500' : 'text-gray-400'}">
                ${hDescShort}
            </span>
        </div>
    `;
});

historyHtml += `</div></div>`;

historyHtml += `
            </div>
        </div>
    </div>
`;

historyHtml += `</div></div></div>`;

historyHtml += `</div></div>`;

    historyHtml += `</div></div>`;

    // 6. Masukkan ke Container
    const container = document.getElementById('error-history-container');
    if (container) {
        container.innerHTML = historyHtml;
    }
}

// --- 7. Kumpulkan dan Simpan Data Dashboard ke lastDashboardData ---
try {
    // Pastikan values tidak kosong sebelum diproses
    if (!values || values.length === 0) {
        console.warn("‚ö†Ô∏è Data values kosong, melewati proses pengumpulan data.");
        return;
    }

   // 1. Ambil snapshot data lama agar nilai dari paket lain tidak hilang
        const oldData = { ...lastDashboardData };

        // 2. Filter data hanya yang berasal dari paket yang masuk saat ini (VA atau PT)
        const incomingDataEntries = ALL_DATA_MAP
            .filter(d => d.packet === type)
            .map(d => [d.key, values[d.index] !== undefined ? values[d.index] : 0]);

    // 3. Gabungkan dengan Data Turunan & Min/Max Global yang Anda berikan
        // Pastikan variabel-variabel seperti minCellV, statusText, dll sudah didefinisikan sebelumnya
        const derivedData = {
            // Data Turunan
            min_cell_voltage: typeof minCellV !== 'undefined' && minCellV !== Infinity ? minCellV : (oldData.min_cell_voltage || 0.0),
            max_cell_voltage: typeof maxCellV !== 'undefined' && maxCellV !== -Infinity ? maxCellV : (oldData.max_cell_voltage || 0.0),
            delta_voltage_mV: typeof deltaV !== 'undefined' ? Math.round(deltaV) : (oldData.delta_voltage_mV || 0),
            safety_status_text: typeof statusText !== 'undefined' ? statusText : (oldData.safety_status_text || "Normal"),
            safety_message: typeof safetyMsg !== 'undefined' ? safetyMsg : (oldData.safety_message || "Semua normal"),
            
            // Data Min/Max Global
            min_total_voltage: minTotalVoltage !== Infinity ? minTotalVoltage : (oldData.min_total_voltage || 0.0),
            max_total_voltage: maxTotalVoltage !== -Infinity ? maxTotalVoltage : (oldData.max_total_voltage || 0.0),
            min_current: minCurrent !== Infinity ? minCurrent : (oldData.min_current || 0.0),
            max_current: maxCurrent !== -Infinity ? maxCurrent : (oldData.max_current || 0.0),
            min_power: minPower !== Infinity ? minPower : (oldData.min_power || 0.0),
            max_power: maxPower !== -Infinity ? maxPower : (oldData.max_power || 0.0),
            
            // Estimasi Waktu
            time_to_empty_hours: (typeof current !== 'undefined' && current < 0) ? timeToEmptyHours : 0.0,
            time_to_full_hours: (typeof current !== 'undefined' && current > 0) ? timeToFullHours : 0.0
        };
    
    lastDashboardData = {
            ...oldData,
            ...derivedData,
            ...Object.fromEntries(incomingDataEntries),
            last_updated: new Date().toISOString(),
    };

   // 4. Kirim ke Firebase (Gunakan update agar tidak menghapus field lain)
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            firebase.database().ref('current_data').update(lastDashboardData)
                .catch(err => console.error("Firebase Update Error:", err));
        }

       

    } catch (e) {
        console.error("‚ùå Error saat menyusun data dashboard:", e);
    }

// 4. Update DOM (Pindahkan ke bagian akhir agar jika upload gagal, UI tetap update)
//safetyStatusSection.className = `status-box mb-6 border ${safetyClass}`;
//safetyStatusSection.classList.remove('hidden'); 
//safetyStatusText.textContent = statusText;
//safetyMessage.textContent = safetyMsg;
  
}

/**
 * Fungsi Pembantu: Kelola Cache Data Terakhir
 */
function updateGlobalCache(type, values, meta = {}) {
 /*    lastDashboardData.timestamp = Date.now();
    lastDashboardData.deviceName = device ? device.name : 'N/A';

  if (type === 'VA') {
    // Pastikan data VA tersedia
    lastDashboardData.total_voltage = values[INDEX_VA.TOTAL_VOLTAGE] ?? 0;
    lastDashboardData.current = values[INDEX_VA.CURRENT] ?? 0;
    lastDashboardData.power = values[INDEX_VA.POWER] ?? 0;
    lastDashboardData.soc = values[INDEX_VA.SOC] ?? 0;
    lastDashboardData.delta_voltage_mV = meta?.deltaV ?? 0;

} else if (type === 'PT') {
    // Pastikan data PT tersedia
    lastDashboardData.temp_battery = values[INDEX_PT.TEMP_1] ?? 0;
    lastDashboardData.soh = values[INDEX_PT.SOH] ?? 0;
    lastDashboardData.capacity_remaining = values[INDEX_PT.CAP_REMAINING] ?? 0;
    lastDashboardData.cycle_count = values[INDEX_PT.CYCLE] ?? 0;

} else if (type === 'ER') {
    // Tangani data ErrorCode
    console.warn("‚ö†Ô∏è Menerima paket ErrorCode:", values);
    // Anda bisa menyimpan error code ke variabel jika perlu
    lastDashboardData.last_error = values[0]; 
    statusMessage.textContent = `Error Code: ${values[0]}`;

} else {
    console.error("‚ùå Tipe data tidak dikenal:", type);
}
    */
}

/**
 * Fungsi Pembantu: Update Safety Status
 */
/**
 * Memperbarui Status Keselamatan di UI
 * @param {number} maxTemp - Suhu tertinggi
 * @param {number} soh - State of Health
 * @param {number} relayChg - Status Relay Charging (1=On, 0=Off)
 * @param {number} relayDis - Status Relay Discharging (1=On, 0=Off)
 * @param {number} errorCode - Kode Error dari paket ER (0-10)
 */
function updateSafetyStatus(maxTemp, soh, relayChg, relayDis, errorCode = 0) {
    const safetyStatusText = document.getElementById('safety-status-text');
    const safetyMessage = document.getElementById('safety-message');
    const safetyStatusSection = document.getElementById('safety-status-section');
    const alarm = document.getElementById('alarmSound');

    if (!safetyStatusText || !safetyMessage) return;

    // --- LOGIKA PENGUNCI (LOCK) ---
    // Gunakan errorCode dari parameter, tapi jika di cache global masih ada error (>0), 
    // maka tetap kunci ke nilai tersebut agar tidak tertimpa data 0 dari paket VA/PT.
    let effectiveError = errorCode;
    if (effectiveError === 0 && bmsCache.errorCode > 0) {
        effectiveError = bmsCache.errorCode;
    }

    let safetyMsg = "Semua parameter dalam batas aman.";
    let statusText = 'Normal';
    let isAnimate = false;

    // Mapping Error
    const getBmsErrorMsg = (code) => {
        const errors = {
    0: "Sistem Normal",
    1: "Tegangan Sel di Bawah Ambang Batas (2.5V)",
    3: "Kesalahan Penulisan/Pembacaan Memori EEPROM",
    4: "Proteksi Suhu: Terdeteksi Anomali Suhu Operasional",
    5: "Aktivasi Sistem Trip: Gagal Reaktivasi Deteksi Arus Terpasang",
    6: "Terdeteksi Hubungan Arus Pendek (Short Circuit)",
    7: "Proteksi Arus Berlebih (Overcurrent Detected)",
    8: "Tegangan Baterai Sangat Rendah: Diperlukan Pengisian Daya",
    9: "Proteksi Pengisian: Tegangan Melebihi Batas Aman",
    10: "Tegangan Baterai Rendah: Diperlukan Pengisian Daya"
        };
        return errors[code] || `BMS Error (${code})`;
    };

    // --- PENENTUAN STATUS ---
    if (effectiveError > 0) {
        // JIKA ADA ERROR (DIKUNCI)
        safetyMsg = `BAHAYA: ${getBmsErrorMsg(effectiveError)}`;
        statusText = `BMS ERROR [${effectiveError}]`;
        isAnimate = true;
    } 
    else if (relayChg === 0 && relayDis === 0) {
        safetyMsg = "BAHAYA KRITIS: Jalur Terputus / Short Circuit!";
        statusText = 'OFFLINE/SHORT!';
        isAnimate = true;
    } 
    else if (maxTemp > 45) {
        safetyMsg = `PERINGATAN: Suhu Tinggi (${maxTemp.toFixed(1)}¬∞C)!`;
        statusText = 'Suhu Panas!';
        isAnimate = true;
    }

    // --- UPDATE UI ---
    safetyStatusText.textContent = statusText;
    safetyMessage.textContent = safetyMsg;
    
    const isDark = document.documentElement.classList.contains('dark');
    let colorClass = isDark ? 'bg-green-900/30 text-green-300 border-green-700' : 'bg-green-100 text-green-700 border-green-200';
    
    if (isAnimate) {
        colorClass = isDark ? 'bg-red-900/40 text-red-300 border-red-600 animate-pulse' : 'bg-red-100 text-red-700 border-red-500 animate-pulse';
    }

    if (safetyStatusSection) {
        safetyStatusSection.className = `p-4 rounded-xl mb-6 border-2 transition-all duration-300 ${colorClass}`;
    }

    // Alarm Logic
    if (isAnimate && alarm) {
        if (alarm.paused) alarm.play().catch(() => {});
    } else if (alarm) {
        alarm.pause();
        alarm.currentTime = 0;
    }

    
}
        
        // --- FUNGSI BARU UNTUK FIREBASE ---

        /**
         * Mengunggah data dashboard real-time ke node /current_data di Firebase.
         * @param {Object} data - Objek data dashboard yang sudah diproses.
         */
        function uploadDataToFirebase(data) {
            if (!firebaseDB) return;

            try {
                // Menggunakan set() untuk menimpa data real-time (last known state)
                firebaseDB.ref('current_data').set(data)
                    .then(() => {
                        // Tidak perlu menampilkan pesan sukses setiap kali, agar konsol bersih
                    })
                    .catch((error) => {
                        console.error("Gagal mengunggah data real-time ke Firebase:", error);
                        document.getElementById('firestore-status').textContent = `Status DB: GAGAL mengunggah real-time: ${error.message.substring(0, 50)}...`;
                    });
            } catch (e) {
                console.error("Error saat mencoba upload data real-time:", e);
            }
        }
        
        /**
         * Mengunggah semua data log historis dari localStorage ke node /history_logs di Firebase.
         */
        function uploadAllLogsToFirebase() {
            if (!firebaseDB) {
                alert("Firebase belum diinisialisasi atau gagal.");
                return;
            }
            
            const logs = getLocalLogs();
            if (logs.length === 0) {
                alert("Tidak ada data log di penyimpanan lokal untuk diunggah.");
                return;
            }
            
            if (!confirm(`Yakin ingin mengunggah ${logs.length} entri log historis ke Firebase? Proses ini mungkin memakan waktu.`)) {
                return;
            }
            
            uploadLogsButton.disabled = true;
            uploadLogsButton.textContent = 'Mengunggah...';

            // Membuat objek logs yang dikunci oleh timestamp untuk Realtime Database
            const logsObject = logs.reduce((acc, log) => {
                // Menggunakan timestamp sebagai kunci (pastikan unik)
                acc[log.timestamp] = log; 
                return acc;
            }, {});
            
            try {
                // Menggunakan set() untuk menimpa semua log historis (atau push() jika ingin menambahkan)
                // Peringatan: Set() akan menimpa seluruh node /history_logs!
                firebaseDB.ref('history_logs').set(logsObject)
                    .then(() => {
                        alert(`Sukses mengunggah ${logs.length} entri log historis ke Firebase!`);
                        document.getElementById('firestore-status').textContent = `Status DB: Upload log historis sukses (${logs.length} entri).`;
                        uploadLogsButton.disabled = false;
                        uploadLogsButton.textContent = 'Upload Log ke Firebase';
                    })
                    .catch((error) => {
                        console.error("Gagal mengunggah log historis ke Firebase:", error);
                        alert(`Gagal mengunggah log historis: ${error.message}`);
                        document.getElementById('firestore-status').textContent = `Status DB: GAGAL mengunggah log historis: ${error.message.substring(0, 50)}...`;
                        uploadLogsButton.disabled = false;
                        uploadLogsButton.textContent = 'Upload Log ke Firebase';
                    });
            } catch (e) {
                console.error("Error saat mencoba upload log historis:", e);
                uploadLogsButton.disabled = false;
                uploadLogsButton.textContent = 'Upload Log ke Firebase';
            }
        }

        /**
 * Mengunggah semua data log historis dari localStorage ke node /history_logs di Firebase
 * secara otomatis, tanpa konfirmasi pengguna (alert/confirm).
 * * @returns {Promise<number>} Promise yang berisi jumlah log yang diunggah jika sukses.
 */
async function autoUploadLogsToFirebase() {
    const firestoreStatus = document.getElementById('firestore-status');
    const logs = getLocalLogs();

    if (!firebaseDB) {
        const errorMsg = "Firebase belum diinisialisasi atau gagal. Upload otomatis dibatalkan.";
        console.error(errorMsg);
        firestoreStatus.textContent = `Status DB: GAGAL. ${errorMsg}`;
        // Lempar error agar pemanggil tahu bahwa proses gagal
        throw new Error(errorMsg); 
    }
    
    if (logs.length === 0) {
        console.log("Tidak ada data log di penyimpanan lokal untuk diunggah secara otomatis.");
        // Beri tahu pemanggil bahwa tidak ada log
        return 0; 
    }

    console.log(`Memulai pengunggahan otomatis ${logs.length} entri log historis ke Firebase...`);
    firestoreStatus.textContent = 'Status DB: Mengunggah log historis secara otomatis...';

    // Membuat objek logs yang dikunci oleh timestamp untuk Realtime Database
    const logsObject = logs.reduce((acc, log) => {
        // Menggunakan timestamp sebagai kunci
        acc[log.timestamp] = log; 
        return acc;
    }, {});
    
    try {
        // Tunggu hingga operasi set() ke Firebase selesai
        await firebaseDB.ref('history_logs').set(logsObject);
        
        console.log(`[SUCCESS] Sukses mengunggah ${logs.length} entri log historis secara otomatis.`);
        
        // Perbarui status UI
        firestoreStatus.textContent = `Status DB: Upload log historis sukses otomatis (${logs.length} entri).`;

        // Kembalikan jumlah log yang diunggah
        return logs.length; 

    } catch (error) {
        console.error("[ERROR] Gagal mengunggah log historis ke Firebase secara otomatis:", error);
        
        // Perbarui status UI dengan pesan error
        const errorDetail = error.message ? error.message.substring(0, 50) : "Kesalahan tidak diketahui";
        firestoreStatus.textContent = `Status DB: GAGAL mengunggah log historis otomatis: ${errorDetail}...`;
        
        // Lempar error agar pemanggil (jika ada) dapat menanganinya
        throw error;
    }
}

        // --- Fungsi Pembungkus yang Aman ---
async function startAutoUploadInterval() {
    // Wakelock (opsional) bisa ditempatkan di sini jika Anda ingin menjamin layar tetap menyala
    // selama proses upload terjadwal, tetapi ini dapat mengganggu pengalaman pengguna.
    
    try {
        const count = await autoUploadLogsToFirebase();
        if (count > 0) {
            console.log(`Upload terjadwal selesai. ${count} entri terkirim.`);
        }
    } catch (error) {
        // Log error, tetapi jangan menghentikan interval berikutnya
        console.error("Upload terjadwal gagal. Akan dicoba lagi nanti.", error);
    } finally {
        // Panggil dirinya sendiri (rekursif) setelah 1 menit jeda.
        // Ini HANYA terjadi setelah blok try/catch selesai.
        setTimeout(startAutoUploadInterval, 60 * 60 * 1000); // 1 menit
    }
}
        // --- END FUNGSI BARU UNTUK FIREBASE ---
        // Simpan referensi interval agar bisa dihentikan jika perlu
        let jamInterval, weatherInterval, statusInterval;

        document.addEventListener('DOMContentLoaded', async () => {
            // Muat tema sebelum memuat data
            loadTheme(); 
            
            const initialValues = Array(28).fill(0.0);

          // Panggil secara spesifik agar struktur HTML terbentuk
           updateDashboard(initialValues);
            
            // Muat grafik awal dari localStorage
            await fetchAndRenderGraphs(selectedPeriod);

          // MULAI interval upload otomatis setelah semua inisialisasi selesai
          // Fungsi ini akan terus berjalan di background tanpa risiko antrian.
          startAutoUploadInterval();

           initNumbers();
           updateJamRealtime();
           // Gunakan pembersihan untuk menghindari duplikasi interval
        clearInterval(jamInterval);
        jamInterval = setInterval(updateJamRealtime, 1000);
        
      

        // 5. Cuaca (10 menit sekali)
        fetchWeatherByGPS();
        clearInterval(weatherInterval);
        weatherInterval = setInterval(fetchWeatherByGPS, 600000);

  

        });





 function pindahKe(halaman) {
   // Cari baris ini dan ubah menjadi:
    const halUtama = document.querySelectorAll('header, section, #grafik-section, .flex.justify-between.items-center.mb-4');
    const halJam = document.getElementById('halaman-jam');
    const btnMonitor = document.getElementById('btn-monitor');
    const btnJam = document.getElementById('btn-jam');

    if (halaman === 'jam') {
        // Sembunyikan Dashboard, Munculkan Jam
        halUtama.forEach(el => el.classList.add('hidden'));
        halJam.classList.remove('hidden');

        // Ubah Warna Tombol Jam jadi Biru (Aktif)
        btnJam.classList.add('bg-blue-500', 'text-white', 'shadow-sm');
        btnJam.classList.remove('text-gray-500', 'dark:text-gray-300');

        // Ubah Warna Tombol Monitor jadi Abu-abu (Pasif)
        btnMonitor.classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        btnMonitor.classList.add('text-gray-500', 'dark:text-gray-300');

       
    } else {


        // Munculkan Dashboard, Sembunyikan Jam
        halUtama.forEach(el => el.classList.remove('hidden'));
        halJam.classList.add('hidden');

        // Ubah Warna Tombol Monitor jadi Biru (Aktif)
        btnMonitor.classList.add('bg-blue-500', 'text-white', 'shadow-sm');
        btnMonitor.classList.remove('text-gray-500', 'dark:text-gray-300');

        // Ubah Warna Tombol Jam jadi Abu-abu (Pasif)
        btnJam.classList.remove('bg-blue-500', 'text-white', 'shadow-sm');
        btnJam.classList.add('text-gray-500', 'dark:text-gray-300');
    }
}
// 1. Inisialisasi Angka 1-12
function initNumbers() {
    const container = document.getElementById('numbers-container');
    for (let i = 1; i <= 12; i++) {
        const num = document.createElement('div');
        num.className = 'number';
        num.style.transform = `rotate(${i * 30}deg)`;
        const span = document.createElement('span');
        span.textContent = i;
        span.style.display = 'inline-block';
        span.style.transform = `rotate(-${i * 30}deg)`;
        num.appendChild(span);
        container.appendChild(num);
    }
}


let weatherData = { temp: "", desc: "", city: "" };

async function fetchWeatherByGPS() {
    const getCoords = () => new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
    });

    try {
        let lat, lon, city = "Lokasi";
        
        // 1. Dapatkan Lokasi (GPS dengan Fallback IP)
        try {
            const pos = await getCoords();
            lat = pos.coords.latitude;
            lon = pos.coords.longitude;
            const revRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const revData = await revRes.json();
            city = revData.address.city || revData.address.town || revData.address.village || "Sekitar Anda";
        } catch (geoError) {
            const lRes = await fetch('https://ipapi.co/json/');
            const lData = await lRes.json();
            lat = lData.latitude; 
            lon = lData.longitude; 
            city = lData.city;
        }

        document.getElementById('city').textContent = city;
        weatherData.city = city;

        // 2. FETCH DATA REALTIME
        // Ubah 'daily=uv_index_max' menjadi 'current=uv_index' agar akurat di malam hari
        const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,uv_index&timezone=auto`);
        const wData = await wRes.json();
        
        const current = wData.current; // Shortcut ke data realtime

        // 3. Update Data Utama
        weatherData.temp = Math.round(current.temperature_2m);
        document.getElementById('temp').textContent = `${weatherData.temp}¬∞C`;
        
        const labels = { 0: "Cerah", 1: "Cerah", 2: "Berawan", 3: "Mendung", 45: "Kabut", 61: "Hujan", 95: "Badai" };
        weatherData.desc = labels[current.weather_code] || "Berawan";
        document.getElementById('weatherDesc').textContent = weatherData.desc;

        // 4. Update Detail Sebelah Kanan (REALTIME)
        document.getElementById('windspeed').textContent = `${current.wind_speed_10m} km/h`;
        document.getElementById('humidity').textContent = `${current.relative_humidity_2m}%`;
        
        // AMBIL UV REALTIME (Bukan Daily Max)
        const uvValue = current.uv_index; 
        const uvEl = document.getElementById('uvIndex');
        
        if (uvEl) {
            uvEl.textContent = uvValue.toFixed(1); // Contoh: 0.0 atau 5.2

            // Warna Indikator UV Realtime
            if (uvValue >= 8) {
                uvEl.style.color = "#ef4444"; // Merah (Bahaya)
            } else if (uvValue >= 3) {
                uvEl.style.color = "#fbbf24"; // Kuning (Sedang)
            } else if (uvValue > 0) {
                uvEl.style.color = "#4ad66d"; // Hijau (Aman)
            } else {
                uvEl.style.color = "#9ca3af"; // Abu-abu (Malam hari / 0)
            }
        }

    } catch (e) {
        console.error("Gagal memperbarui cuaca:", e);
    }
}

// 1. Caching Elemen (Simpan di luar fungsi agar lebih ringan)
const secHand = document.getElementById('sec-hand');
const minHand = document.getElementById('min-hand');
const hourHand = document.getElementById('hour-hand');
const timeDigital = document.getElementById('time-digital');
const timeSeconds = document.getElementById('time-seconds');
const fullDateText = document.getElementById('full-date-text');

function updateJamRealtime() {
    const now = new Date();
    
    const s = now.getSeconds();
    const m = now.getMinutes();
    const h = now.getHours();

    // --- LOGIKA ANALOG ---
    // Optimasi: Gunakan transisi yang tetap, tapi atur 'transform' agar tidak glitch
    const sDeg = (s * 6); // 360/60
    const mDeg = (m * 6) + (s * 0.1); 
    const hDeg = ((h % 12) * 30) + (m * 0.5);

    // Gunakan requestAnimationFrame untuk pergerakan yang lebih mulus jika perlu, 
    // tapi untuk jam 1 detik sekali, cara ini sudah sangat stabil:
    
    // Perbaikan Glitch Detik 0:
    // Jika s == 0, kita bisa mematikan transisi sementara secara singkat
    secHand.style.transition = (s === 0) ? 'none' : 'all 0.1s cubic-bezier(0.1, 2.7, 0.58, 1)';
    
    secHand.style.transform = `translateX(-50%) rotate(${sDeg}deg)`;
    minHand.style.transform = `translateX(-50%) rotate(${mDeg}deg)`;
    hourHand.style.transform = `translateX(-50%) rotate(${hDeg}deg)`;

    // --- LOGIKA DIGITAL ---
    // String template literal cukup efisien
    const jamMenit = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    const detik = String(s).padStart(2, '0');

    // Hanya update teks jika memang berubah (opsional, tapi bagus untuk performa)
    if (timeDigital.textContent !== jamMenit) timeDigital.textContent = jamMenit;
    timeSeconds.textContent = detik;
    
    // Update Tanggal (Hanya perlu diupdate sekali sehari atau saat jam 00:00)
    // Tapi untuk kesederhanaan, biarkan di sini atau cek jika jam === 0
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const tanggalBaru = now.toLocaleDateString('id-ID', options);
    if (fullDateText.textContent !== tanggalBaru) fullDateText.textContent = tanggalBaru;
}


// Tambahkan update status bluetooth ke fungsi updateConnectionUI Anda
function updateConnectionUI(message, deviceName = "") {
    const dot = document.getElementById('dot-status');
    const txt = document.getElementById('text-message');

    if (!dot || !txt) return;

    // Cek apakah pesan mengandung kata "Terkoneksi"
    const isConnected = message.toLowerCase().includes("terkoneksi");

    if (isConnected) {
        // Saat Terkoneksi: Dot Kuning, Teks Kuning
        dot.classList.replace('bg-red-500', 'bg-yellow-400');
        txt.classList.replace('text-gray-500', 'text-yellow-400');
        txt.textContent = deviceName || "CONNECTED";
    } else {
        // Saat Terputus: Dot Merah, Teks Abu-abu
        dot.classList.replace('bg-yellow-400', 'bg-red-500');
        txt.classList.replace('text-yellow-400', 'text-gray-500');
        txt.textContent = "DIS";
    }
}


function toggleFullscreen() {
    const fsText = document.getElementById('fs-text');
    const iconExpand = document.getElementById('icon-expand');

    if (!document.fullscreenElement) {
        // MASUK FULLSCREEN
        const el = document.documentElement;
        if (el.requestFullscreen) el.requestFullscreen();
        else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
        else if (el.msRequestFullscreen) el.msRequestFullscreen();
        
        // Update UI Tombol
        fsText.textContent = "Matikan Layar Penuh";
        fsText.classList.replace('text-gray-300', 'text-red-500');
    } else {
        // KELUAR FULLSCREEN
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        
        // Update UI Tombol
        fsText.textContent = "Aktifkan Layar Penuh";
        fsText.classList.replace('text-red-500', 'text-gray-300');
    }
}

// Tambahkan listener ini agar jika user tekan tombol 'ESC', teks tombol tetap sinkron
document.addEventListener('fullscreenchange', () => {
    const fsText = document.getElementById('fs-text');
    if (!document.fullscreenElement && fsText) {
        fsText.textContent = "Aktifkan Layar Penuh";
        fsText.classList.replace('text-red-500', 'text-gray-300');
    }
});


    </script>
</body>
</html>


