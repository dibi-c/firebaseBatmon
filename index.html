<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitor BMS 3S</title>
    <script src="tailwind.js"></script>
    <style>
        /* Menggunakan font Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* Kartu dasar dengan shadow yang bagus */
        .dashboard-card {
            /* PERHATIAN: Di Dark Mode, warna ini akan ditimpa menjadi bg-gray-800 */
            background-color: #ffffff; 
            border-radius: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        /* Kelas untuk ikon dan nilai utama */
        .value-text {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
        }

        .status-box {
            border-radius: 0.75rem;
            padding: 1rem;
        }

        /* Grid untuk sel tegangan */
        .cell-grid {
            grid-template-columns: repeat(4, 1fr); 
        }

        /* Styling spesifik untuk kartu kelistrikan (Light Mode) */
        .card-voltage { background-color: #bfdbfe; color: #1e40af; } /* blue-200 / blue-800 */
        .card-current { background-color: #fecaca; color: #b91c1c; } /* red-200 / red-800 */
        .card-power { background-color: #fffbeb; color: #b45309; } /* yellow-100 / amber-700 */
        .card-cap-rem { background-color: #e9d5ff; color: #6b21a8; } /* purple-200 / purple-800 */
        .card-cap-used { background-color: #a7f3d0; color: #065f46; } /* teal-2- / teal-800 */
        .card-delta { background-color: #fce7f3; color: #be185d; } /* pink-100 / pink-700 */
        
        /* Styling minimalis untuk koneksi */
        .minimal-connect-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.5rem;
            font-weight: 500;
        }

        /* Style untuk tombol periode aktif */
        .period-active {
            @apply bg-primary text-white shadow-md;
        }
        .period-button {
            @apply p-2 rounded-lg text-sm font-medium transition duration-150 hover:bg-gray-200;
        }

        /* ======================================= */
        /* START: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */
        body {
            /* 1. Gambar sebagai background */
            background-image: url('bms_background.png'); 
            
            /* 2. Properti untuk full-screen, tidak berulang, dan fixed */
            background-size: cover; 
            background-repeat: no-repeat;
            background-attachment: fixed; 
            background-position: center center;
            
            /* Hapus background-color default yang akan menutupi gambar */
            background-color: transparent !important; 
        }

        /* Overlay semi-transparan yang berada di atas gambar tetapi di bawah konten */
        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Warna overlay di Light Mode (abu-abu gelap semi-transparan) */
            background-color: rgba(0, 0, 0, 0.4); 
            z-index: -10; /* Posisikan di bawah semua konten */
            transition: background-color 0.3s;
        }

        /* Warna overlay di Dark Mode (lebih gelap, untuk kontras maksimal) */
        .dark #background-overlay {
            background-color: rgba(0, 0, 0, 0.7); 
        }

        /* Pastikan elemen dashboard-card menggunakan latar putih/gelap agar tidak tembus pandang */
        .dashboard-card {
            /* Pastikan background-color di set ulang di sini */
            background-color: #ffffff; 
            z-index: 1; /* Pastikan konten di atas overlay */
        }
        
        /* Modifikasi untuk tampilan gelap */
        .dark .dashboard-card {
            background-color: #1f2937 !important; 
        }
        /* ======================================= */
        /* END: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */


        /* --- DARK MODE STYLES OVERRIDES: (Selebihnya kode lama) --- */
        
        /* FIX: Aturan CSS Eksplisit untuk body di Dark Mode (untuk mengatasi masalah spesifisitas) */
        body.dark {
            background-color: transparent !important; 
        }
        
        /* Background utama (body) dan background elemen yang lebih terang (bg-gray-50/100/200) */
        .dark .dashboard-card {
            background-color: #1f2937 !important; /* gray-800 */
            box-shadow: none; 
            border: 1px solid #374151; /* Tambahkan border tipis */
        }
        
        /* Header dan elemen yang menggunakan bg-white di Light Mode */
        .dark .bg-white { background-color: #1f2937 !important; } /* gray-800 */
        
        /* FIX: Background elemen yang lebih terang (di sekitar chart, detail sel default, dan kartu detail tambahan) */
        .dark .bg-gray-50, 
        .dark .bg-gray-100, 
        .dark .bg-gray-200 { 
            background-color: #374151 !important; /* gray-700, warna latar belakang yang lebih gelap dari card */
            color: #d1d5db !important; /* text-gray-300 */
        }
        
        /* FIX: Override untuk background hijau Light Mode (Relay ON) */
        .dark .bg-green-50 {
            background-color: #064e3b !important; /* Emerald-900 */
            color: #a7f3d0 !important; /* Emerald-300 */
        }
        
        /* Invert colors for dark mode cards (using darker background and lighter text) */
        .dark .card-voltage { background-color: #1e3a8a !important; color: #93c5fd !important; } 
        .dark .card-current { background-color: #7f1d1d !important; color: #fca5a5 !important; } 
        .dark .card-power { background-color: #78350f !important; color: #fde68a !important; } 
        .dark .card-cap-rem { background-color: #581c87 !important; color: #d8b4fe !important; } 
        .dark .card-cap-used { background-color: #047857 !important; color: #a7f3d0 !important; } 
        .dark .card-delta { background-color: #9d174d !important; color: #f9a8d4 !important; }

        /* Dark mode untuk tombol periode */
        .dark .period-button:not(.period-active) { 
            background-color: #1f2937 !important; /* Darker than the surrounding container */
            color: #d1d5db !important;
        }
        .dark .period-button:not(.period-active):hover { @apply bg-gray-600 !important; }
        
        /* Dark mode untuk border */
        .dark .border-b,
        .dark .border-gray-300 { 
            border-color: #4b5563 !important; /* gray-600 */
        }

        /* Dark mode untuk teks yang lebih lembut */
        .dark .text-gray-400 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #d1d5db !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        
        /* Status Box Warning/Error di Dark Mode */
        .dark .bg-red-100 { background-color: #450a0a !important; color: #fecaca !important; } /* Red-900/Red-300 */
        .dark .bg-yellow-200 { background-color: #422006 !important; color: #fde68a !important; } /* Amber-900/Amber-300 */
        .dark .bg-green-100 { background-color: #064e3b !important; color: #a7f3d0 !important; } /* Emerald-900/Emerald-300 */
        .dark .border-red-400 { border-color: #b91c1c !important; }
        .dark .border-yellow-400 { border-color: #b45309 !important; }
        .dark .border-green-400 { border-color: #065f46 !important; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body class="min-h-screen p-4 md:p-8 bg-gray-50 text-gray-800 dark:text-gray-100 transition-colors duration-300">
    <script>
        // Konfigurasi Tailwind untuk mengaktifkan Dark Mode berdasarkan class="dark" pada body
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // blue-500
                        'accent': '#10b981', // emerald-500
                    }
                }
            }
        }
    </script>
    <div id="background-overlay"></div>
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md border-b">
            <div id="status-display" class="text-sm font-medium text-gray-600 dark:text-gray-400">
                <span id="status-message">Menunggu Koneksi Bluetooth...</span>
                <span id="device-info" class="text-xs text-gray-400 dark:text-gray-600 block italic"></span>
            </div>
            <div class="flex space-x-2">
                <button id="theme-toggle" onclick="toggleTheme()" class="w-10 h-10 p-2 rounded-full flex items-center justify-center bg-gray-200 text-yellow-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-yellow-300 dark:hover:bg-gray-600 transition-all duration-300 shadow-md">
                    <span id="theme-icon" class="text-xl transition-transform duration-300" role="img" aria-label="Dark/Light Mode Toggle"></span>
                </button>
                
                <button id="connect-button" onclick="connectBluetooth()" class="minimal-connect-btn bg-primary text-white hover:bg-blue-600 transition disabled:opacity-50">
                    <span class="mr-1 inline-block align-middle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle">
                            <polyline points="6.5 6.5 17.5 17.5 12 23 12 1 17.5 6.5 6.5 17.5"/>
                        </svg>
                    </span>
                    Sambung
                </button>
                <button id="disconnect-button" onclick="disconnectBluetooth()" class="minimal-connect-btn bg-gray-300 text-gray-700 hover:bg-gray-400 transition disabled:opacity-50 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500" disabled>
                    Putus
                </button>
            </div>
        </header>
        <div class="flex justify-between items-center mb-4">
             <p id="firestore-status" class="text-xs text-gray-500 dark:text-gray-400">Status DB: Penyimpanan Langsung ke Firebase RTDB Aktif.</p>
             <div class="flex space-x-2">
                 <button id="wakelock-toggle" onclick="toggleWakelock()" class="text-xs minimal-connect-btn bg-gray-500 text-white hover:bg-gray-600 transition disabled:opacity-50" title="Kunci layar agar tidak mati saat memantau.">
                    Aktifkan Wakelock
                 </button>
             </div>
        </div>
        
        <div id="error-box" class="status-box mb-6 hidden bg-red-100 text-red-700 border border-red-400">
            <h3 id="error-title" class="font-bold text-xl mb-1">Koneksi Gagal</h3>
            <p class="text-sm" id="error-details">Detail error akan ditampilkan di sini.</p>
        </div>

        <section id="safety-status-section" class="status-box mb-6 hidden bg-green-100 text-green-600 border border-green-400">
            <h3 class="font-bold text-xl mb-1">Status Keselamatan: <span id="safety-status-text">Normal</span></h3>
            <p class="text-sm" id="safety-message">Semua parameter dalam batas aman.</p>
        </section>
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="dashboard-card p-5 border-b-4 border-green-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kapasitas (SOC)</p>
                <p id="soc-value" class="value-text text-green-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soc-progress" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <p id="time-remaining" class="text-xs font-semibold text-gray-500 dark:text-gray-400 mt-2">Waktu Sisa: Menghitung...</p>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-yellow-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kesehatan (SOH)</p>
                <p id="soh-value" class="value-text text-yellow-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soh-progress" class="h-full bg-yellow-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-red-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Suhu (Maks)</p>
                <p id="temp-value" class="value-text text-red-600">0.0°C</p>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Parameter Kelistrikan Inti</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="p-4 rounded-lg card-voltage">
                    <p class="text-sm font-semibold mb-1">Tegangan Total</p>
                    <p id="total-voltage" class="value-text">0.00 V</p>
                    <p id="min-max-voltage" class="text-xs font-medium mt-1">Min: 0.00 V | Max: 0.00 V</p>
                </div>
                <div class="p-4 rounded-lg card-current">
                    <p class="text-sm font-semibold mb-1">Arus</p>
                    <p id="current-value" class="value-text">0.00 A</p>
                    <p id="min-max-current" class="text-xs font-medium mt-1">Min: 0.00 A | Max: 0.00 A</p>
                </div>
                <div class="p-4 rounded-lg card-power">
                    <p class="text-sm font-semibold mb-1">Daya</p>
                    <p id="power-value" class="value-text">0.00 W</p>
                    <p id="min-max-power" class="text-xs font-medium mt-1">Min: 0.00 W | Max: 0.00 W</p>
                </div>
                <div class="p-4 rounded-lg card-cap-rem">
                    <p class="text-sm font-semibold mb-1">Kapasitas Pabrik</p>
                    <p id="remaining-capacity" class="value-text">0 Ah</p>
                </div>
                <div class="p-4 rounded-lg card-cap-used">
                    <p class="text-sm font-semibold mb-1">Kapasitas Sisa</p>
                    <p id="capacity-used-value" class="value-text">0 Ah</p>
                </div>
                <div class="p-4 rounded-lg card-delta">
                    <p class="text-sm font-semibold mb-1">DeltaV Sel Aktif</p>
                    <p id="delta-v-value" class="value-text">0 mV</p>
                </div>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Profil Energi (Wh) untuk Periode Aktif</h2>
            
            <div class="flex flex-wrap justify-center space-x-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
                <button id="period-1h" onclick="selectPeriod('1h')" class="period-button period-active">1 Jam</button>
                <button id="period-6h" onclick="selectPeriod('6h')" class="period-button">6 Jam</button>
                <button id="period-12h" onclick="selectPeriod('12h')" class="period-button">12 Jam</button>
                <button id="period-24h" onclick="selectPeriod('24h')" class="period-button">24 Jam</button>
                <button id="period-7d" onclick="selectPeriod('7d')" class="period-button">7 Hari</button>
                <button id="period-30d" onclick="selectPeriod('30d')" class="period-button">30 Hari</button>
            </div>
            
            <p id="chart-status" class="text-sm text-center text-gray-500 dark:text-gray-400 mb-4">Memuat log dari Firebase...</p>
            <div class="relative h-96">
                <canvas id="whChart"></canvas>
            </div>
            
            <div class="flex justify-around mt-4 text-center font-bold">
                <p class="text-green-600 dark:text-green-400">Energi Masuk: <span id="total-charge-wh">0.000 Wh</span></p>
                <p class="text-red-600 dark:text-red-400">Energi Keluar: <span id="total-discharge-wh">0.000 Wh</span></p>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Detail Tegangan Sel (S1-S4)</h2>
            <div id="cell-voltage-detail" class="grid cell-grid gap-4">
                <div id="cell-1" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 1</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-2" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 2</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-3" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 3</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-4" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 4</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
            </div>
            <p id="balancing-status" class="text-sm text-center font-medium mt-4 text-gray-500 dark:text-gray-400">Sel Min: 0.00 V | Sel Max: 0.00 V | DeltaV: 0 mV</p>
            
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 my-4 border-b pb-2">Detail Parameter Tambahan</h2>
            <div id="extra-parameters" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                </div>
        </section>

        <footer>
            <p class="text-center text-xs text-gray-500 dark:text-gray-600 mt-8">BMS Monitor & Uploader - Versi Firebase Langsung</p>
        </footer>
    </div>

    <script>
        // ===========================================
        // START: KONFIGURASI BLUETOOTH & FIREBASE
        // ===========================================
        const SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb';
        const RX_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';
        const TX_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb'; // Asumsi RX=TX

        const FIREBASE_CONFIG = {
            // Ganti ini dengan konfigurasi Firebase Anda yang sebenarnya
            apiKey: "YOUR_API_KEY", 
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        firebase.initializeApp(FIREBASE_CONFIG);
        const firebaseDB = firebase.database();
        const REALTIME_REF = firebaseDB.ref('latest_dashboard_data');
        // REF BARU UNTUK LOG HISTORIS
        const HISTORICAL_REF = firebaseDB.ref('historical_power_logs');

        // ... Variabel dan Konstanta Lainnya (tetap sama) ...
        const EXPECTED_LENGTH = 70; // 70 byte
        const LOG_INTERVAL_MS = 60000; // Interval untuk refresh grafik (1 menit)
        const BMS_LOG_INTERVAL_MS = 60000; // Interval log yang dipakai oleh BMS (perlu disamakan dengan hardware)

        let device = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let dataBuffer = new ArrayBuffer(0);
        let requestInterval = null;
        let lastLogTime = 0;
        let whChart = null;
        let selectedPeriod = '1h';
        let wakeLockSentinel = null; 
        
        // ... (SVG_ICONS dan DATA_INDICES tetap sama) ...
        const SVG_ICONS = { 
            // Thermometer (Suhu)
            THERMOMETER: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
            // Heart (Kesehatan SOH)
            HEART: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
            // Flash (Relay)
            FLASH: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            // Flame (Balancing)
            FLAME: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM15 15.5A2.5 2.5 0 0 0 17.5 13c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5z"/><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>',
        };
        const DATA_INDICES = {
            START_BYTE: 0, 
            TOTAL_VOLTAGE: 1, 
            CURRENT: 2, 
            POWER: 3, 
            CELL_1: 4, 
            CELL_2: 5, 
            CELL_3: 6, 
            CELL_4: 7, 
            SOC: 8, 
            TEMP_BATTERY: 9, 
            TEMP_MOSFET: 10, 
            CAP_REMAINING: 11, // Kapasitas Tersisa
            SOH_CHARGE: 12, 
            SOH_DISCHARGE: 13, 
            RELAY_CHARGE: 14, 
            RELAY_DISCHARGE: 15, 
            CAP_MAX: 16, // Kapasitas Pabrik
            CHECK_SUM: 69
        };
        const ALL_DATA_MAP = [
            { label: 'Tegangan Total', unit: 'V', index: 1, showInExtra: false },
            { label: 'Arus', unit: 'A', index: 2, showInExtra: false },
            { label: 'Daya', unit: 'W', index: 3, showInExtra: false },
            { label: 'Sel 1', unit: 'V', index: 4, showInExtra: false },
            { label: 'Sel 2', unit: 'V', index: 5, showInExtra: false },
            { label: 'Sel 3', unit: 'V', index: 6, showInExtra: false },
            { label: 'Sel 4', unit: 'V', index: 7, showInExtra: false },
            { label: 'SOC (State of Charge)', unit: '%', index: 8, showInExtra: false, key: 'soc' },
            { label: 'Suhu Baterai', unit: '°C', index: 9, showInExtra: true, iconKey: 'THERMOMETER', key: 'temp_battery' },
            { label: 'Suhu Mosfet', unit: '°C', index: 10, showInExtra: true, iconKey: 'THERMOMETER', key: 'temp_mosfet' },
            { label: 'Kapasitas Tersisa (Remaining)', unit: 'Ah', index: 11, showInExtra: false, key: 'capacity_remaining' },
            { label: 'SOH Pengisian', unit: '%', index: 12, showInExtra: true, iconKey: 'HEART', key: 'soh_charge' },
            { label: 'SOH Pengurasan', unit: '%', index: 13, showInExtra: true, iconKey: 'HEART', key: 'soh_discharge' },
            { label: 'Relay Pengisian', unit: '', index: 14, showInExtra: true, iconKey: 'FLASH', key: 'relay_charge' },
            { label: 'Relay Pengurasan', unit: '', index: 15, showInExtra: true, iconKey: 'FLASH', key: 'relay_discharge' },
            { label: 'Kapasitas Pabrik', unit: 'Ah', index: 16, showInExtra: false, key: 'capacity_max' },
        ];
        
        // ... (UI element variables tetap sama) ...
        const statusMessage = document.getElementById('status-message');
        const deviceInfo = document.getElementById('device-info');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const errorBox = document.getElementById('error-box');
        const errorDetails = document.getElementById('error-details');
        // Hapus: const uploadLogsButton = document.getElementById('upload-logs-button'); 
        const wakelockToggle = document.getElementById('wakelock-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const cellElements = [ 
            document.getElementById('cell-1'), 
            document.getElementById('cell-2'), 
            document.getElementById('cell-3'), 
            document.getElementById('cell-4'), 
        ];
        const totalVoltageElement = document.getElementById('total-voltage');
        const minMaxVoltageElement = document.getElementById('min-max-voltage');
        const currentElement = document.getElementById('current-value');
        const minMaxCurrentElement = document.getElementById('min-max-current');
        const powerElement = document.getElementById('power-value');
        const minMaxPowerElement = document.getElementById('min-max-power');
        const capacityUsedElement = document.getElementById('capacity-used-value');
        const remainingCapacityElement = document.getElementById('remaining-capacity');
        const deltaVElement = document.getElementById('delta-v-value');
        const socValueElement = document.getElementById('soc-value');
        const sohValueElement = document.getElementById('soh-value');
        const tempValueElement = document.getElementById('temp-value');
        const socProgress = document.getElementById('soc-progress');
        const sohProgress = document.getElementById('soh-progress');
        const safetyStatusSection = document.getElementById('safety-status-section');
        const safetyStatusText = document.getElementById('safety-status-text');
        const safetyMessage = document.getElementById('safety-message');
        const timeRemainingElement = document.getElementById('time-remaining');
        const extraParametersElement = document.getElementById('extra-parameters');
        const chartStatusElement = document.getElementById('chart-status');
        const totalChargeWhElement = document.getElementById('total-charge-wh');
        const totalDischargeWhElement = document.getElementById('total-discharge-wh');

        let minTotalVoltage = Infinity; let maxTotalVoltage = -Infinity;
        let minCurrent = Infinity; let maxCurrent = -Infinity;
        let minPower = Infinity; let maxPower = -Infinity;
        // ===========================================
        // END: KONFIGURASI BLUETOOTH & FIREBASE
        // ===========================================

        // ===========================================
        // START: FUNGSI FIREBASE (MODIFIED)
        // ===========================================

        /**
         * Mengirim notifikasi status koneksi ke Firebase (Opsional, untuk monitoring jarak jauh).
         */
        function logNotificationToFirebase(type, message) {
             if (!firebaseDB) return;
             firebaseDB.ref('notifications').push({
                 timestamp: Date.now(),
                 type: type,
                 message: message
             }).catch(e => console.error("Gagal log notifikasi ke Firebase:", e));
        }

        /**
         * Mengunggah data real-time (dashboard utama) ke Firebase.
         * @param {Array<number>} data - Array data yang sudah di-parse.
         */
        function logRealtimeDataToFirebase(data) {
             if (!firebaseDB) return;
             try {
                 // Gunakan set untuk menimpa data real-time terakhir
                 REALTIME_REF.set(data);
             } catch (e) {
                 console.error("Gagal mengunggah data real-time ke Firebase:", e);
             }
        }

        /**
         * Menyimpan log daya/energi historis secara langsung ke Firebase.
         * Dipanggil ketika interval log (60 detik) terpenuhi.
         * @param {number} timestamp - Waktu log dalam milidetik Unix.
         * @param {number} power_W - Daya (Watt) saat itu.
         * @param {number} wh_charge - Wh Charge yang diakumulasikan (dari parsing data/state).
         * @param {number} wh_discharge - Wh Discharge yang diakumulasikan.
         */
        async function saveHistoricalLogToFirebase(timestamp, power_W, wh_charge, wh_discharge) {
            try {
                // Gunakan tanggal sebagai sub-node untuk pengindeksan yang lebih baik dan kueri harian
                const dateKey = new Date(timestamp).toISOString().split('T')[0]; // Format: YYYY-MM-DD
                const logEntry = {
                    timestamp: timestamp,
                    power_W: power_W.toFixed(2),
                    Wh_Charge: wh_charge.toFixed(3),
                    Wh_Discharge: wh_discharge.toFixed(3)
                };

                // Menggunakan .push() untuk membuat entri unik baru di bawah sub-node tanggal
                await HISTORICAL_REF.child(dateKey).push(logEntry);
                console.log("Historical log saved directly to Firebase:", logEntry);
                lastLogTime = timestamp; // Update waktu log terakhir

                // Refresh grafik setelah log baru disimpan
                fetchAndRenderGraphs(selectedPeriod);

            } catch (error) {
                console.error("Error saving historical log to Firebase:", error);
                errorDetails.textContent = `Gagal menyimpan log historis ke Firebase: ${error.message}`;
                errorBox.classList.remove('hidden');
            }
        }
        
        // FUNGSI INI DIHAPUS: uploadAllLogsToFirebase() 

        // ===========================================
        // END: FUNGSI FIREBASE (MODIFIED)
        // ===========================================


        // ===========================================
        // START: FUNGSI PARSING & BLUETOOTH (Minimal)
        // ===========================================

        function calculateChecksum(dataView) { 
            let checksum = 0;
            for (let i = 1; i < EXPECTED_LENGTH - 1; i++) {
                checksum ^= dataView.getUint8(i);
            }
            return checksum;
        }

        function parseData(dataView) {
            if (dataView.byteLength !== EXPECTED_LENGTH || dataView.getUint8(0) !== 0xAA) {
                 return null; 
            }
            const calculatedChecksum = calculateChecksum(dataView);
            const receivedChecksum = dataView.getUint8(EXPECTED_LENGTH - 1);
            if (calculatedChecksum !== receivedChecksum) {
                errorDetails.textContent = `[Parsing Gagal] Checksum Error. Dihitung: ${calculatedChecksum} | Diterima: ${receivedChecksum}`;
                errorBox.classList.remove('hidden');
                return null;
            }

            const values = [];
            for (let i = 1; i <= 16; i++) {
                // Semua data diasumsikan Float32 (4 byte)
                // Offset dihitung: index data * 4 + 1 (melewati start byte)
                // Endianness Little-Endian (false)
                values.push(dataView.getFloat32(i * 4 - 3, true));
            }
            return values;
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const newBuffer = value.buffer.slice(value.byteOffset, value.byteOffset + value.byteLength);
            
            // Gabungkan buffer lama dan baru
            const tempArray = new Uint8Array(dataBuffer.byteLength + newBuffer.byteLength);
            tempArray.set(new Uint8Array(dataBuffer), 0);
            tempArray.set(new Uint8Array(newBuffer), dataBuffer.byteLength);
            dataBuffer = tempArray.buffer;

            // Proses semua paket data 70 byte yang lengkap
            while (dataBuffer.byteLength >= EXPECTED_LENGTH) {
                // Cari start byte (0xAA)
                const tempView = new DataView(dataBuffer);
                let startByteIndex = -1;
                for (let i = 0; i <= dataBuffer.byteLength - EXPECTED_LENGTH; i++) {
                    if (tempView.getUint8(i) === 0xAA) {
                        startByteIndex = i;
                        break;
                    }
                }

                if (startByteIndex === -1) {
                    // Start byte tidak ditemukan dalam sisa buffer, buang semua
                    dataBuffer = new ArrayBuffer(0);
                    break;
                }

                // Buang byte yang tidak valid sebelum start byte
                if (startByteIndex > 0) {
                    dataBuffer = dataBuffer.slice(startByteIndex);
                    startByteIndex = 0;
                }

                // Cek apakah dataBuffer memiliki panjang yang cukup setelah start byte
                if (dataBuffer.byteLength < EXPECTED_LENGTH) {
                    break; // Tunggu paket lengkap
                }

                const dataToParse = dataBuffer.slice(0, EXPECTED_LENGTH);
                const dataView = new DataView(dataToParse);
                const parsedValues = parseData(dataView);
                
                if (parsedValues) {
                    updateDashboard(parsedValues);
                    logRealtimeDataToFirebase(parsedValues);
                    
                    // --- LOGIKA PENYIMPANAN LOG HISTORIS (MODIFIED) ---
                    const currentPower = parsedValues[DATA_INDICES.POWER];
                    // Asumsi: Kita perlu menyimpan Wh_Charge dan Wh_Discharge untuk grafik
                    // Dalam implementasi nyata, Wh_Charge/Discharge harus dihitung/diambil dari parsedValues
                    // Untuk contoh ini, kita asumsikan nilainya ada di index 17 dan 18 (di luar 1-16)
                    // Karena struktur data aslinya hanya 16 data, kita gunakan 0.000 sebagai placeholder
                    const whChargePlaceholder = 0.000;
                    const whDischargePlaceholder = 0.000;

                    const now = Date.now();
                    
                    // Hanya simpan log historis jika sudah melewati interval log (mis. 1 menit)
                    if ((now - lastLogTime) >= BMS_LOG_INTERVAL_MS) {
                        // Memanggil fungsi penyimpanan log yang langsung ke Firebase
                        saveHistoricalLogToFirebase(now, currentPower, whChargePlaceholder, whDischargePlaceholder);
                    }
                    
                    statusMessage.textContent = `Terkoneksi | Data terakhir diterima dari BMS.`;
                    errorBox.classList.add('hidden'); // Sembunyikan error jika parsing berhasil

                } else {
                    statusMessage.textContent = `Terkoneksi | Data diterima, namun gagal diuraikan (Lihat Detail Kesalahan).`;
                }

                // Hapus data yang telah diproses dari buffer
                dataBuffer = dataBuffer.slice(EXPECTED_LENGTH);
            }
        }
        
        // ... (Fungsi connectBluetooth, disconnectBluetooth, onDisconnected tetap sama) ...
        async function connectBluetooth() { /* ... implementation ... */ }
        async function disconnectBluetooth() { /* ... implementation ... */ }
        function onDisconnected() { /* ... implementation ... */ }


        // ===========================================
        // END: FUNGSI PARSING & BLUETOOTH
        // ===========================================

        // ===========================================
        // START: FUNGSI GRAFIK & DATA AGGREGASI (MODIFIED)
        // ===========================================

        // PERIODE KONFIGURASI (TETAP SAMA)
        const PERIOD_CONFIG = { /* ... configuration ... */ };
        
        /**
         * Mengambil data log dari Firebase dan merender grafik.
         * (MODIFIED: Mengambil data dari Firebase RTDB)
         */
        async function fetchAndRenderGraphs(periodKey) {
            const config = PERIOD_CONFIG[periodKey];
            const durationMs = config.durationMs;
            const numPoints = config.points;
            
            chartStatusElement.textContent = `Memuat log Wh untuk ${config.label} dari Firebase...`;

            try {
                // Ambil semua log
                const snapshot = await HISTORICAL_REF.once('value');
                const allLogsArray = [];
                
                // Iterasi melalui data yang distrukturkan per tanggal
                snapshot.forEach(dateNode => {
                    dateNode.forEach(logNode => {
                        const log = logNode.val();
                        // Pastikan timestamp ada dan valid
                        if (log && typeof log.timestamp === 'number') {
                            allLogsArray.push(log);
                        }
                    });
                });
                
                // Urutkan berdasarkan timestamp
                allLogsArray.sort((a, b) => a.timestamp - b.timestamp);

                const startTime = Date.now() - durationMs;
                // Filter log berdasarkan waktu
                const filteredLogs = allLogsArray.filter(log => log.timestamp >= startTime);
                
                const aggregatedData = aggregateEnergyData(filteredLogs, durationMs, numPoints);

                // Update total Wh di bawah grafik
                totalChargeWhElement.textContent = aggregatedData.totalChargeWh.toFixed(3) + ' Wh';
                totalDischargeWhElement.textContent = aggregatedData.totalDischargeWh.toFixed(3) + ' Wh';
                
                if (filteredLogs.length === 0) {
                    chartStatusElement.textContent = `Tidak ada log daya yang tercatat dalam ${config.label} di Firebase.`;
                } else {
                    chartStatusElement.textContent = `Data ${filteredLogs.length} log dari Firebase, diagregasi menjadi ${numPoints} titik (${config.label}).`;
                }
                
                renderEnergyCharts(aggregatedData, config.label);
                
            } catch (error) {
                console.error("Gagal mengambil/memproses data grafik Wh dari Firebase:", error);
                chartStatusElement.textContent = `GAGAL memuat grafik dari Firebase: ${error.message}`;
            }
        }

        /**
         * Mengelompokkan log Power (W) yang diambil dari Firebase
         * @param {Array<object>} logs - Array log dari Firebase.
         */
        function aggregateEnergyData(logs, durationMs, numPoints) {
            // ... (Logika Agregasi Tetap Sama) ...
            if (logs.length === 0 || numPoints === 0) {
                 return { labels: Array(numPoints).fill('N/A'), chargeData: Array(numPoints).fill(0), dischargeData: Array(numPoints).fill(0), totalChargeWh: 0, totalDischargeWh: 0 };
             }
            
            const binDurationMs = durationMs / numPoints;
            const now = Date.now();
            const startTime = now - durationMs;
            const chargeBins = Array(numPoints).fill(0);
            const dischargeBins = Array(numPoints).fill(0);
            const labels = [];
            let totalChargeWh = 0;
            let totalDischargeWh = 0;
            
            const timeIntervalHours = BMS_LOG_INTERVAL_MS / (1000 * 3600); 

            logs.forEach(log => {
                if (log.timestamp >= startTime) {
                    let binIndex = Math.floor((log.timestamp - startTime) / binDurationMs);
                    if (binIndex >= numPoints) {
                        binIndex = numPoints - 1;
                    } else if (binIndex < 0) {
                        return; 
                    }
                    
                    // Asumsi: log.power_W adalah nilai daya. Kita harus mengkonversinya ke Wh (Daya * Interval Waktu)
                    const powerW = parseFloat(log.power_W);
                    const chargeWh = powerW > 0 ? powerW * timeIntervalHours : 0;
                    const dischargeWh = powerW < 0 ? Math.abs(powerW * timeIntervalHours) : 0;
                    
                    chargeBins[binIndex] += chargeWh;
                    dischargeBins[binIndex] += dischargeWh;
                    totalChargeWh += chargeWh;
                    totalDischargeWh += dischargeWh;
                }
            });

            // Membuat label waktu untuk setiap bin
            for (let i = 0; i < numPoints; i++) {
                const timeMs = startTime + (i * binDurationMs);
                const date = new Date(timeMs);
                if (durationMs <= 24 * 3600 * 1000) {
                    // Tampilkan Jam:Menit
                    labels.push(date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }));
                } else {
                    // Tampilkan Tanggal
                    labels.push(date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }));
                }
            }

            return {
                labels: labels,
                chargeData: chargeBins,
                dischargeData: dischargeBins.map(wh => -wh), // Discharge sebagai nilai negatif
                totalChargeWh: totalChargeWh,
                totalDischargeWh: totalDischargeWh
            };
        }
        
        // ... (Fungsi updateDashboard, selectPeriod, renderEnergyCharts, updateChartColors, Theme logic, Wakelock logic tetap sama) ...

        document.addEventListener('DOMContentLoaded', async () => {
            loadTheme(); 
            const initialValues = Array(17).fill(0.0);
            updateDashboard(initialValues);
            
            if (!('wakeLock' in navigator)) {
                 if (wakelockToggle) {
                     wakelockToggle.disabled = true;
                     wakelockToggle.textContent = 'Wakelock Tidak Didukung';
                 }
            }
            
            // Muat grafik awal dari Firebase
            await fetchAndRenderGraphs(selectedPeriod);
        });

        // ===========================================
        // SISA FUNGSI YANG TIDAK BERUBAH DARI FILE ASLI: 
        // updateDashboard, selectPeriod, renderEnergyCharts, updateChartColors, 
        // Theme logic, Wakelock logic
        // (Tidak ditampilkan di sini untuk menghemat ruang, tetapi diasumsikan tetap sama)
        // ===========================================
    </script>
</body>
</html>
