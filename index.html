<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitor BMS 3S</title>
    <script src="tailwind.js"></script>
    <style>
        /* Menggunakan font Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* Kartu dasar dengan shadow yang bagus */
        .dashboard-card {
            /* PERHATIAN: Di Dark Mode, warna ini akan ditimpa menjadi bg-gray-800 */
            background-color: #ffffff; 
            border-radius: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        /* Kelas untuk ikon dan nilai utama */
        .value-text {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
        }

        .status-box {
            border-radius: 0.75rem;
            padding: 1rem;
        }

        /* Grid untuk sel tegangan */
        .cell-grid {
            grid-template-columns: repeat(4, 1fr); 
        }

        /* Styling spesifik untuk kartu kelistrikan (Light Mode) */
        .card-voltage { background-color: #bfdbfe; color: #1e40af; } /* blue-200 / blue-800 */
        .card-current { background-color: #fecaca; color: #b91c1c; } /* red-200 / red-800 */
        .card-power { background-color: #fffbeb; color: #b45309; } /* yellow-100 / amber-700 */
        .card-cap-rem { background-color: #e9d5ff; color: #6b21a8; } /* purple-200 / purple-800 */
        .card-cap-used { background-color: #a7f3d0; color: #065f46; } /* teal-2- / teal-800 */
        .card-delta { background-color: #fce7f3; color: #be185d; } /* pink-100 / pink-700 */
        
        /* Styling minimalis untuk koneksi */
        .minimal-connect-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem; /* text-sm */
            border-radius: 0.5rem;
            font-weight: 500;
        }

        /* Style untuk tombol periode aktif */
        .period-active {
            @apply bg-primary text-white shadow-md;
        }
        .period-button {
            @apply p-2 rounded-lg text-sm font-medium transition duration-150 hover:bg-gray-200;
        }

        /* ======================================= */
        /* START: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */
        body {
            /* 1. Gambar sebagai background */
            background-image: url('bms_background.png'); 
            
            /* 2. Properti untuk full-screen, tidak berulang, dan fixed */
            background-size: cover; 
            background-repeat: no-repeat;
            background-attachment: fixed; 
            background-position: center center;
            
            /* Hapus background-color default yang akan menutupi gambar */
            background-color: transparent !important; 
        }

        /* Overlay semi-transparan yang berada di atas gambar tetapi di bawah konten */
        #background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Warna overlay di Light Mode (abu-abu gelap semi-transparan) */
            background-color: rgba(0, 0, 0, 0.4); 
            z-index: -10; /* Posisikan di bawah semua konten */
            transition: background-color 0.3s;
        }

        /* Warna overlay di Dark Mode (lebih gelap, untuk kontras maksimal) */
        .dark #background-overlay {
            background-color: rgba(0, 0, 0, 0.7); 
        }

        /* Pastikan elemen dashboard-card menggunakan latar putih/gelap agar tidak tembus pandang */
        .dashboard-card {
            /* Pastikan background-color di set ulang di sini */
            background-color: #ffffff; 
            z-index: 1; /* Pastikan konten di atas overlay */
        }
        
        /* Modifikasi untuk tampilan gelap */
        .dark .dashboard-card {
            background-color: #1f2937 !important; 
        }
        /* ======================================= */
        /* END: BACKGROUND GAMBAR PNG & OVERLAY */
        /* ======================================= */


        /* --- DARK MODE STYLES OVERRIDES: (Selebihnya kode lama) --- */
        
        /* FIX: Aturan CSS Eksplisit untuk body di Dark Mode (untuk mengatasi masalah spesifisitas) */
        body.dark {
            background-color: transparent !important; 
        }
        
        /* Background utama (body) dan background elemen yang lebih terang (bg-gray-50/100/200) */
        .dark .dashboard-card {
            background-color: #1f2937 !important; /* gray-800 */
            box-shadow: none; 
            border: 1px solid #374151; /* Tambahkan border tipis */
        }
        
        /* Header dan elemen yang menggunakan bg-white di Light Mode */
        .dark .bg-white { background-color: #1f2937 !important; } /* gray-800 */
        
        /* FIX: Background elemen yang lebih terang (di sekitar chart, detail sel default, dan kartu detail tambahan) */
        .dark .bg-gray-50, 
        .dark .bg-gray-100, 
        .dark .bg-gray-200 { 
            background-color: #374151 !important; /* gray-700, warna latar belakang yang lebih gelap dari card */
            color: #d1d5db !important; /* text-gray-300 */
        }
        
        /* FIX: Override untuk background hijau Light Mode (Relay ON) */
        .dark .bg-green-50 {
            background-color: #064e3b !important; /* Emerald-900 */
            color: #a7f3d0 !important; /* Emerald-300 */
        }
        
        /* Invert colors for dark mode cards (using darker background and lighter text) */
        .dark .card-voltage { background-color: #1e3a8a !important; color: #93c5fd !important; } 
        .dark .card-current { background-color: #7f1d1d !important; color: #fca5a5 !important; } 
        .dark .card-power { background-color: #78350f !important; color: #fde68a !important; } 
        .dark .card-cap-rem { background-color: #581c87 !important; color: #d8b4fe !important; } 
        .dark .card-cap-used { background-color: #047857 !important; color: #a7f3d0 !important; } 
        .dark .card-delta { background-color: #9d174d !important; color: #f9a8d4 !important; }

        /* Dark mode untuk tombol periode */
        .dark .period-button:not(.period-active) { 
            background-color: #1f2937 !important; /* Darker than the surrounding container */
            color: #d1d5db !important;
        }
        .dark .period-button:not(.period-active):hover { @apply bg-gray-600 !important; }
        
        /* Dark mode untuk border */
        .dark .border-b,
        .dark .border-gray-300 { 
            border-color: #4b5563 !important; /* gray-600 */
        }

        /* Dark mode untuk teks yang lebih lembut */
        .dark .text-gray-400 { color: #9ca3af !important; }
        .dark .text-gray-500 { color: #d1d5db !important; }
        .dark .text-gray-800 { color: #f3f4f6 !important; }
        .dark .text-gray-900 { color: #f9fafb !important; }
        
        /* Status Box Warning/Error di Dark Mode */
        .dark .bg-red-100 { background-color: #450a0a !important; color: #fecaca !important; } /* Red-900/Red-300 */
        .dark .bg-yellow-200 { background-color: #422006 !important; color: #fde68a !important; } /* Amber-900/Amber-300 */
        .dark .bg-green-100 { background-color: #064e3b !important; color: #a7f3d0 !important; } /* Emerald-900/Emerald-300 */
        .dark .border-red-400 { border-color: #b91c1c !important; }
        .dark .border-yellow-400 { border-color: #b45309 !important; }
        .dark .border-green-400 { border-color: #065f46 !important; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    </head>
<body class="min-h-screen p-4 md:p-8 bg-gray-50 text-gray-800 dark:text-gray-100 transition-colors duration-300">
    <script>
        // Konfigurasi Tailwind untuk mengaktifkan Dark Mode berdasarkan class="dark" pada body
        tailwind.config = {
            darkMode: 'class', 
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // blue-500
                        'accent': '#10b981', // emerald-500
                    }
                }
            }
        }
    </script>
    <div id="background-overlay"></div>
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 p-3 rounded-lg bg-white dark:bg-gray-800 shadow-md border-b">
            <div id="status-display" class="text-sm font-medium text-gray-600 dark:text-gray-400">
                <span id="status-message">Menunggu Koneksi Bluetooth...</span>
                <span id="device-info" class="text-xs text-gray-400 dark:text-gray-600 block italic"></span>
            </div>
            <div class="flex space-x-2">
                <button id="theme-toggle" onclick="toggleTheme()" class="w-10 h-10 p-2 rounded-full flex items-center justify-center bg-gray-200 text-yellow-600 hover:bg-gray-300 dark:bg-gray-700 dark:text-yellow-300 dark:hover:bg-gray-600 transition-all duration-300 shadow-md">
                    <span id="theme-icon" class="text-xl transition-transform duration-300" role="img" aria-label="Dark/Light Mode Toggle"></span>
                </button>
                
                <button id="connect-button" onclick="connectBluetooth()" class="minimal-connect-btn bg-primary text-white hover:bg-blue-600 transition disabled:opacity-50">
                    <span class="mr-1 inline-block align-middle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block align-middle">
                            <polyline points="6.5 6.5 17.5 17.5 12 23 12 1 17.5 6.5 6.5 17.5"/>
                        </svg>
                    </span>
                    Sambung
                </button>
                <button id="disconnect-button" onclick="disconnectBluetooth()" class="minimal-connect-btn bg-gray-300 text-gray-700 hover:bg-gray-400 transition disabled:opacity-50 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500" disabled>
                    Putus
                </button>
            </div>
        </header>
        <div class="flex justify-between items-center mb-4">
             <p id="firestore-status" class="text-xs text-gray-500 dark:text-gray-400">Status DB: Penyimpanan Lokal (localStorage) Aktif.</p>
             <div class="flex space-x-2">
                 <button id="wakelock-toggle" onclick="toggleWakelock()" class="text-xs minimal-connect-btn bg-gray-500 text-white hover:bg-gray-600 transition disabled:opacity-50" title="Kunci layar agar tidak mati saat memantau.">
                    Aktifkan Wakelock
                 </button>
                 <button id="upload-logs-button" onclick="uploadAllLogsToFirebase()" class="text-xs minimal-connect-btn bg-purple-500 text-white hover:bg-purple-600 transition disabled:opacity-50">
                    Upload Log ke Firebase
                </button>
             </div>
        </div>
        

        <section id="safety-status-section" class="status-box mb-6 hidden bg-green-100 text-green-600 border border-green-400">
            <h3 class="font-bold text-xl mb-1">Status Keselamatan: <span id="safety-status-text">Normal</span></h3>
            <p class="text-sm" id="safety-message">Semua parameter dalam batas aman.</p>
        </section>
        
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="dashboard-card p-5 border-b-4 border-green-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kapasitas (SOC)</p>
                <p id="soc-value" class="value-text text-green-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soc-progress" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
                <p id="time-remaining" class="text-xs font-semibold text-gray-500 dark:text-gray-400 mt-2">Waktu Sisa: Menghitung...</p>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-yellow-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Kesehatan (SOH)</p>
                <p id="soh-value" class="value-text text-yellow-600">0.0%</p>
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full mt-2"><div id="soh-progress" class="h-full bg-yellow-500 rounded-full transition-all duration-500" style="width: 0%"></div></div>
            </div>
            <div class="dashboard-card p-5 border-b-4 border-red-500">
                <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Suhu (Maks)</p>
                <p id="temp-value" class="value-text text-red-600">0.0°C</p>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Parameter Kelistrikan Inti</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="p-4 rounded-lg card-voltage">
                    <p class="text-sm font-semibold mb-1">Tegangan Total</p>
                    <p id="total-voltage" class="value-text">0.00 V</p>
                    <p id="min-max-voltage" class="text-xs font-medium mt-1">Min: 0.00 V | Max: 0.00 V</p>
                </div>
                <div class="p-4 rounded-lg card-current">
                    <p class="text-sm font-semibold mb-1">Arus</p>
                    <p id="current-value" class="value-text">0.00 A</p>
                    <p id="min-max-current" class="text-xs font-medium mt-1">Min: 0.00 A | Max: 0.00 A</p>
                </div>
                <div class="p-4 rounded-lg card-power">
                    <p class="text-sm font-semibold mb-1">Daya</p>
                    <p id="power-value" class="value-text">0.00 W</p>
                    <p id="min-max-power" class="text-xs font-medium mt-1">Min: 0.00 W | Max: 0.00 W</p>
                </div>
                <div class="p-4 rounded-lg card-cap-rem">
                    <p class="text-sm font-semibold mb-1">Kapasitas Pabrik</p>
                    <p id="remaining-capacity" class="value-text">0 Ah</p>
                </div>
                <div class="p-4 rounded-lg card-cap-used">
                    <p class="text-sm font-semibold mb-1">Kapasitas Sisa</p>
                    <p id="capacity-used-value" class="value-text">0 Ah</p>
                </div>
                <div class="p-4 rounded-lg card-delta">
                    <p class="text-sm font-semibold mb-1">DeltaV Sel Aktif</p>
                    <p id="delta-v-value" class="value-text">0 mV</p>
                </div>
            </div>
        </section>

        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Profil Energi (Wh) untuk Periode Aktif</h2>
            
            <div class="flex flex-wrap justify-center space-x-2 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg mb-4">
                <button id="period-1h" onclick="selectPeriod('1h')" class="period-button period-active">1 Jam</button>
                <button id="period-6h" onclick="selectPeriod('6h')" class="period-button">6 Jam</button>
                <button id="period-12h" onclick="selectPeriod('12h')" class="period-button">12 Jam</button>
                <button id="period-24h" onclick="selectPeriod('24h')" class="period-button">24 Jam</button>
                <button id="period-7d" onclick="selectPeriod('7d')" class="period-button">7 Hari</button> <button id="period-30d" onclick="selectPeriod('30d')" class="period-button">30 Hari</button>
            </div>

            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h4 class="text-center font-semibold text-gray-800 dark:text-gray-200 mb-2">Energi Masuk (Charge +) vs Keluar (Discharge -)</h4>
                <div class="w-full h-96">
                    <canvas id="whCombinedCanvas"></canvas>
                </div>
                
                <p id="chart-status" class="text-center text-sm text-gray-500 dark:text-gray-400 mt-2">Memuat data Wh dari penyimpanan lokal...</p>
                <div class="flex flex-wrap justify-center space-x-8 text-sm mt-4 font-semibold">
                    <p class="text-green-600"><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-1"></span> Total Charge: <span id="total-charge-wh">0.000 Wh</span></p>
                    <p class="text-red-600"><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-1"></span> Total Discharge: <span id="total-discharge-wh">0.000 Wh</span></p>
                </div>
            </div>
        </section>


        <section class="mb-8 p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Detail Tegangan Sel (S1-S4)</h2>
            <div id="cell-voltage-detail" class="grid cell-grid gap-4">
                <div id="cell-1" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 1</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-2" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 2</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-3" class="p-3 text-center rounded-lg bg-gray-100 border border-gray-300">
                    <p class="text-sm font-medium">Sel 3</p>
                    <p class="text-xl font-bold text-gray-800">0.00 V</p>
                </div>
                <div id="cell-4" class="p-3 text-center rounded-lg bg-gray-200 border border-gray-300">
                    <p class="text-sm font-medium">Sel 4</p>
                    <p class="text-xl font-bold text-gray-500">0.00 V</p>
                </div>
            </div>
            <p id="summary-min-max" class="mt-4 text-sm text-gray-500 dark:text-gray-400 text-center">Min: 0.000 V | Max: 0.000 V | DeltaV: 0 mV</p>
            <p id="balancing-status" class="font-bold text-lg text-green-600 text-center mt-2">Status Balancing: Normal</p>
        </section>

        <section class="p-6 dashboard-card">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-50 mb-4 border-b pb-2">Parameter Detail Tambahan</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4" id="extra-parameters">
                </div>
        </section>

        <div id="error-box" class="mt-8 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden">
            <p class="font-bold text-lg">⚠️ Kesalahan Protokol/Koneksi/Parsing:</p>
            <p id="error-details" class="text-sm mt-1"></p>
        </div>
    </div>

    <script src="chart.js"></script>
    <script type="text/javascript">
        // --- UUID Konfigurasi Perangkat ---
        const UART_SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; 
        const TX_CHARACTERISTIC_UUID = '0000ffe2-0000-1000-8000-00805f9b34fb'; 
        const RX_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb'; 
        const EXPECTED_LENGTH = 70; 

        // --- Variabel Global & Konstanta Lainnya ---
        let device = null;
        let rxCharacteristic = null;
        let txCharacteristic = null;
        let requestInterval = null;
        let dataBuffer = new ArrayBuffer(0); 
        
        let whChart = null; // Instans Chart.js untuk Charge & Discharge Gabungan
        let lastLogTime = 0; // Untuk batasan logging
        
        // *** PERUBAHAN: Interval logging 1 menit (60 detik) ***
        const LOG_INTERVAL_MS = 60000; // Interval logging 1 menit (60 detik) 
        const MAX_LOG_ENTRIES = 10000; // Batas untuk mencegah localStorage penuh

        // Variabel untuk melacak Min/Max
        let minTotalVoltage = Infinity;
        let maxTotalVoltage = -Infinity;
        let minCurrent = Infinity;
        let maxCurrent = -Infinity;
        let minPower = Infinity;
        let maxPower = -Infinity;

        // Kunci untuk menyimpan data di localStorage
        const LOCAL_STORAGE_KEY = 'bms_power_logs';
        const THEME_KEY = 'bms_theme'; // Kunci untuk tema
        
        // Variabel Global untuk menyimpan data dashboard terakhir yang diuraikan
        let lastDashboardData = {};

        // --- VARIABEL WAKELOCK BARU ---
        let wakeLockSentinel = null;
        // --- END VARIABEL WAKELOCK BARU ---


        // --- DEFINISI SVG ICONS OFFLINE ---
        const SVG_ICONS = {
            // Thermometer (Suhu)
            THERMOMETER: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>',
            // Heart (Kesehatan SOH)
            HEART: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
            // Flash/Zap (Relay Pengisian) - Simbol petir untuk arus/listrik
            FLASH: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
            // Flame (Relay Pengurasan) - Simbol api untuk panas/discharge
            FLAME: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM15 15.5A2.5 2.5 0 0 0 17.5 13c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM8.5 8.5A2.5 2.5 0 0 0 11 6c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5zM15 9.5A2.5 2.5 0 0 0 17.5 7c0-1.25-.75-2-2-2-1.25 0-2 1-2 2s1.5 2.5 2.5 2.5z"/></svg>'
        };

        // Pemetaan Index Data 
        const DATA_INDICES = {
            TOTAL_VOLTAGE: 0, CELL_1: 1, CELL_2: 2, CELL_3: 3, CELL_4: 4, 
            CURRENT: 5, POWER: 6, CAP_MAX: 7, SOC: 8,
            TEMP_1: 9, TEMP_2: 10, 
            CAP_USED: 11,
            SOH_1: 12, SOH_2: 13, 
            STATUS_CHARGE: 14, STATUS_DISCHARGE: 15, SOH: 16,
        };

        // Definisi semua 16 data, menggunakan 'iconKey' untuk merujuk ke SVG_ICONS
        const ALL_DATA_MAP = [
            // Dikecualikan dari 'Tambahan' (sudah di Ringkasan atau Inti)
            { label: 'Tegangan Total', unit: 'V', index: 0, showInExtra: false, key: 'total_voltage' },
            { label: 'Tegangan Sel 1', unit: 'V', index: 1, showInExtra: false, key: 'cell_1_voltage' },
            { label: 'Tegangan Sel 2', unit: 'V', index: 2, showInExtra: false, key: 'cell_2_voltage' },
            { label: 'Tegangan Sel 3', unit: 'V', index: 3, showInExtra: false, key: 'cell_3_voltage' },
            { label: 'Tegangan Sel 4', unit: 'V', index: 4, showInExtra: false, key: 'cell_4_voltage' },
            { label: 'Arus', unit: 'A', index: 5, showInExtra: false, key: 'current' },
            { label: 'Daya', unit: 'W', index: 6, showInExtra: false, key: 'power' },
            { label: 'Kapasitas Terpakai (Max/Full)', unit: 'Ah', index: 7, showInExtra: false, key: 'capacity_full' },
            { label: 'SOC (State of Charge)', unit: '%', index: 8, showInExtra: false, key: 'soc' },
            { label: 'Suhu Baterai', unit: '°C', index: 9, showInExtra: true, iconKey: 'THERMOMETER', key: 'temp_battery' }, 
            { label: 'Suhu Mosfet', unit: '°C', index: 10, showInExtra: true, iconKey: 'THERMOMETER', key: 'temp_mosfet' }, 
            { label: 'Kapasitas Tersisa (Remaining)', unit: 'Ah', index: 11, showInExtra: false, key: 'capacity_remaining' },
            { label: 'SOH Pengisian', unit: '%', index: 12, showInExtra: true, iconKey: 'HEART', key: 'soh_charge' },
            { label: 'SOH Pengurasan', unit: '%', index: 13, showInExtra: true, iconKey: 'HEART', key: 'soh_discharge' },
            { label: 'Relay Pengisian', unit: '', index: 14, showInExtra: true, iconKey: 'FLASH', key: 'relay_charge_status' },
            { label: 'Relay Pengurasan', unit: '', index: 15, showInExtra: true, iconKey: 'FLAME', key: 'relay_discharge_status' },
            { label: 'SOH (Rata-rata)', unit: '%', index: 16, showInExtra: false, key: 'soh_avg' },
        ];
        
        // --- KONFIGURASI GRAFIK WH BARU ---
        // Nilai dalam milidetik dan jumlah titik data
        const PERIOD_CONFIG = { 
            '1h': { durationMs: 3600 * 1000, points: 12, label: '1 Jam' }, // Ditingkatkan ke 12 titik (tiap 5 menit)
            '6h': { durationMs: 6 * 3600 * 1000, points: 24, label: '6 Jam' }, // 24 titik (tiap 15 menit)
            '12h': { durationMs: 12 * 3600 * 1000, points: 24, label: '12 Jam' }, // 24 titik (tiap 30 menit)
            '24h': { durationMs: 24 * 3600 * 1000, points: 24, label: '24 Jam' }, // 24 titik (tiap 1 jam)
            '7d': { durationMs: 7 * 24 * 3600 * 1000, points: 7, label: '7 Hari' },
            '30d': { durationMs: 30 * 24 * 3600 * 1000, points: 30, label: '30 Hari' } 
        };
        // --- END KONFIGURASI GRAFIK WH BARU ---
        
        
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDLlc2nBOG6hesoQmhTD55BuRc5l7UF87I",
            authDomain: "batmon-5c279.firebaseapp.com",
            databaseURL: "https://batmon-5c279-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "batmon-5c279",
            storageBucket: "batmon-5c279.firebasestorage.app",
            messagingSenderId: "718766895236",
            appId: "1:718766895236:web:b5dd36e93aaa114bcd52d1"
        };

        // Inisialisasi Firebase
        let firebaseApp;
        let firebaseDB;
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseDB = firebaseApp.database();
            document.getElementById('firestore-status').textContent = 'Status DB: Firebase Realtime Database Aktif.';
        } catch(e) {
             document.getElementById('firestore-status').textContent = `Status DB: Firebase GAGAL Inisialisasi: ${e.message}. Hanya Penyimpanan Lokal Aktif.`;
             console.error('Firebase initialization error:', e);
        }
        // --- END KONFIGURASI FIREBASE ---


        // --- UI Elements ---
        const statusMessage = document.getElementById('status-message');
        const deviceInfo = document.getElementById('device-info');
        const connectButton = document.getElementById('connect-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const errorBox = document.getElementById('error-box');
        const errorDetails = document.getElementById('error-details');
        const uploadLogsButton = document.getElementById('upload-logs-button');
        const wakelockToggle = document.getElementById('wakelock-toggle'); // Wakelock button element
        
        // Variabel untuk elemen ikon tema
        const themeIcon = document.getElementById('theme-icon'); 
        
        const cellElements = [
            document.getElementById('cell-1'), 
            document.getElementById('cell-2'), 
            document.getElementById('cell-3'),
            document.getElementById('cell-4'),
        ];
        const summaryMinMaxElement = document.getElementById('summary-min-max');
        const totalVoltageElement = document.getElementById('total-voltage');
        const minMaxVoltageElement = document.getElementById('min-max-voltage'); 
        const currentElement = document.getElementById('current-value');
        const minMaxCurrentElement = document.getElementById('min-max-current'); 
        const powerElement = document.getElementById('power-value');
        const minMaxPowerElement = document.getElementById('min-max-power'); 
        const capacityUsedElement = document.getElementById('capacity-used-value');
        const remainingCapacityElement = document.getElementById('remaining-capacity');
        const deltaVElement = document.getElementById('delta-v-value');
        const socValueElement = document.getElementById('soc-value');
        const socProgressElement = document.getElementById('soc-progress');
        const sohValueElement = document.getElementById('soh-value');
        const sohProgressElement = document.getElementById('soh-progress');
        const tempValueElement = document.getElementById('temp-value');
        const timeRemainingElement = document.getElementById('time-remaining');
        const safetyStatusSection = document.getElementById('safety-status-section');
        const safetyStatusText = document.getElementById('safety-status-text');
        const safetyMessage = document.getElementById('safety-message');
        const extraParametersContainer = document.getElementById('extra-parameters');
        const chartStatusElement = document.getElementById('chart-status');
        const totalChargeWhElement = document.getElementById('total-charge-wh');
        const totalDischargeWhElement = document.getElementById('total-discharge-wh');

        
        

        // --- Utility Functions (formatTime, calculateChecksum, parse...
        
        // ... (Fungsi-fungsi Utility: formatTime, calculateChecksum, parseData, sendRequest, handleNotifications, onDisconnected, updateDashboard, logNotificationToFirebase, uploadDataToFirebase, uploadAllLogsToFirebase) ...

        /**
         * Memformat waktu dalam satuan jam menjadi string "Hj Mm Ss" atau "N/A".
         * @param {number} hours - Waktu dalam jam (misalnya 1.5 untuk 1 jam 30 menit).
         * @returns {string} String waktu yang diformat.
         */
        function formatTime(hours) { 
            // Menangani nilai tidak valid atau nol
            if (!isFinite(hours) || hours <= 0) {
                return "N/A";
            }
            // Mengubah jam ke total detik
            const totalSeconds = hours * 3600;
            // Memastikan totalSeconds adalah bilangan bulat terdekat (opsional, tapi disarankan)
            const roundedSeconds = Math.round(totalSeconds);
            const h = Math.floor(roundedSeconds / 3600);
            const m = Math.floor((roundedSeconds % 3600) / 60);
            const s = roundedSeconds % 60;

            let result = "";
            // Tambahkan Jam jika lebih dari 0
            if (h > 0) {
                result += `${h}j `;
            }
            // Tambahkan Menit jika lebih dari 0 ATAU jika Jam = 0
            if (m > 0 || (h === 0 && s === 0)) { // (Sertakan 0j 0m 0s sebagai N/A, tetapi jika h=0, m atau s > 0, tampilkan)
                result += `${m}m `;
            }
            // Tambahkan Detik
            result += `${s}s`;

            // Jika hasil hanya 0s, anggap N/A
            if (result.trim() === '0s') return "N/A";
            
            return result.trim();
        }

        /**
         * Menghitung Checksum (XOR dari semua byte kecuali start byte dan checksum byte itu sendiri).
         * @param {DataView} dataView - DataView dari buffer data (70 byte).
         * @returns {number} Nilai checksum yang dihitung.
         */
        function calculateChecksum(dataView) {
            let checksum = 0;
            // Hitung XOR dari byte index 1 hingga 68 (total 68 byte)
            for (let i = 1; i < EXPECTED_LENGTH - 1; i++) {
                checksum ^= dataView.getUint8(i);
            }
            return checksum;
        }

        /**
         * Menguraikan data mentah dari BMS menjadi array nilai Float32.
         * @param {DataView} dataView - DataView dari 70 byte data.
         * @returns {Array<number>|null} Array nilai atau null jika parsing gagal.
         */
        function parseData(dataView) {
            // Cek panjang
            if (dataView.byteLength !== EXPECTED_LENGTH) {
                errorDetails.textContent = `[Parsing Gagal Internal] Data Diterima Salah: ${dataView.byteLength} byte.`;
                errorBox.classList.remove('hidden');
                return null;
            }

            // Cek Start Byte (0xAA)
            const startByte = dataView.getUint8(0);
            if (startByte !== 0xAA) {
                errorDetails.textContent = `[Parsing Gagal] Start Byte salah: 0x${startByte.toString(16).toUpperCase()}.`;
                errorBox.classList.remove('hidden');
                return null;
            }

            // Cek Checksum
            const receivedChecksum = dataView.getUint8(69);
            const calculatedChecksum = calculateChecksum(dataView);
            if (receivedChecksum !== calculatedChecksum) {
                errorDetails.textContent = `[Parsing Gagal] Checksum salah. Diterima: 0x${receivedChecksum.toString(16).toUpperCase()}. Diharapkan: 0x${calculatedChecksum.toString(16).toUpperCase()}.`;
                errorBox.classList.remove('hidden');
                return null;
            }

            // Ambil 17 nilai Float32
            const values = [];
            let offset = 1; // Mulai setelah Start Byte
            for (let i = 0; i < 17; i++) {
                const floatValue = dataView.getFloat32(offset, true); // true = Little Endian
                values.push(floatValue);
                offset += 4;
            }

            // Parsing sukses
            errorBox.classList.add('hidden');
            return values;
        }

        /**
         * Mengirim perintah 'R' (Request) ke BMS untuk meminta data.
         */
        async function sendRequest() {
            if (!txCharacteristic) return;
            try {
                // Perintah 'R' yang di-encode sebagai Text/ASCII
                const value = new TextEncoder().encode("R");
                await txCharacteristic.writeValue(value);
            } catch (error) {
                console.error("Gagal mengirim perintah 'R':", error);
                statusMessage.textContent = "Gagal mengirim perintah. Interval dihentikan.";
                if (requestInterval) {
                    clearInterval(requestInterval);
                    requestInterval = null;
                }
            }
        }

        /**
         * Menangani notifikasi data yang diterima dari BMS.
         * @param {Event} event - Event notifikasi.
         */
        function handleNotifications(event) {
            const incomingData = event.target.value.buffer;
            
            // Gabungkan data yang masuk dengan data buffer yang ada
            const newBuffer = new ArrayBuffer(dataBuffer.byteLength + incomingData.byteLength);
            const view = new Uint8Array(newBuffer);
            view.set(new Uint8Array(dataBuffer), 0);
            view.set(new Uint8Array(incomingData), dataBuffer.byteLength);
            dataBuffer = newBuffer;

            // Proses data jika panjangnya mencapai atau melebihi panjang yang diharapkan
            while (dataBuffer.byteLength >= EXPECTED_LENGTH) {
                const dataToParse = dataBuffer.slice(0, EXPECTED_LENGTH);
                const dataView = new DataView(dataToParse);
                
                const parsedValues = parseData(dataView);
                
                if (parsedValues) {
                    updateDashboard(parsedValues);
                    logBMSData(parsedValues[DATA_INDICES.POWER]); // Log Power ke LocalStorage
                    
                    // Refresh grafik setiap LOG_INTERVAL_MS
                    const now = Date.now();
                    if ((now - lastLogTime) >= LOG_INTERVAL_MS) {
                        fetchAndRenderGraphs(selectedPeriod); 
                        // lastLogTime diupdate di logBMSData()
                    }

                    statusMessage.textContent = `Terkoneksi | Data terakhir diterima dari BMS.`;
                } else {
                    statusMessage.textContent = `Terkoneksi | Data diterima, namun gagal diuraikan (Lihat Detail Kesalahan).`;
                }

                // Hapus data yang telah diproses dari buffer
                dataBuffer = dataBuffer.slice(EXPECTED_LENGTH);
            }
            // Jika dataBuffer masih ada tapi kurang dari EXPECTED_LENGTH, biarkan untuk iterasi berikutnya.
        }

        /**
         * Dipanggil ketika koneksi Bluetooth terputus.
         */
        function onDisconnected() {
            console.log('Perangkat Bluetooth terputus.');
            // Hentikan interval request
            if (requestInterval) {
                clearInterval(requestInterval);
                requestInterval = null;
            }

            // Hapus listener notifikasi (jika ada)
            if (rxCharacteristic) {
                rxCharacteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
            }

            // *** PERUBAHAN: Kirim notif ke Firebase saat terputus ***
            logNotificationToFirebase('BLUETOOTH_DISCONNECTED', 'Koneksi Bluetooth terputus.');

            statusMessage.textContent = "Koneksi Bluetooth terputus.";
            deviceInfo.textContent = "";
            connectButton.disabled = false;
            disconnectButton.disabled = true;
            dataBuffer = new ArrayBuffer(0); 

            // Reset display
            const initialValues = Array(17).fill(0.0);
            updateDashboard(initialValues);
            safetyStatusSection.classList.add('hidden');
            
            // Reset min/max trackers
            minTotalVoltage = Infinity;
            maxTotalVoltage = -Infinity;
            minMaxVoltageElement.textContent = "Min: 0.00 V | Max: 0.00 V";
            minCurrent = Infinity;
            maxCurrent = -Infinity;
            minMaxCurrentElement.textContent = "Min: 0.00 A | Max: 0.00 A";
            minPower = Infinity;
            maxPower = -Infinity;
            minMaxPowerElement.textContent = "Min: 0.00 W | Max: 0.00 W";
        }


        /**
         * Memperbarui elemen-elemen dashboard dengan data yang diuraikan.
         * @param {Array<number>} values - Array dari 17 nilai Float32 yang diuraikan.
         */
        function updateDashboard(values) {
            // --- 1. Update Min/Max Global ---
            const currentTotalVoltage = values[DATA_INDICES.TOTAL_VOLTAGE];
            const currentCurrent = values[DATA_INDICES.CURRENT];
            const currentPower = values[DATA_INDICES.POWER];

            // Tegangan
            minTotalVoltage = Math.min(minTotalVoltage, currentTotalVoltage);
            maxTotalVoltage = Math.max(maxTotalVoltage, currentTotalVoltage);
            const minVDisplay = minTotalVoltage !== Infinity ? minTotalVoltage.toFixed(2) : '0.00';
            const maxVDisplay = maxTotalVoltage !== -Infinity ? maxTotalVoltage.toFixed(2) : '0.00';
            minMaxVoltageElement.textContent = `Min: ${minVDisplay} V | Max: ${maxVDisplay} V`;

            // Arus
            minCurrent = Math.min(minCurrent, currentCurrent);
            maxCurrent = Math.max(maxCurrent, currentCurrent);
            const minADisplay = minCurrent !== Infinity ? minCurrent.toFixed(2) : '0.00';
            const maxADisplay = maxCurrent !== -Infinity ? maxCurrent.toFixed(2) : '0.00';
            currentElement.textContent = `${currentCurrent.toFixed(2)} A`;
            minMaxCurrentElement.textContent = `Min: ${minADisplay} A | Max: ${maxADisplay} A`;

            // Daya
            minPower = Math.min(minPower, currentPower);
            maxPower = Math.max(maxPower, currentPower);
            const minWDisplay = minPower !== Infinity ? minPower.toFixed(2) : '0.00';
            const maxWDisplay = maxPower !== -Infinity ? maxPower.toFixed(2) : '0.00';
            powerElement.textContent = `${currentPower.toFixed(2)} W`;
            minMaxPowerElement.textContent = `Min: ${minWDisplay} W | Max: ${maxWDisplay} W`;

            // --- 2. Update Detail Sel & Hitung Delta V ---
            const cellVoltages = [
                values[DATA_INDICES.CELL_1], values[DATA_INDICES.CELL_2], 
                values[DATA_INDICES.CELL_3], values[DATA_INDICES.CELL_4],
            ];
            let minCellV = Infinity;
            let maxCellV = -Infinity;
            let totalActiveCells = 0;

            cellVoltages.forEach((v, i) => {
                const cellElement = cellElements[i];
                const voltage = v.toFixed(3);
                
                if (v > 1.0) { // Anggap sel aktif jika tegangan > 1V
                    minCellV = Math.min(minCellV, v);
                    maxCellV = Math.max(maxCellV, v);
                    totalActiveCells++;
                }

                const isDark = document.body.classList.contains('dark');
                let bgClass = '';
                let textColor = '';

                // Logika pewarnaan sel
                if (v > 4.2) { 
                    bgClass = 'bg-red-200'; textColor = 'text-red-800'; 
                    if (isDark) { bgClass = 'bg-red-900'; textColor = 'text-red-300'; }
                } else if (v > 3.8) { 
                    bgClass = 'bg-green-100'; textColor = 'text-green-800'; 
                    if (isDark) { bgClass = 'bg-emerald-900'; textColor = 'text-emerald-300'; }
                } else if (v < 3.0 && v > 1.0) { 
                    bgClass = 'bg-yellow-100'; textColor = 'text-yellow-800'; 
                    if (isDark) { bgClass = 'bg-amber-900'; textColor = 'text-amber-300'; }
                } else if (v <= 1.0) { 
                    // Sel Nonaktif / Kosong
                    bgClass = (i === 3) ? 'bg-gray-200' : 'bg-gray-100'; 
                    textColor = 'text-gray-500'; 
                    if (isDark) { 
                        bgClass = (i === 3) ? 'bg-gray-800' : 'bg-gray-700'; 
                        textColor = 'text-gray-500'; 
                    }
                } else { 
                    // Sel Aktif Normal (3.0V - 3.8V)
                    bgClass = 'bg-gray-100'; textColor = 'text-gray-800';
                    if (isDark) { 
                        bgClass = 'bg-gray-700'; 
                        textColor = 'text-gray-100'; 
                    }
                }
                
                cellElement.querySelector('.text-xl').textContent = (v <= 1.0) ? '0.00 V' : `${voltage} V`;
                cellElement.className = `p-3 text-center rounded-lg border transition-colors duration-300`;
                cellElement.classList.add(bgClass);
                cellElement.classList.add(isDark ? 'dark:border-gray-600' : 'border-gray-300');

                const cellVoltageText = cellElement.querySelector('.text-xl');
                cellVoltageText.className = 'text-xl font-bold transition-colors duration-300 ' + textColor;
            });

            const deltaV = (maxCellV !== -Infinity && minCellV !== Infinity) ? (maxCellV - minCellV) * 1000 : 0;
            const deltaVText = totalActiveCells >= 2 ? `${Math.round(deltaV)} mV` : 'N/A';
            deltaVElement.textContent = deltaVText;

            const minVText = minCellV !== Infinity ? minCellV.toFixed(3) : '0.000';
            const maxVText = maxCellV !== -Infinity ? maxCellV.toFixed(3) : '0.000';
            summaryMinMaxElement.textContent = `Sel Aktif (Total: ${totalActiveCells}) | Min: ${minVText} V | Max: ${maxVText} V | DeltaV: ${deltaVText}`;
            
            // Status Balancing
            let statusText = 'Normal';
            let statusClass = 'text-green-600';
            let statusBg = 'bg-green-100';
            let statusBorder = 'border-green-400';
            let safetyMsg = 'Semua parameter dalam batas aman.';

            if (maxCellV > 4.25 || minCellV < 2.5) {
                statusText = 'KRITIS';
                statusClass = 'text-red-700';
                statusBg = 'bg-red-100';
                statusBorder = 'border-red-400';
                safetyMsg = 'Tegangan Sel KRITIS! Periksa sel minimum/maksimum.';
            } else if (deltaV > 100 || maxCellV > 4.1 || minCellV < 3.0) {
                statusText = 'PERINGATAN';
                statusClass = 'text-yellow-700';
                statusBg = 'bg-yellow-200';
                statusBorder = 'border-yellow-400';
                safetyMsg = `DeltaV (${deltaVText}) terlalu tinggi atau sel mendekati batas.`;
            } else if (deltaV > 50) {
                 statusText = 'Balancing Aktif';
            }

            document.getElementById('balancing-status').textContent = `Status Balancing: ${statusText}`;
            document.getElementById('balancing-status').className = `font-bold text-lg text-center mt-2 ${statusClass}`;
            
            // Update Safety Status Section
            safetyStatusText.textContent = statusText;
            safetyMessage.textContent = safetyMsg;
            safetyStatusSection.className = `status-box mb-6 bg-green-100 text-green-600 border border-green-400`; // Reset classes
            safetyStatusSection.classList.remove('hidden');
            safetyStatusSection.classList.remove('bg-green-100', 'text-green-600', 'border-green-400', 'bg-red-100', 'text-red-700', 'border-red-400', 'bg-yellow-200', 'text-yellow-700', 'border-yellow-400');
            safetyStatusSection.classList.add(statusBg, statusClass, statusBorder);


            // --- 3. Update Ringkasan Utama (SOC, SOH, Suhu, Time Remaining) ---
            const soc = Math.min(100, Math.max(0, values[DATA_INDICES.SOC].toFixed(2)));
            const sohAvg = Math.min(100, Math.max(0, values[DATA_INDICES.SOH].toFixed(2)));
            const maxTemp = Math.max(values[DATA_INDICES.TEMP_1], values[DATA_INDICES.TEMP_2]).toFixed(1);
            const remainingCapacity = values[DATA_INDICES.CAP_USED]; 
            const capacityFull = values[DATA_INDICES.CAP_MAX];
            
            socValueElement.textContent = `${soc}%`;
            socProgressElement.style.width = `${soc}%`;
            sohValueElement.textContent = `${sohAvg}%`;
            sohProgressElement.style.width = `${sohAvg}%`;
            tempValueElement.textContent = `${maxTemp}°C`;

            // Hitung Time Remaining
            let timeToEmptyHours = 0;
            let timeToFullHours = 0;
            if (currentCurrent < -0.1 && remainingCapacity > 0) { // Discharge
                timeToEmptyHours = remainingCapacity / Math.abs(currentCurrent);
                timeRemainingElement.textContent = `Waktu Sisa: Habis dalam ${formatTime(timeToEmptyHours)}`;
            } else if (currentCurrent > 0.1 && capacityFull > 0) { // Charge
                const capacityNeeded = capacityFull - remainingCapacity;
                timeToFullHours = capacityNeeded / currentCurrent;
                timeRemainingElement.textContent = `Waktu Sisa: Penuh dalam ${formatTime(timeToFullHours)}`;
            } else {
                timeRemainingElement.textContent = 'Waktu Sisa: Standby/N/A';
            }


            // --- 4. Update Kelistrikan Inti ---
            totalVoltageElement.textContent = `${currentTotalVoltage.toFixed(2)} V`;
            capacityUsedElement.textContent = `${capacityFull.toFixed(2)} Ah`;
            remainingCapacityElement.textContent = `${remainingCapacity.toFixed(2)} Ah`;

            // --- 5. Update Parameter Detail Tambahan (Menggunakan SVG) ---
            let extraHtml = '';
            ALL_DATA_MAP.filter(d => d.showInExtra).forEach(dataInfo => {
                const value = values[dataInfo.index];
                let formattedValue;
                let displayUnit = dataInfo.unit;
                let title = dataInfo.label;
                let bgColor = document.body.classList.contains('dark') ? 'bg-gray-700' : 'bg-gray-50';
                let symbolSvg = SVG_ICONS[dataInfo.iconKey]; // Ambil SVG berdasarkan kunci
                let symbolColor = 'text-primary';

                if (dataInfo.label.includes('Suhu')) {
                    formattedValue = value.toFixed(1);
                    symbolColor = 'text-orange-500';
                } else if (dataInfo.label.includes('Kesehatan')) {
                    formattedValue = value.toFixed(2);
                    symbolColor = 'text-red-500';
                } else if (dataInfo.label.includes('Relay')) {
                    formattedValue = (value === 1.0) ? 'AKTIF' : 'NONAKTIF';
                    displayUnit = '';
                    symbolColor = (value === 1.0) ? 'text-accent' : 'text-gray-400';
                    if (value === 1.0) {
                        bgColor = 'bg-green-50';
                        // Override dark mode color untuk status aktif
                        if (document.body.classList.contains('dark')) {
                             bgColor = 'bg-green-900';
                             symbolColor = 'text-green-300';
                        }
                    } else {
                        bgColor = document.body.classList.contains('dark') ? 'bg-gray-700' : 'bg-gray-50';
                    }
                } else {
                    formattedValue = value.toFixed(2);
                }

                extraHtml += `
                    <div class="p-4 rounded-lg border border-gray-300 ${bgColor} dark:border-gray-600">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="w-5 h-5 ${symbolColor}">
                                ${symbolSvg}
                            </span>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">${title}</p>
                        </div>
                        <p class="text-2xl font-bold text-gray-900 dark:text-gray-50">${formattedValue} ${displayUnit}</p>
                    </div>
                `;
            });
            extraParametersContainer.innerHTML = extraHtml;


            // --- 6. Simpan Data Dashboard ke Variabel Global (untuk Firebase RT) ---
            lastDashboardData = {
                timestamp: Date.now(),
                // Data Inti dari parseData
                ...Object.fromEntries(ALL_DATA_MAP.map(d => [d.key, values[d.index]])),
                // Data Turunan
                min_cell_voltage: minCellV !== Infinity ? minCellV : 0.0,
                max_cell_voltage: maxCellV !== -Infinity ? maxCellV : 0.0,
                delta_voltage_mV: Math.round(deltaV),
                safety_status_text: statusText,
                safety_message: safetyMsg,
                // Data Min/Max Global
                min_total_voltage: minTotalVoltage !== Infinity ? minTotalVoltage : 0.0,
                max_total_voltage: maxTotalVoltage !== -Infinity ? maxTotalVoltage : 0.0,
                min_current: minCurrent !== Infinity ? minCurrent : 0.0,
                max_current: maxCurrent !== -Infinity ? maxCurrent : 0.0,
                min_power: minPower !== Infinity ? minPower : 0.0,
                max_power: maxPower !== -Infinity ? maxPower : 0.0,
                time_to_empty_hours: currentCurrent < 0 ? timeToEmptyHours : 0.0,
                time_to_full_hours: currentCurrent > 0 ? timeToFullHours : 0.0,
            };

            // --- 7. Upload data real-time ke Firebase ---
            uploadDataToFirebase(lastDashboardData);
        }

        // --- FUNGSI BARU UNTUK FIREBASE ---
        /**
         * Mencatat notifikasi sistem (koneksi, error) ke Firebase.
         * @param {string} type - Tipe notifikasi (e.g., 'BLUETOOTH_CONNECTED').
         * @param {string} message - Pesan detail notifikasi.
         */
        function logNotificationToFirebase(type, message) {
            if (!firebaseDB) return;
            try {
                const notificationsRef = firebaseDB.ref('notifications');
                notificationsRef.push({
                    timestamp: Date.now(),
                    type: type,
                    message: message,
                    device_name: device ? device.name : 'N/A'
                });
            } catch (e) {
                console.error("Gagal mencatat notifikasi ke Firebase:", e);
            }
        }

        /**
         * Mengunggah data dashboard real-time ke Firebase Realtime Database.
         * Data akan ditimpa di node 'latest_dashboard_data'.
         * @param {object} data - Objek data dashboard.
         */
        function uploadDataToFirebase(data) {
            if (!firebaseDB) return;
            try {
                // Gunakan set untuk menimpa data real-time terakhir
                firebaseDB.ref('latest_dashboard_data').set(data);

                // Jika ada koneksi, pastikan status di UI diperbarui (opsional, sudah diinisialisasi)
                // document.getElementById('firestore-status').textContent = 'Status DB: Terhubung & Real-time Update.';
            } catch (e) {
                console.error("Gagal mengunggah data real-time ke Firebase:", e);
            }
        }

        /**
         * Mengunggah semua log daya historis dari LocalStorage ke Firebase.
         */
        function uploadAllLogsToFirebase() {
            if (!firebaseDB) {
                alert("Firebase belum diinisialisasi atau gagal terhubung.");
                return;
            }
            
            uploadLogsButton.disabled = true;
            uploadLogsButton.textContent = 'Mengunggah...';

            try {
                const logs = getLocalLogs();
                if (logs.length === 0) {
                    alert("Tidak ada log daya lokal untuk diunggah.");
                    uploadLogsButton.disabled = false;
                    uploadLogsButton.textContent = 'Upload Log ke Firebase';
                    return;
                }

                // Node log yang akan ditambahkan timestamp upload
                const logsRef = firebaseDB.ref('historical_power_logs').child(Date.now().toString());
                
                // Unggah data
                logsRef.set({ 
                    upload_time: Date.now(),
                    total_entries: logs.length,
                    logs: logs
                })
                .then(() => {
                    alert(`Mengunggah log historis sukses (${logs.length} entri).`);
                    console.log(`Log historis sukses diunggah (${logs.length} entri).`);
                    uploadLogsButton.disabled = false;
                    uploadLogsButton.textContent = 'Upload Log ke Firebase';
                })
                .catch((error) => {
                    console.error("Gagal mengunggah log historis ke Firebase:", error);
                    alert(`Gagal mengunggah log historis: ${error.message}`);
                    document.getElementById('firestore-status').textContent = `Status DB: GAGAL mengunggah log historis: ${error.message.substring(0, 50)}...`;
                    uploadLogsButton.disabled = false;
                    uploadLogsButton.textContent = 'Upload Log ke Firebase';
                });
            } catch (e) {
                console.error("Error saat mencoba upload log historis:", e);
                uploadLogsButton.disabled = false;
                uploadLogsButton.textContent = 'Upload Log ke Firebase';
            }
        }
        
        // --- END FUNGSI BARU UNTUK FIREBASE ---


        // --- Logic Koneksi Bluetooth (connectBluetooth, disconnectBluetooth) --- 
        async function connectBluetooth() {
            if (!navigator.bluetooth) {
                statusMessage.textContent = "Web Bluetooth tidak didukung. Gunakan Chrome via HTTPS/localhost.";
                return;
            }

            connectButton.disabled = true;
            errorBox.classList.add('hidden');
            statusMessage.textContent = "Memindai perangkat...";

            try {
                // Meminta perangkat Bluetooth
                device = await navigator.bluetooth.requestDevice({
                    // Filter perangkat, atau gunakan acceptAllDevices: true dan optionalServices
                    acceptAllDevices: true,
                    optionalServices: [UART_SERVICE_UUID]
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                deviceInfo.textContent = `Perangkat: ${device.name || 'Tidak Dikenal'}`;
                statusMessage.textContent = `Menyambung ke ${device.name || 'perangkat tak dikenal'}...`;

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(UART_SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(RX_CHARACTERISTIC_UUID);
                txCharacteristic = await service.getCharacteristic(TX_CHARACTERISTIC_UUID);

                // Cek karakteristik properties
                let errorMsg = '';
                if (!(rxCharacteristic.properties.notify || rxCharacteristic.properties.indicate)) {
                    errorMsg += 'RX (FFE1) tidak mendukung NOTIFY/INDICATE.\n';
                }
                if (!txCharacteristic.properties.write && !txCharacteristic.properties.writeWithoutResponse) {
                    errorMsg += 'TX (FFE2) tidak mendukung WRITE.\n';
                }
                if (errorMsg) {
                    throw new Error(`Karakteristik tidak didukung:\n${errorMsg}`);
                }

                // Aktifkan notifikasi pada RX Characteristic
                await rxCharacteristic.startNotifications();
                rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                // Mulai interval permintaan data (misalnya setiap 100ms)
                if (requestInterval) {
                    clearInterval(requestInterval);
                }
                requestInterval = setInterval(sendRequest, 1000); 

                // *** PERUBAHAN: Kirim notif ke Firebase saat terhubung ***
                logNotificationToFirebase('BLUETOOTH_CONNECTED', 'Koneksi Bluetooth berhasil. Mulai menerima data.');
                
                statusMessage.textContent = `Terkoneksi | Menunggu data pertama dari BMS...`;
                connectButton.disabled = true;
                disconnectButton.disabled = false;

            } catch (error) {
                console.error('Koneksi Gagal:', error);
                statusMessage.textContent = `Koneksi Gagal: ${error.message}`;
                deviceInfo.textContent = "";
                connectButton.disabled = false;
                disconnectButton.disabled = true;
                if (requestInterval) {
                    clearInterval(requestInterval);
                    requestInterval = null;
                }
            }
        }

        async function disconnectBluetooth() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            } else {
                onDisconnected();
            }
        }


        // --- Logic LocalStorage untuk Logging --- 
        function getLocalLogs() {
            try {
                const logsString = localStorage.getItem(LOCAL_STORAGE_KEY);
                return logsString ? JSON.parse(logsString) : [];
            } catch (e) {
                console.error("Gagal mengambil log dari localStorage:", e);
                return [];
            }
        }

        function logBMSData(power) {
            // Batasi logging hanya jika ada aktivitas (Charging/Discharging) atau baterai terhubung
            if (Math.abs(power) < 0.1) {
                return;
            }

            // Gunakan interval 1 menit untuk menghemat storage
            const now = Date.now();
            if (now - lastLogTime < LOG_INTERVAL_MS) {
                return;
            }

            try {
                let logs = getLocalLogs();

                // Tambahkan log baru
                logs.push({
                    timestamp: now,
                    power_W: power,
                });

                // Batasi jumlah entri log
                if (logs.length > MAX_LOG_ENTRIES) {
                    // Hanya simpan MAX_LOG_ENTRIES data terbaru
                    logs = logs.slice(logs.length - MAX_LOG_ENTRIES);
                }

                // Simpan kembali ke localStorage
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(logs));
                lastLogTime = now;
            } catch (error) {
                console.error("Gagal mencatat data ke localStorage:", error);
            }
        }


        // --- Logic Grafik Wh (Diperbarui untuk Agregasi) --- 
        let selectedPeriod = '1h';

        function selectPeriod(period) {
            selectedPeriod = period;
            
            // Update tombol aktif
            document.querySelectorAll('.period-button').forEach(btn => {
                btn.classList.remove('period-active'); 
                // Hapus kelas dark mode override saat tidak aktif untuk mencegah styling ganda
                btn.classList.remove('bg-gray-800', 'text-gray-300', 'hover:bg-gray-600'); 
                btn.classList.remove('bg-white', 'text-gray-800', 'hover:bg-gray-200');
            });
            
            const activeBtn = document.getElementById(`period-${period}`);
            activeBtn.classList.add('period-active'); // Menambahkan kelas period-active

            // Panggil render ulang grafik
            fetchAndRenderGraphs(period);
        }

        /**
         * Mengagregasi data daya (Watt) dari log lokal menjadi Watt-hour (Wh) untuk bin waktu tertentu.
         * @param {Array<object>} logs - Array log dari localStorage.
         * @param {string} periodKey - Kunci periode ('1h', '6h', '24h', dll.).
         * @returns {object} Data agregasi { labels, chargeData, dischargeData, totalChargeWh, totalDischargeWh }
         */
        function aggregateEnergyData(logs, periodKey) {
            const config = PERIOD_CONFIG[periodKey];
            const numPoints = config.points;
            const durationMs = config.durationMs;
            const binDurationMs = durationMs / numPoints;
            const startTime = Date.now() - durationMs; 

            // Inisialisasi bin untuk charge (positif) dan discharge (negatif)
            const chargeBins = Array(numPoints).fill(0);
            const dischargeBins = Array(numPoints).fill(0);
            let totalChargeWh = 0;
            let totalDischargeWh = 0; 
            
            // Log interval (1 menit = 60 detik) = 60 / 3600 jam
            const timeIntervalHours = LOG_INTERVAL_MS / (1000 * 3600);

            // 1. Agregasi data log ke dalam bin yang sesuai
            logs.forEach(log => {
                // Hanya proses log dalam periode yang diminta
                if (log.timestamp >= startTime) {
                    // Hitung indeks bin. Math.floor memastikan indeks antara 0 hingga numPoints-1
                    let binIndex = Math.floor((log.timestamp - startTime) / binDurationMs);

                    // Batasi indeks agar tidak melebihi batas
                    if (binIndex >= numPoints) {
                        binIndex = numPoints - 1;
                    } else if (binIndex < 0) {
                        return; // Abaikan
                    }

                    const power = log.power_W;
                    // Wh dihitung dari Power (Watt) * Interval Waktu (Jam)
                    const wh = Math.abs(power) * timeIntervalHours;

                    if (power > 0.1) {
                        chargeBins[binIndex] += wh;
                        totalChargeWh += wh;
                    } else if (power < -0.1) { // Discharge
                        dischargeBins[binIndex] += wh;
                        totalDischargeWh += wh;
                    }
                }
            });

            // 2. Buat label yang bermakna
            const labels = [];
            for (let i = 0; i < numPoints; i++) {
                const binStartMs = startTime + (i * binDurationMs);
                const date = new Date(binStartMs);
                let label;

                if (durationMs <= PERIOD_CONFIG['24h'].durationMs) {
                    // Untuk jam dan sub-hari (1h, 6h, 12h, 24h)
                    // Durasi bin 1 jam atau lebih
                    if (binDurationMs >= 3600 * 1000) { 
                        // Tampilkan jam (misal 14:00)
                        label = `${date.getHours().toString().padStart(2, '0')}:00`;
                    } else {
                        // Tampilkan jam:menit
                        label = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                    }
                } else {
                    // Untuk hari (7d, 30d)
                    label = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                }
                labels.push(label);
            }

            // 3. Format dischargeData menjadi negatif agar tampak di bawah 0 pada grafik bar
            const formattedDischargeData = dischargeBins.map(wh => -wh);


            return { 
                labels, 
                chargeData: chargeBins.map(wh => wh.toFixed(3)), 
                dischargeData: formattedDischargeData.map(wh => wh.toFixed(3)),
                totalChargeWh: totalChargeWh.toFixed(3),
                totalDischargeWh: totalDischargeWh.toFixed(3),
            };
        }

        /**
         * Mengambil log, mengagregasi, dan merender grafik Wh.
         * @param {string} period - Periode waktu yang dipilih.
         */
        async function fetchAndRenderGraphs(period) {
            chartStatusElement.textContent = `Mengagregasi data Wh untuk ${PERIOD_CONFIG[period].label}...`;
            
            try {
                const allLogs = getLocalLogs();
                const config = PERIOD_CONFIG[period];
                const startTime = Date.now() - config.durationMs;
                
                // Filter log yang relevan
                const filteredLogs = allLogs.filter(log => log.timestamp >= startTime);
                
                const aggregatedData = aggregateEnergyData(filteredLogs, period);
                const numPoints = config.points;
                
                // Update total Wh di bawah grafik
                totalChargeWhElement.textContent = aggregatedData.totalChargeWh + ' Wh';
                totalDischargeWhElement.textContent = aggregatedData.totalDischargeWh + ' Wh';

                if (filteredLogs.length === 0) {
                    chartStatusElement.textContent = `Tidak ada log daya yang tercatat dalam ${config.label}.`;
                } else {
                    chartStatusElement.textContent = `Data ${filteredLogs.length} log, diagregasi menjadi ${numPoints} titik (${config.label}).`;
                }

                renderEnergyCharts(aggregatedData, config.label);

            } catch (error) {
                console.error("Gagal mengambil/memproses data grafik Wh dari localStorage:", error);
                chartStatusElement.textContent = `GAGAL memuat grafik: ${error.message}`;
            }
        }

        /**
         * Merender grafik batang Charge/Discharge menggunakan Chart.js.
         * @param {object} data - Data agregasi dari aggregateEnergyData.
         * @param {string} periodLabel - Label periode untuk judul chart.
         */
        function renderEnergyCharts(data, periodLabel) {
            const ctx = document.getElementById('whCombinedCanvas').getContext('2d');
            
            // Hancurkan instance chart yang lama jika ada
            if (whChart) {
                whChart.destroy();
            }

            const isDark = document.body.classList.contains('dark');
            const textColor = isDark ? '#f3f4f6' : '#1f2937'; 
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            whChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Charge (Energi Masuk)',
                            data: data.chargeData, // Nilai POSITIF
                            backgroundColor: 'rgba(16, 185, 129, 0.8)', // Hijau
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                        },
                        {
                            label: 'Discharge (Energi Keluar)',
                            data: data.dischargeData, // Nilai NEGATIF dari aggregateEnergyData
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Merah
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Penting untuk container h-96
                    plugins: {
                        legend: {
                            display: true, 
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = Math.abs(context.parsed.y).toFixed(3);
                                    return `${context.dataset.label}: ${value} Wh`;
                                },
                            }
                        },
                    },
                    scales: {
                        x: {
                            // Non-stacked di sumbu X (bar Charge dan Discharge berdampingan)
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: textColor
                            }
                        },
                        y: {
                            // Non-stacked di sumbu Y (karena menggunakan nilai positif/negatif)
                            title: {
                                display: true,
                                text: 'Energi (Wh) - Charge (+), Discharge (-)',
                                color: textColor
                            },
                            grid: {
                                borderDash: [5, 5],
                                color: gridColor
                            },
                            ticks: {
                                color: textColor,
                                // Tampilkan label sumbu Y (dengan tanda + atau - untuk menunjukkan arah)
                                callback: function(value) {
                                    if (value === 0) return '0.00';
                                    return value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            // Pastikan warna chart diperbarui jika tema diubah setelah rendering pertama
            updateChartColors(isDark);
        }

        // --- Logic Pindah Tema (Light/Dark Mode) --- 
        function updateChartColors(isDark) {
            // Gunakan instance chart tunggal
            if (!whChart) return; 

            // Tentukan warna teks dan grid berdasarkan mode
            const textColor = isDark ? '#f3f4f6' : '#1f2937'; 
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; 

            // Update warna untuk chart tunggal
            whChart.options.plugins.legend.labels.color = textColor;
            whChart.options.scales.x.ticks.color = textColor;
            whChart.options.scales.y.ticks.color = textColor;
            whChart.options.scales.y.title.color = textColor;
            whChart.options.scales.y.grid.color = gridColor;
            whChart.update();
        }

        function applyTheme(isDark) {
            const body = document.body;
            if (isDark) {
                body.classList.add('dark');
                // Mode Gelap AKTIF -> Tampilkan ikon Bulan (UNICODE)
                if (themeIcon) themeIcon.textContent = '🌙'; 
            } else {
                body.classList.remove('dark');
                // Mode Terang AKTIF -> Tampilkan ikon Matahari (UNICODE)
                if (themeIcon) themeIcon.textContent = '☀️';
            }
            // Simpan preferensi tema
            localStorage.setItem(THEME_KEY, isDark ? 'dark' : 'light');

            // Perbarui warna chart agar sesuai dengan tema baru
            updateChartColors(isDark);

            // Panggil selectPeriod untuk menerapkan styling tombol aktif yang benar di mode baru
            selectPeriod(selectedPeriod);

            // Perbarui UI Wakelock
            updateWakelockUI(wakeLockSentinel !== null);
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('dark');
            applyTheme(!isDark);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            // Default ke dark mode jika tidak ada preferensi tersimpan, 
            // atau gunakan preferensi sistem
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme === 'dark' || (savedTheme === null && prefersDark)) {
                applyTheme(true);
            } else {
                applyTheme(false);
            }
        }
        
        // --- FUNGSI WAKELOCK BARU ---

        /**
         * Meminta screen wakelock untuk mencegah layar mati saat dashboard aktif.
         */
        async function requestWakelock() {
            if ('wakeLock' in navigator) {
                try {
                    // Mencegah permintaan ganda
                    if (wakeLockSentinel) return; 

                    wakeLockSentinel = await navigator.wakeLock.request('screen');
                    wakeLockSentinel.addEventListener('release', () => {
                        console.log('Wake Lock dirilis secara otomatis.');
                        // Perbarui UI jika wakelock dirilis
                        updateWakelockUI(false); 
                        wakeLockSentinel = null; // Pastikan sentinel direset
                    });
                    console.log('Wake Lock aktif.');
                    updateWakelockUI(true);
                } catch (err) {
                    // Pengguna menolak permintaan atau ada error lainnya
                    console.error(`Gagal mengaktifkan Wake Lock: ${err.name}, ${err.message}`);
                    updateWakelockUI(false);
                }
            } else {
                 // Nonaktifkan tombol dan beri notifikasi jika tidak didukung
                 wakelockToggle.disabled = true;
                 wakelockToggle.textContent = 'Wakelock Tidak Didukung';
                 console.warn('Wake Lock API tidak didukung di browser ini.');
            }
        }

        /**
         * Melepaskan screen wakelock.
         */
        async function releaseWakelock() {
            if (wakeLockSentinel) {
                try {
                    await wakeLockSentinel.release();
                    wakeLockSentinel = null;
                    console.log('Wake Lock dirilis secara manual.');
                    updateWakelockUI(false);
                } catch (err) {
                    console.error(`Gagal melepaskan Wake Lock: ${err.message}`);
                }
            }
        }

        /**
         * Memperbarui tampilan tombol Wakelock.
         * @param {boolean} isActive - Status Wakelock (true jika aktif).
         */
        function updateWakelockUI(isActive) {
            if (!wakelockToggle) return;
            
            // Reset kelas yang berhubungan dengan warna
            wakelockToggle.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'bg-accent', 'hover:bg-emerald-600'); 
            
            if (isActive) {
                wakelockToggle.textContent = 'Wakelock AKTIF ✅';
                wakelockToggle.classList.add('bg-accent', 'hover:bg-emerald-600'); // Gunakan warna accent (hijau)
                wakelockToggle.title = 'Layar tidak akan mati secara otomatis. Klik untuk menonaktifkan.';
            } else {
                wakelockToggle.textContent = 'Aktifkan Wakelock';
                wakelockToggle.classList.add('bg-gray-500', 'hover:bg-gray-600');
                wakelockToggle.title = 'Kunci layar agar tidak mati saat memantau.';
            }
        }
        
        /**
         * Fungsi toggle yang dipanggil oleh tombol.
         */
        function toggleWakelock() {
            if (wakeLockSentinel) {
                releaseWakelock();
            } else {
                requestWakelock();
            }
        }

        // Listener untuk menangani visibilitas halaman
        document.addEventListener('visibilitychange', async () => {
          if (wakeLockSentinel !== null && document.visibilityState === 'visible') {
            // Coba untuk meminta ulang wakelock jika halaman menjadi terlihat
            // (karena wakelock sering dirilis saat halaman tidak terlihat)
            console.log('Halaman kembali terlihat. Mencoba mengaktifkan kembali Wake Lock...');
            await requestWakelock();
          }
        });

        // --- END FUNGSI WAKELOCK BARU ---


        document.addEventListener('DOMContentLoaded', async () => {
            // Muat tema sebelum memuat data
            loadTheme(); 
            
            const initialValues = Array(17).fill(0.0);
            updateDashboard(initialValues);
            
            // Pengecekan awal untuk dukungan Wakelock
            if (!('wakeLock' in navigator)) {
                 if (wakelockToggle) {
                     wakelockToggle.disabled = true;
                     wakelockToggle.textContent = 'Wakelock Tidak Didukung';
                 }
            }
            
            // Muat grafik awal dari localStorage
            await fetchAndRenderGraphs(selectedPeriod);
        });
    </script>
</body>
</html>
